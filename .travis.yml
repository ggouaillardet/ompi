# Use "required" for sudo, because we want to use the "trusty" Debian
# distro, which is (currently) only available in the legacy Travis
# infrastructure (i.e., if we put "sudo: false" to use the new container-
# based Travis infrastructure, then "trusty" is not available).  We
# need the "trusty" distro because it has more recent versions of the
# GNU Autotools (i.e., autogen.pl will fail if you use the regular
# distro because the GNU Autotools are too old).
sudo: required
dist: trusty
language: c

# Iterate over 2 different compilers
compiler:
    - gcc

# Test only linux now
os:
    - linux

addons:
    # For Linux, make sure we have some extra packages that we like to
    # build with
    apt:
        packages:
            - autoconf
            - automake
            - libtool
            - libnl-3-200
            - libnl-3-dev
            - libnl-route-3-200
            - libnl-route-3-dev
            - libibverbs-dev
            - librdmacm-dev
            - libhwloc-dev
            - libevent-dev
        sources:
            - ubuntu-toolchain-r-test

env:
    global:
        - AM_MAKEFLAGS="-j4"
    matrix:
        - PMIX_BRANCH=v2.0
        - PMIX_BRANCH=v2.1
        - PMIX_BRANCH=v2.2
        - PMIX_BRANCH=v3.0
        - PMIX_BRANCH=v3.1
        - PMIX_RELEASE=3.1.2
        - PMIX_BRANCH=master

before_install:
    - if test -n "${PMIX_BRANCH}" ; then git clone -b ${PMIX_BRANCH} --depth=10 https://github.com/pmix/pmix.git ../pmix-${PMIX_BRANCH} && cd ../pmix-${PMIX_BRANCH} && ./autogen.pl; fi
    - if test -n "${PMIX_RELEASE}" ; then cd .. && wget https://github.com/pmix/pmix/releases/download/v${PMIX_RELEASE}/pmix-${PMIX_RELEASE}.tar.bz2 && tar xvfj pmix-${PMIX_RELEASE}.tar.bz2 && cd pmix-${PMIX_RELEASE}; fi
    - ./configure --prefix=$HOME/bogus/pmix && make -j 2 install && cd ../ompi
    - export LD_LIBRARY_PATH=$HOME/bogus/pmix/lib:$LD_LIBRARY_PATH

install:
    - m4 --version
    - autoconf --version
    - automake --version
    - libtool --version
    - ./autogen.pl
    - ./configure --with-pmix=$HOME/bogus/pmix --prefix=$HOME/bogus/ompi
    - make -j 2
    - make -j 2 install

script:
    - make check
    - git clone --depth=10 https://github.com/pmix/prrte.git ../prrte
    - cd ../prrte && ./autogen.pl && ./configure --with-pmix=$HOME/bogus/pmix --prefix=$HOME/bogus/prrte && make -j 2 install && cd ../ompi
    - export PATH=$HOME/bogus/prrte/bin:$HOME/bogus/ompi/bin:$PATH
    - cd examples && make 
    - prte --daemonize
    - prun -n 1 ./hello_c
    - prun -n 1 ./ring_c
    - prun --oversubscribe -n 2 ./hello_c
    - prun --oversubscribe -n 2 ./ring_c

branches:
  only:
    - poc/noorte
