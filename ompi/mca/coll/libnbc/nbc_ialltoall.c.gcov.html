<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - master-ibm - ompi/mca/coll/libnbc/nbc_ialltoall.c</title>
  <link rel="stylesheet" type="text/css" href="../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../index.html">top level</a> - <a href="index.html">ompi/mca/coll/libnbc</a> - nbc_ialltoall.c<span style="font-size: 80%;"> (source / <a href="nbc_ialltoall.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">master-ibm</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">84</td>
            <td class="headerCovTableEntry">159</td>
            <td class="headerCovTableEntryLo">52.8 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2015-07-30 15:43:04</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">3</td>
            <td class="headerCovTableEntry">5</td>
            <td class="headerCovTableEntryLo">60.0 %</td>
          </tr>
          <tr><td><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  * Copyright (c) 2006      The Trustees of Indiana University and Indiana
<span class="lineNum">       3 </span>            :  *                         University Research and Technology
<span class="lineNum">       4 </span>            :  *                         Corporation.  All rights reserved.
<span class="lineNum">       5 </span>            :  * Copyright (c) 2006      The Technical University of Chemnitz. All
<span class="lineNum">       6 </span>            :  *                         rights reserved.
<span class="lineNum">       7 </span>            :  * Copyright (c) 2013      Los Alamos National Security, LLC. All rights
<span class="lineNum">       8 </span>            :  *                         reserved.
<span class="lineNum">       9 </span>            :  * Copyright (c) 2014      NVIDIA Corporation.  All rights reserved.
<span class="lineNum">      10 </span>            :  * Copyright (c) 2014      Research Organization for Information Science
<span class="lineNum">      11 </span>            :  *                         and Technology (RIST). All rights reserved.
<span class="lineNum">      12 </span>            :  *
<span class="lineNum">      13 </span>            :  * Author(s): Torsten Hoefler &lt;htor@cs.indiana.edu&gt;
<span class="lineNum">      14 </span>            :  *
<span class="lineNum">      15 </span>            :  */
<span class="lineNum">      16 </span>            : #include &quot;nbc_internal.h&quot;
<span class="lineNum">      17 </span>            : 
<span class="lineNum">      18 </span>            : static inline int a2a_sched_linear(int rank, int p, MPI_Aint sndext, MPI_Aint rcvext, NBC_Schedule *schedule, void* sendbuf, int sendcount, MPI_Datatype sendtype, void* recvbuf, int recvcount, MPI_Datatype recvtype, MPI_Comm comm);
<span class="lineNum">      19 </span>            : static inline int a2a_sched_pairwise(int rank, int p, MPI_Aint sndext, MPI_Aint rcvext, NBC_Schedule *schedule, void* sendbuf, int sendcount, MPI_Datatype sendtype, void* recvbuf, int recvcount, MPI_Datatype recvtype, MPI_Comm comm);
<span class="lineNum">      20 </span>            : static inline int a2a_sched_diss(int rank, int p, MPI_Aint sndext, MPI_Aint rcvext, NBC_Schedule* schedule, void* sendbuf, int sendcount, MPI_Datatype sendtype, void* recvbuf, int recvcount, MPI_Datatype recvtype, MPI_Comm comm, NBC_Handle *handle);
<span class="lineNum">      21 </span>            : 
<span class="lineNum">      22 </span>            : #ifdef NBC_CACHE_SCHEDULE
<span class="lineNum">      23 </span>            : /* tree comparison function for schedule cache */
<span class="lineNum">      24 </span>            : int NBC_Alltoall_args_compare(NBC_Alltoall_args *a, NBC_Alltoall_args *b, void *param) {
<span class="lineNum">      25 </span>            : 
<span class="lineNum">      26 </span>            :         if( (a-&gt;sendbuf == b-&gt;sendbuf) &amp;&amp;
<span class="lineNum">      27 </span>            :       (a-&gt;sendcount == b-&gt;sendcount) &amp;&amp;
<span class="lineNum">      28 </span>            :       (a-&gt;sendtype == b-&gt;sendtype) &amp;&amp;
<span class="lineNum">      29 </span>            :       (a-&gt;recvbuf == b-&gt;recvbuf) &amp;&amp;
<span class="lineNum">      30 </span>            :       (a-&gt;recvcount == b-&gt;recvcount) &amp;&amp;
<span class="lineNum">      31 </span>            :       (a-&gt;recvtype == b-&gt;recvtype) ) {
<span class="lineNum">      32 </span>            :     return  0;
<span class="lineNum">      33 </span>            :   }
<span class="lineNum">      34 </span>            :         if( a-&gt;sendbuf &lt; b-&gt;sendbuf ) {
<span class="lineNum">      35 </span>            :     return -1;
<span class="lineNum">      36 </span>            :         }
<span class="lineNum">      37 </span>            :         return +1;
<span class="lineNum">      38 </span>            : }
<span class="lineNum">      39 </span>            : #endif
<a name="40"><span class="lineNum">      40 </span>            : </a>
<span class="lineNum">      41 </span>            : /* simple linear MPI_Ialltoall the (simple) algorithm just sends to all nodes */
<span class="lineNum">      42 </span><span class="lineCov">         20 : int ompi_coll_libnbc_ialltoall(void* sendbuf, int sendcount, MPI_Datatype sendtype, void* recvbuf, int recvcount,</span>
<span class="lineNum">      43 </span>            :                                MPI_Datatype recvtype, struct ompi_communicator_t *comm, ompi_request_t ** request,
<span class="lineNum">      44 </span>            :                                struct mca_coll_base_module_2_1_0_t *module)
<span class="lineNum">      45 </span>            : {
<span class="lineNum">      46 </span>            :   int rank, p, res, a2asize, sndsize, datasize;
<span class="lineNum">      47 </span>            :   NBC_Schedule *schedule;
<span class="lineNum">      48 </span>            :   MPI_Aint rcvext, sndext;
<span class="lineNum">      49 </span>            : #ifdef NBC_CACHE_SCHEDULE
<span class="lineNum">      50 </span>            :   NBC_Alltoall_args *args, *found, search;
<span class="lineNum">      51 </span>            : #endif
<span class="lineNum">      52 </span>            :   char *rbuf, *sbuf, inplace;
<span class="lineNum">      53 </span>            :   enum {NBC_A2A_LINEAR, NBC_A2A_PAIRWISE, NBC_A2A_DISS} alg;
<span class="lineNum">      54 </span>            :   NBC_Handle *handle;
<span class="lineNum">      55 </span><span class="lineCov">         20 :   ompi_coll_libnbc_request_t **coll_req = (ompi_coll_libnbc_request_t**) request;</span>
<span class="lineNum">      56 </span><span class="lineCov">         20 :   ompi_coll_libnbc_module_t *libnbc_module = (ompi_coll_libnbc_module_t*) module;</span>
<span class="lineNum">      57 </span>            : 
<span class="lineNum">      58 </span><span class="lineCov">         20 :   NBC_IN_PLACE(sendbuf, recvbuf, inplace);</span>
<span class="lineNum">      59 </span>            : 
<span class="lineNum">      60 </span><span class="lineCov">         20 :   res = NBC_Init_handle(comm, coll_req, libnbc_module);</span>
<span class="lineNum">      61 </span><span class="lineCov">         20 :   if(res != NBC_OK) { printf(&quot;Error in NBC_Init_handle(%i)\n&quot;, res); return res; }</span>
<span class="lineNum">      62 </span><span class="lineCov">         20 :   handle = (*coll_req);</span>
<span class="lineNum">      63 </span><span class="lineCov">         20 :   res = MPI_Comm_rank(comm, &amp;rank);</span>
<span class="lineNum">      64 </span><span class="lineCov">         20 :   if (MPI_SUCCESS != res) { printf(&quot;MPI Error in MPI_Comm_rank() (%i)\n&quot;, res); return res; }</span>
<span class="lineNum">      65 </span><span class="lineCov">         20 :   res = MPI_Comm_size(comm, &amp;p);</span>
<span class="lineNum">      66 </span><span class="lineCov">         20 :   if (MPI_SUCCESS != res) { printf(&quot;MPI Error in MPI_Comm_size() (%i)\n&quot;, res); return res; }</span>
<span class="lineNum">      67 </span><span class="lineCov">         20 :   res = MPI_Type_extent(sendtype, &amp;sndext);</span>
<span class="lineNum">      68 </span><span class="lineCov">         20 :   if (MPI_SUCCESS != res) { printf(&quot;MPI Error in MPI_Type_extent() (%i)\n&quot;, res); return res; }</span>
<span class="lineNum">      69 </span><span class="lineCov">         20 :   res = MPI_Type_extent(recvtype, &amp;rcvext);</span>
<span class="lineNum">      70 </span><span class="lineCov">         20 :   if (MPI_SUCCESS != res) { printf(&quot;MPI Error in MPI_Type_extent() (%i)\n&quot;, res); return res; }</span>
<span class="lineNum">      71 </span><span class="lineCov">         20 :   res = MPI_Type_size(sendtype, &amp;sndsize);</span>
<span class="lineNum">      72 </span><span class="lineCov">         20 :   if (MPI_SUCCESS != res) { printf(&quot;MPI Error in MPI_Type_size() (%i)\n&quot;, res); return res; }</span>
<span class="lineNum">      73 </span>            : 
<span class="lineNum">      74 </span>            :   /* algorithm selection */
<span class="lineNum">      75 </span><span class="lineCov">         20 :   a2asize = sndsize*sendcount*p;</span>
<span class="lineNum">      76 </span>            :   /* this number is optimized for TCP on odin.cs.indiana.edu */
<span class="lineNum">      77 </span><span class="lineCov">         20 :   if((p &lt;= 8) &amp;&amp; ((a2asize &lt; 1&lt;&lt;17) || (sndsize*sendcount &lt; 1&lt;&lt;12))) {</span>
<span class="lineNum">      78 </span>            :     /* just send as fast as we can if we have less than 8 peers, if the
<span class="lineNum">      79 </span>            :      * total communicated size is smaller than 1&lt;&lt;17 *and* if we don't
<span class="lineNum">      80 </span>            :      * have eager messages (msgsize &lt; 1&lt;&lt;13) */
<span class="lineNum">      81 </span><span class="lineCov">         16 :     alg = NBC_A2A_LINEAR;</span>
<span class="lineNum">      82 </span><span class="lineCov">          4 :   } else if(a2asize &lt; (1&lt;&lt;12)*p) {</span>
<span class="lineNum">      83 </span>            :     /*alg = NBC_A2A_DISS;*/
<span class="lineNum">      84 </span><span class="lineNoCov">          0 :     alg = NBC_A2A_LINEAR;</span>
<span class="lineNum">      85 </span>            :   } else
<span class="lineNum">      86 </span><span class="lineCov">          4 :     alg = NBC_A2A_LINEAR; /*NBC_A2A_PAIRWISE;*/</span>
<span class="lineNum">      87 </span>            : 
<span class="lineNum">      88 </span><span class="lineCov">         20 :   if(!inplace) {</span>
<span class="lineNum">      89 </span>            :     /* copy my data to receive buffer */
<span class="lineNum">      90 </span><span class="lineCov">         20 :     rbuf = ((char *)recvbuf) + (rank*recvcount*rcvext);</span>
<span class="lineNum">      91 </span><span class="lineCov">         20 :     sbuf = ((char *)sendbuf) + (rank*sendcount*sndext);</span>
<span class="lineNum">      92 </span><span class="lineCov">         20 :     res = NBC_Copy(sbuf, sendcount, sendtype, rbuf, recvcount, recvtype, comm);</span>
<span class="lineNum">      93 </span><span class="lineCov">         20 :     if (NBC_OK != res) { printf(&quot;Error in NBC_Copy() (%i)\n&quot;, res); return res; }</span>
<span class="lineNum">      94 </span>            :   }
<span class="lineNum">      95 </span>            : 
<span class="lineNum">      96 </span>            :   /* allocate temp buffer if we need one */
<span class="lineNum">      97 </span><span class="lineCov">         20 :   if(alg == NBC_A2A_DISS) {</span>
<span class="lineNum">      98 </span>            :     /* only A2A_DISS needs buffers */
<span class="lineNum">      99 </span><span class="lineNoCov">          0 :     if(NBC_Type_intrinsic(sendtype)) {</span>
<span class="lineNum">     100 </span><span class="lineNoCov">          0 :       datasize = sndext*sendcount;</span>
<span class="lineNum">     101 </span>            :     } else {
<span class="lineNum">     102 </span><span class="lineNoCov">          0 :       res = MPI_Pack_size(sendcount, sendtype, comm, &amp;datasize);</span>
<span class="lineNum">     103 </span><span class="lineNoCov">          0 :       if (MPI_SUCCESS != res) { printf(&quot;MPI Error in MPI_Pack_size() (%i)\n&quot;, res); return res; }</span>
<span class="lineNum">     104 </span>            :     }
<span class="lineNum">     105 </span>            :     /* allocate temporary buffers */
<span class="lineNum">     106 </span><span class="lineNoCov">          0 :     if(p % 2 == 0) {</span>
<span class="lineNum">     107 </span><span class="lineNoCov">          0 :       handle-&gt;tmpbuf=malloc(datasize*p*2);</span>
<span class="lineNum">     108 </span>            :     } else {
<span class="lineNum">     109 </span>            :       /* we cannot divide p by two, so alloc more to be safe ... */
<span class="lineNum">     110 </span><span class="lineNoCov">          0 :       handle-&gt;tmpbuf=malloc(datasize*(p/2+1)*2*2);</span>
<span class="lineNum">     111 </span>            :     }
<span class="lineNum">     112 </span>            : 
<span class="lineNum">     113 </span>            :     /* phase 1 - rotate n data blocks upwards into the tmpbuffer */
<span class="lineNum">     114 </span>            : #if OPAL_CUDA_SUPPORT
<span class="lineNum">     115 </span>            :     if(NBC_Type_intrinsic(sendtype) &amp;&amp; !(opal_cuda_check_bufs((char *)sendbuf, (char *)recvbuf))) {
<span class="lineNum">     116 </span>            : #else
<span class="lineNum">     117 </span><span class="lineNoCov">          0 :     if(NBC_Type_intrinsic(sendtype)) {</span>
<span class="lineNum">     118 </span>            : #endif /* OPAL_CUDA_SUPPORT */
<span class="lineNum">     119 </span>            :       /* contiguous - just copy (1st copy) */
<span class="lineNum">     120 </span><span class="lineNoCov">          0 :       memcpy(handle-&gt;tmpbuf, (char*)sendbuf+datasize*rank, datasize*(p-rank));</span>
<span class="lineNum">     121 </span><span class="lineNoCov">          0 :       if(rank != 0) memcpy((char*)handle-&gt;tmpbuf+datasize*(p-rank), sendbuf, datasize*(rank));</span>
<span class="lineNum">     122 </span>            :     } else {
<span class="lineNum">     123 </span><span class="lineNoCov">          0 :       int pos=0;</span>
<span class="lineNum">     124 </span>            : 
<span class="lineNum">     125 </span>            :       /* non-contiguous - pack */
<span class="lineNum">     126 </span><span class="lineNoCov">          0 :       res = MPI_Pack((char*)sendbuf+rank*sendcount*sndext, (p-rank)*sendcount, sendtype, handle-&gt;tmpbuf, (p-rank)*datasize, &amp;pos, comm);</span>
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :       if (MPI_SUCCESS != res) { printf(&quot;MPI Error in MPI_Pack() (%i)\n&quot;, res); return res; }</span>
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :       if(rank != 0) {</span>
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :         pos = 0;</span>
<span class="lineNum">     130 </span><span class="lineNoCov">          0 :         MPI_Pack(sendbuf, rank*sendcount, sendtype, (char*)handle-&gt;tmpbuf+datasize*(p-rank), rank*datasize, &amp;pos, comm);</span>
<span class="lineNum">     131 </span><span class="lineNoCov">          0 :         if (MPI_SUCCESS != res) { printf(&quot;MPI Error in MPI_Pack() (%i)\n&quot;, res); return res; }</span>
<span class="lineNum">     132 </span>            :       }
<span class="lineNum">     133 </span>            :     }
<span class="lineNum">     134 </span>            :   } else {
<span class="lineNum">     135 </span><span class="lineCov">         20 :     handle-&gt;tmpbuf=NULL;</span>
<span class="lineNum">     136 </span>            :   }
<span class="lineNum">     137 </span>            : 
<span class="lineNum">     138 </span>            : #ifdef NBC_CACHE_SCHEDULE
<span class="lineNum">     139 </span>            :   /* search schedule in communicator specific tree */
<span class="lineNum">     140 </span>            :   search.sendbuf=sendbuf;
<span class="lineNum">     141 </span>            :   search.sendcount=sendcount;
<span class="lineNum">     142 </span>            :   search.sendtype=sendtype;
<span class="lineNum">     143 </span>            :   search.recvbuf=recvbuf;
<span class="lineNum">     144 </span>            :   search.recvcount=recvcount;
<span class="lineNum">     145 </span>            :   search.recvtype=recvtype;
<span class="lineNum">     146 </span>            :   found = (NBC_Alltoall_args*)hb_tree_search((hb_tree*)handle-&gt;comminfo-&gt;NBC_Dict[NBC_ALLTOALL], &amp;search);
<span class="lineNum">     147 </span>            :   if(found == NULL) {
<span class="lineNum">     148 </span>            : #endif
<span class="lineNum">     149 </span>            :     /* not found - generate new schedule */
<span class="lineNum">     150 </span><span class="lineCov">         20 :     schedule = (NBC_Schedule*)malloc(sizeof(NBC_Schedule));</span>
<span class="lineNum">     151 </span><span class="lineCov">         20 :     if (NULL == schedule) { printf(&quot;Error in malloc()\n&quot;); return res; }</span>
<span class="lineNum">     152 </span>            : 
<span class="lineNum">     153 </span><span class="lineCov">         20 :     res = NBC_Sched_create(schedule);</span>
<span class="lineNum">     154 </span><span class="lineCov">         20 :     if(res != NBC_OK) { printf(&quot;Error in NBC_Sched_create (%i)\n&quot;, res); return res; }</span>
<span class="lineNum">     155 </span>            : 
<span class="lineNum">     156 </span><span class="lineCov">         20 :     switch(alg) {</span>
<span class="lineNum">     157 </span>            :       case NBC_A2A_LINEAR:
<span class="lineNum">     158 </span><span class="lineCov">         20 :         res = a2a_sched_linear(rank, p, sndext, rcvext, schedule, sendbuf, sendcount, sendtype, recvbuf, recvcount, recvtype, comm);</span>
<span class="lineNum">     159 </span><span class="lineCov">         20 :         break;</span>
<span class="lineNum">     160 </span>            :       case NBC_A2A_DISS:
<span class="lineNum">     161 </span><span class="lineNoCov">          0 :         res = a2a_sched_diss(rank, p, sndext, rcvext, schedule, sendbuf, sendcount, sendtype, recvbuf, recvcount, recvtype, comm, handle);</span>
<span class="lineNum">     162 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     163 </span>            :       case NBC_A2A_PAIRWISE:
<span class="lineNum">     164 </span><span class="lineNoCov">          0 :         res = a2a_sched_pairwise(rank, p, sndext, rcvext, schedule, sendbuf, sendcount, sendtype, recvbuf, recvcount, recvtype, comm);</span>
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     166 </span>            :     }
<span class="lineNum">     167 </span>            : 
<span class="lineNum">     168 </span><span class="lineCov">         20 :     if (NBC_OK != res) { return res; }</span>
<span class="lineNum">     169 </span>            : 
<span class="lineNum">     170 </span><span class="lineCov">         20 :     res = NBC_Sched_commit(schedule);</span>
<span class="lineNum">     171 </span><span class="lineCov">         20 :     if (NBC_OK != res) { printf(&quot;Error in NBC_Sched_commit() (%i)\n&quot;, res); return res; }</span>
<span class="lineNum">     172 </span>            : 
<span class="lineNum">     173 </span>            : #ifdef NBC_CACHE_SCHEDULE
<span class="lineNum">     174 </span>            :     /* save schedule to tree */
<span class="lineNum">     175 </span>            :     args = (NBC_Alltoall_args*)malloc(sizeof(NBC_Alltoall_args));
<span class="lineNum">     176 </span>            :     args-&gt;sendbuf=sendbuf;
<span class="lineNum">     177 </span>            :     args-&gt;sendcount=sendcount;
<span class="lineNum">     178 </span>            :     args-&gt;sendtype=sendtype;
<span class="lineNum">     179 </span>            :     args-&gt;recvbuf=recvbuf;
<span class="lineNum">     180 </span>            :     args-&gt;recvcount=recvcount;
<span class="lineNum">     181 </span>            :     args-&gt;recvtype=recvtype;
<span class="lineNum">     182 </span>            :     args-&gt;schedule=schedule;
<span class="lineNum">     183 </span>            :           res = hb_tree_insert ((hb_tree*)handle-&gt;comminfo-&gt;NBC_Dict[NBC_ALLTOALL], args, args, 0);
<span class="lineNum">     184 </span>            :     if(res != 0) printf(&quot;error in dict_insert() (%i)\n&quot;, res);
<span class="lineNum">     185 </span>            :     /* increase number of elements for A2A */
<span class="lineNum">     186 </span>            :     if(++handle-&gt;comminfo-&gt;NBC_Dict_size[NBC_ALLTOALL] &gt; NBC_SCHED_DICT_UPPER) {
<span class="lineNum">     187 </span>            :       NBC_SchedCache_dictwipe((hb_tree*)handle-&gt;comminfo-&gt;NBC_Dict[NBC_ALLTOALL], &amp;handle-&gt;comminfo-&gt;NBC_Dict_size[NBC_ALLTOALL]);
<span class="lineNum">     188 </span>            :       /*if(!rank) printf(&quot;[%i] removing %i elements - new size: %i \n&quot;, rank, SCHED_DICT_UPPER-SCHED_DICT_LOWER, handle-&gt;comminfo-&gt;NBC_Alltoall_size);*/
<span class="lineNum">     189 </span>            :     }
<span class="lineNum">     190 </span>            :     /*if(!rank) printf(&quot;[%i] added new schedule to tree - number %i\n&quot;, rank, handle-&gt;comminfo-&gt;NBC_Dict_size[NBC_ALLTOALL]);*/
<span class="lineNum">     191 </span>            :   } else {
<span class="lineNum">     192 </span>            :     /* found schedule */
<span class="lineNum">     193 </span>            :     schedule=found-&gt;schedule;
<span class="lineNum">     194 </span>            :   }
<span class="lineNum">     195 </span>            : #endif
<span class="lineNum">     196 </span>            : 
<span class="lineNum">     197 </span><span class="lineCov">         20 :   res = NBC_Start(handle, schedule);</span>
<span class="lineNum">     198 </span><span class="lineCov">         20 :   if (NBC_OK != res) { printf(&quot;Error in NBC_Start() (%i)\n&quot;, res); return res; }</span>
<span class="lineNum">     199 </span>            : 
<span class="lineNum">     200 </span><span class="lineCov">         20 :   return NBC_OK;</span>
<a name="201"><span class="lineNum">     201 </span>            : }</a>
<span class="lineNum">     202 </span>            : 
<span class="lineNum">     203 </span><span class="lineCov">          4 : int ompi_coll_libnbc_ialltoall_inter (void* sendbuf, int sendcount, MPI_Datatype sendtype, void* recvbuf, int recvcount,</span>
<span class="lineNum">     204 </span>            :                                       MPI_Datatype recvtype, struct ompi_communicator_t *comm, ompi_request_t ** request,
<span class="lineNum">     205 </span>            :                                       struct mca_coll_base_module_2_1_0_t *module)
<span class="lineNum">     206 </span>            : {
<span class="lineNum">     207 </span>            :   int rank, res, i, rsize;
<span class="lineNum">     208 </span>            :   MPI_Aint sndext, rcvext;
<span class="lineNum">     209 </span>            :   NBC_Schedule *schedule;
<span class="lineNum">     210 </span>            :   char *rbuf, *sbuf;
<span class="lineNum">     211 </span>            :   NBC_Handle *handle;
<span class="lineNum">     212 </span><span class="lineCov">          4 :   ompi_coll_libnbc_request_t **coll_req = (ompi_coll_libnbc_request_t**) request;</span>
<span class="lineNum">     213 </span><span class="lineCov">          4 :   ompi_coll_libnbc_module_t *libnbc_module = (ompi_coll_libnbc_module_t*) module;</span>
<span class="lineNum">     214 </span>            : 
<span class="lineNum">     215 </span><span class="lineCov">          4 :   res = NBC_Init_handle(comm, coll_req, libnbc_module);</span>
<span class="lineNum">     216 </span><span class="lineCov">          4 :   if(res != NBC_OK) { printf(&quot;Error in NBC_Init_handle(%i)\n&quot;, res); return res; }</span>
<span class="lineNum">     217 </span><span class="lineCov">          4 :   handle = (*coll_req);</span>
<span class="lineNum">     218 </span>            : 
<span class="lineNum">     219 </span><span class="lineCov">          4 :   res = MPI_Comm_remote_size (comm, &amp;rsize);</span>
<span class="lineNum">     220 </span><span class="lineCov">          4 :   if (MPI_SUCCESS != res) { printf(&quot;MPI Error in MPI_Comm_remote_size() (%i)\n&quot;, res); return res; }</span>
<span class="lineNum">     221 </span><span class="lineCov">          4 :   res = MPI_Comm_rank(comm, &amp;rank);</span>
<span class="lineNum">     222 </span><span class="lineCov">          4 :   if (MPI_SUCCESS != res) { printf(&quot;MPI Error in MPI_Comm_rank() (%i)\n&quot;, res); return res; }</span>
<span class="lineNum">     223 </span><span class="lineCov">          4 :   res = MPI_Type_extent(sendtype, &amp;sndext);</span>
<span class="lineNum">     224 </span><span class="lineCov">          4 :   if (MPI_SUCCESS != res) { printf(&quot;MPI Error in MPI_Type_extent() (%i)\n&quot;, res); return res; }</span>
<span class="lineNum">     225 </span><span class="lineCov">          4 :   res = MPI_Type_extent(recvtype, &amp;rcvext);</span>
<span class="lineNum">     226 </span><span class="lineCov">          4 :   if (MPI_SUCCESS != res) { printf(&quot;MPI Error in MPI_Type_extent() (%i)\n&quot;, res); return res; }</span>
<span class="lineNum">     227 </span>            : 
<span class="lineNum">     228 </span><span class="lineCov">          4 :   schedule = (NBC_Schedule*)malloc(sizeof(NBC_Schedule));</span>
<span class="lineNum">     229 </span><span class="lineCov">          4 :   if (NULL == schedule) { printf(&quot;Error in malloc() (%i)\n&quot;, res); return res; }</span>
<span class="lineNum">     230 </span>            : 
<span class="lineNum">     231 </span><span class="lineCov">          4 :   handle-&gt;tmpbuf=NULL;</span>
<span class="lineNum">     232 </span>            : 
<span class="lineNum">     233 </span><span class="lineCov">          4 :   res = NBC_Sched_create(schedule);</span>
<span class="lineNum">     234 </span><span class="lineCov">          4 :   if(res != NBC_OK) { printf(&quot;Error in NBC_Sched_create (%i)\n&quot;, res); return res; }</span>
<span class="lineNum">     235 </span>            : 
<span class="lineNum">     236 </span><span class="lineCov">         12 :   for (i = 0; i &lt; rsize; i++) {</span>
<span class="lineNum">     237 </span>            :     /* post all sends */
<span class="lineNum">     238 </span><span class="lineCov">          8 :     sbuf = ((char *) sendbuf) + (i * sendcount * sndext);</span>
<span class="lineNum">     239 </span><span class="lineCov">          8 :     res = NBC_Sched_send(sbuf, false, sendcount, sendtype, i, schedule);</span>
<span class="lineNum">     240 </span><span class="lineCov">          8 :     if (NBC_OK != res) { printf(&quot;Error in NBC_Sched_send() (%i)\n&quot;, res); return res; }</span>
<span class="lineNum">     241 </span>            :     /* post all receives */
<span class="lineNum">     242 </span><span class="lineCov">          8 :     rbuf = ((char *) recvbuf) + (i * recvcount * rcvext);</span>
<span class="lineNum">     243 </span><span class="lineCov">          8 :     res = NBC_Sched_recv(rbuf, false, recvcount, recvtype, i, schedule);</span>
<span class="lineNum">     244 </span><span class="lineCov">          8 :     if (NBC_OK != res) { printf(&quot;Error in NBC_Sched_recv() (%i)\n&quot;, res); return res; }</span>
<span class="lineNum">     245 </span>            :   }
<span class="lineNum">     246 </span>            : 
<span class="lineNum">     247 </span>            :   /*NBC_PRINT_SCHED(*schedule);*/
<span class="lineNum">     248 </span>            : 
<span class="lineNum">     249 </span><span class="lineCov">          4 :   res = NBC_Sched_commit(schedule);</span>
<span class="lineNum">     250 </span><span class="lineCov">          4 :   if (NBC_OK != res) { printf(&quot;Error in NBC_Sched_commit() (%i)\n&quot;, res); return res; }</span>
<span class="lineNum">     251 </span>            : 
<span class="lineNum">     252 </span><span class="lineCov">          4 :   res = NBC_Start(handle, schedule);</span>
<span class="lineNum">     253 </span><span class="lineCov">          4 :   if (NBC_OK != res) { printf(&quot;Error in NBC_Start() (%i)\n&quot;, res); return res; }</span>
<span class="lineNum">     254 </span>            : 
<span class="lineNum">     255 </span><span class="lineCov">          4 :   return NBC_OK;</span>
<a name="256"><span class="lineNum">     256 </span>            : }</a>
<span class="lineNum">     257 </span>            : 
<span class="lineNum">     258 </span><span class="lineNoCov">          0 : static inline int a2a_sched_pairwise(int rank, int p, MPI_Aint sndext, MPI_Aint rcvext, NBC_Schedule* schedule, void* sendbuf, int sendcount, MPI_Datatype sendtype, void* recvbuf, int recvcount, MPI_Datatype recvtype, MPI_Comm comm) {</span>
<span class="lineNum">     259 </span>            :   int res, r, sndpeer, rcvpeer;
<span class="lineNum">     260 </span>            :   char *rbuf, *sbuf;
<span class="lineNum">     261 </span>            : 
<span class="lineNum">     262 </span><span class="lineNoCov">          0 :   res = NBC_OK;</span>
<span class="lineNum">     263 </span><span class="lineNoCov">          0 :   if(p &lt; 2) return res;</span>
<span class="lineNum">     264 </span>            : 
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :   for(r=1;r&lt;p;r++) {</span>
<span class="lineNum">     266 </span>            : 
<span class="lineNum">     267 </span><span class="lineNoCov">          0 :     sndpeer = (rank+r)%p;</span>
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :     rcvpeer = (rank-r+p)%p;</span>
<span class="lineNum">     269 </span>            : 
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :     rbuf = ((char *) recvbuf) + (rcvpeer*recvcount*rcvext);</span>
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :     res = NBC_Sched_recv(rbuf, false, recvcount, recvtype, rcvpeer, schedule);</span>
<span class="lineNum">     272 </span><span class="lineNoCov">          0 :     if (NBC_OK != res) { printf(&quot;Error in NBC_Sched_recv() (%i)\n&quot;, res); return res; }</span>
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :     sbuf = ((char *) sendbuf) + (sndpeer*sendcount*sndext);</span>
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :     res = NBC_Sched_send(sbuf, false, sendcount, sendtype, sndpeer, schedule);</span>
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :     if (NBC_OK != res) { printf(&quot;Error in NBC_Sched_send() (%i)\n&quot;, res); return res; }</span>
<span class="lineNum">     276 </span>            : 
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :     if (r &lt; p) {</span>
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :       res = NBC_Sched_barrier(schedule);</span>
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :       if (NBC_OK != res) { printf(&quot;Error in NBC_Sched_barr() (%i)\n&quot;, res); return res; }</span>
<span class="lineNum">     280 </span>            :     }
<span class="lineNum">     281 </span>            :   }
<span class="lineNum">     282 </span>            : 
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :   return res;</span>
<a name="284"><span class="lineNum">     284 </span>            : }</a>
<span class="lineNum">     285 </span>            : 
<span class="lineNum">     286 </span><span class="lineCov">         20 : static inline int a2a_sched_linear(int rank, int p, MPI_Aint sndext, MPI_Aint rcvext, NBC_Schedule* schedule, void* sendbuf, int sendcount, MPI_Datatype sendtype, void* recvbuf, int recvcount, MPI_Datatype recvtype, MPI_Comm comm) {</span>
<span class="lineNum">     287 </span>            :   int res, r;
<span class="lineNum">     288 </span>            :   char *rbuf, *sbuf;
<span class="lineNum">     289 </span>            : 
<span class="lineNum">     290 </span><span class="lineCov">         20 :   res = NBC_OK;</span>
<span class="lineNum">     291 </span>            : 
<span class="lineNum">     292 </span><span class="lineCov">        100 :   for(r=0;r&lt;p;r++) {</span>
<span class="lineNum">     293 </span>            :     /* easy algorithm */
<span class="lineNum">     294 </span><span class="lineCov">         80 :     if (r == rank) { continue; }</span>
<span class="lineNum">     295 </span><span class="lineCov">         60 :     rbuf = ((char *) recvbuf) + (r*recvcount*rcvext);</span>
<span class="lineNum">     296 </span><span class="lineCov">         60 :     res = NBC_Sched_recv(rbuf, false, recvcount, recvtype, r, schedule);</span>
<span class="lineNum">     297 </span><span class="lineCov">         60 :     if (NBC_OK != res) { printf(&quot;Error in NBC_Sched_recv() (%i)\n&quot;, res); return res; }</span>
<span class="lineNum">     298 </span><span class="lineCov">         60 :     sbuf = ((char *) sendbuf) + (r*sendcount*sndext);</span>
<span class="lineNum">     299 </span><span class="lineCov">         60 :     res = NBC_Sched_send(sbuf, false, sendcount, sendtype, r, schedule);</span>
<span class="lineNum">     300 </span><span class="lineCov">         60 :     if (NBC_OK != res) { printf(&quot;Error in NBC_Sched_send() (%i)\n&quot;, res); return res; }</span>
<span class="lineNum">     301 </span>            :   }
<span class="lineNum">     302 </span>            : 
<span class="lineNum">     303 </span><span class="lineCov">         20 :   return res;</span>
<a name="304"><span class="lineNum">     304 </span>            : }</a>
<span class="lineNum">     305 </span>            : 
<span class="lineNum">     306 </span><span class="lineNoCov">          0 : static inline int a2a_sched_diss(int rank, int p, MPI_Aint sndext, MPI_Aint rcvext, NBC_Schedule* schedule, void* sendbuf, int sendcount, MPI_Datatype sendtype, void* recvbuf, int recvcount, MPI_Datatype recvtype, MPI_Comm comm, NBC_Handle *handle) {</span>
<span class="lineNum">     307 </span>            :   int res, i, r, speer, rpeer, datasize, offset, virtp;
<span class="lineNum">     308 </span>            :   char *rbuf, *rtmpbuf, *stmpbuf;
<span class="lineNum">     309 </span>            : 
<span class="lineNum">     310 </span><span class="lineNoCov">          0 :   res = NBC_OK;</span>
<span class="lineNum">     311 </span><span class="lineNoCov">          0 :   if(p &lt; 2) return res;</span>
<span class="lineNum">     312 </span>            : 
<span class="lineNum">     313 </span><span class="lineNoCov">          0 :   if(NBC_Type_intrinsic(sendtype)) {</span>
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :     datasize = sndext*sendcount;</span>
<span class="lineNum">     315 </span>            :   } else {
<span class="lineNum">     316 </span><span class="lineNoCov">          0 :     res = MPI_Pack_size(sendcount, sendtype, comm, &amp;datasize);</span>
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :     if (MPI_SUCCESS != res) { printf(&quot;MPI Error in MPI_Pack_size() (%i)\n&quot;, res); return res; }</span>
<span class="lineNum">     318 </span>            :   }
<span class="lineNum">     319 </span>            : 
<span class="lineNum">     320 </span>            :   /* allocate temporary buffers */
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :   if(p % 2 == 0) {</span>
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :     rtmpbuf = (char*)handle-&gt;tmpbuf+datasize*p;</span>
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :     stmpbuf = (char*)handle-&gt;tmpbuf+datasize*(p+p/2);</span>
<span class="lineNum">     324 </span>            :   } else {
<span class="lineNum">     325 </span>            :     /* we cannot divide p by two, so alloc more to be safe ... */
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :     virtp = (p/2+1)*2;</span>
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :     rtmpbuf = (char*)handle-&gt;tmpbuf+datasize*p;</span>
<span class="lineNum">     328 </span><span class="lineNoCov">          0 :     stmpbuf = (char*)handle-&gt;tmpbuf+datasize*(p+virtp/2);</span>
<span class="lineNum">     329 </span>            :   }
<span class="lineNum">     330 </span>            : 
<span class="lineNum">     331 </span>            :   /* phase 2 - communicate */
<span class="lineNum">     332 </span>            :   /*printf(&quot;[%i] temp buffer is at %lu of size %i, maxround: %i\n&quot;, rank, (unsigned long)handle-&gt;tmpbuf, (int)datasize*p*(1&lt;&lt;maxround), maxround);*/
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :   for(r = 1; r &lt; p; r&lt;&lt;=1) {</span>
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :     offset = 0;</span>
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :     for(i=1; i&lt;p; i++) {</span>
<span class="lineNum">     336 </span>            :       /* test if bit r is set in rank number i */
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :       if((i&amp;r) == r) {</span>
<span class="lineNum">     338 </span>            :         /* copy data to sendbuffer (2nd copy) - could be avoided using iovecs */
<span class="lineNum">     339 </span>            :         /*printf(&quot;[%i] round %i: copying element %i to buffer %lu\n&quot;, rank, r, i, (unsigned long)(stmpbuf+offset));*/
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :         NBC_Sched_copy((void*)(long)(i*datasize), true, datasize, MPI_BYTE, stmpbuf+offset-(unsigned long)handle-&gt;tmpbuf, true, datasize, MPI_BYTE, schedule);</span>
<span class="lineNum">     341 </span><span class="lineNoCov">          0 :         offset += datasize;</span>
<span class="lineNum">     342 </span>            :       }
<span class="lineNum">     343 </span>            :     }
<span class="lineNum">     344 </span>            : 
<span class="lineNum">     345 </span><span class="lineNoCov">          0 :     speer = ( rank + r) % p;</span>
<span class="lineNum">     346 </span>            :     /* add p because modulo does not work with negative values */
<span class="lineNum">     347 </span><span class="lineNoCov">          0 :     rpeer = ((rank - r)+p) % p;</span>
<span class="lineNum">     348 </span>            : 
<span class="lineNum">     349 </span>            :     /*printf(&quot;[%i] receiving %i bytes from host %i into rbuf %lu\n&quot;, rank, offset, rpeer, (unsigned long)rtmpbuf);*/
<span class="lineNum">     350 </span><span class="lineNoCov">          0 :     res = NBC_Sched_recv(rtmpbuf-(unsigned long)handle-&gt;tmpbuf, true, offset, MPI_BYTE, rpeer, schedule);</span>
<span class="lineNum">     351 </span><span class="lineNoCov">          0 :     if (NBC_OK != res) { printf(&quot;Error in NBC_Sched_recv() (%i)\n&quot;, res); return res; }</span>
<span class="lineNum">     352 </span>            : 
<span class="lineNum">     353 </span>            :     /*printf(&quot;[%i] sending %i bytes to host %i from sbuf %lu\n&quot;, rank, offset, speer, (unsigned long)stmpbuf);*/
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :     res = NBC_Sched_send(stmpbuf-(unsigned long)handle-&gt;tmpbuf, true, offset, MPI_BYTE, speer, schedule);</span>
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :     if (NBC_OK != res) { printf(&quot;Error in NBC_Sched_send() (%i)\n&quot;, res); return res; }</span>
<span class="lineNum">     356 </span>            : 
<span class="lineNum">     357 </span><span class="lineNoCov">          0 :     res = NBC_Sched_barrier(schedule);</span>
<span class="lineNum">     358 </span><span class="lineNoCov">          0 :     if (NBC_OK != res) { printf(&quot;Error in NBC_Sched_barrier() (%i)\n&quot;, res); return res; }</span>
<span class="lineNum">     359 </span>            : 
<span class="lineNum">     360 </span>            :     /* unpack from buffer */
<span class="lineNum">     361 </span><span class="lineNoCov">          0 :     offset = 0;</span>
<span class="lineNum">     362 </span><span class="lineNoCov">          0 :     for(i=1; i&lt;p; i++) {</span>
<span class="lineNum">     363 </span>            :       /* test if bit r is set in rank number i */
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :       if((i&amp;r) == r) {</span>
<span class="lineNum">     365 </span>            :         /* copy data to tmpbuffer (3rd copy) - could be avoided using iovecs */
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :         NBC_Sched_copy(rtmpbuf+offset-(unsigned long)handle-&gt;tmpbuf, true, datasize, MPI_BYTE, (void*)(long)(i*datasize), true, datasize, MPI_BYTE, schedule);</span>
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :         offset += datasize;</span>
<span class="lineNum">     368 </span>            :       }
<span class="lineNum">     369 </span>            :     }
<span class="lineNum">     370 </span>            :   }
<span class="lineNum">     371 </span>            : 
<span class="lineNum">     372 </span>            :   /* phase 3 - reorder - data is now in wrong order in handle-&gt;tmpbuf -
<span class="lineNum">     373 </span>            :    * reorder it into recvbuf */
<span class="lineNum">     374 </span><span class="lineNoCov">          0 :   for(i=0; i&lt;p; i++) {</span>
<span class="lineNum">     375 </span><span class="lineNoCov">          0 :     rbuf = (char*)recvbuf+((rank-i+p)%p)*recvcount*rcvext;</span>
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :     res = NBC_Sched_unpack((void*)(long)(i*datasize), true, recvcount, recvtype, rbuf, false, schedule);</span>
<span class="lineNum">     377 </span><span class="lineNoCov">          0 :     if (NBC_OK != res) { printf(&quot;MPI Error in NBC_Sched_pack() (%i)\n&quot;, res); return res; }</span>
<span class="lineNum">     378 </span>            :   }
<span class="lineNum">     379 </span>            : 
<span class="lineNum">     380 </span><span class="lineNoCov">          0 :   return NBC_OK;</span>
<span class="lineNum">     381 </span>            : }
<span class="lineNum">     382 </span>            : 
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
