<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - master-ibm-intel-check - orte/mca/ess/base/ess_base_fns.c</title>
  <link rel="stylesheet" type="text/css" href="../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../index.html">top level</a> - <a href="index.html">orte/mca/ess/base</a> - ess_base_fns.c<span style="font-size: 80%;"> (source / <a href="ess_base_fns.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">master-ibm-intel-check</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">24</td>
            <td class="headerCovTableEntry">149</td>
            <td class="headerCovTableEntryLo">16.1 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2015-08-03 17:10:23</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntryHi">100.0 %</td>
          </tr>
          <tr><td><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  * Copyright (c) 2004-2005 The Trustees of Indiana University and Indiana
<span class="lineNum">       3 </span>            :  *                         University Research and Technology
<span class="lineNum">       4 </span>            :  *                         Corporation.  All rights reserved.
<span class="lineNum">       5 </span>            :  * Copyright (c) 2004-2011 The University of Tennessee and The University
<span class="lineNum">       6 </span>            :  *                         of Tennessee Research Foundation.  All rights
<span class="lineNum">       7 </span>            :  *                         reserved.
<span class="lineNum">       8 </span>            :  * Copyright (c) 2004-2005 High Performance Computing Center Stuttgart,
<span class="lineNum">       9 </span>            :  *                         University of Stuttgart.  All rights reserved.
<span class="lineNum">      10 </span>            :  * Copyright (c) 2004-2005 The Regents of the University of California.
<span class="lineNum">      11 </span>            :  *                         All rights reserved.
<span class="lineNum">      12 </span>            :  * Copyright (c) 2011-2012 Cisco Systems, Inc.  All rights reserved.
<span class="lineNum">      13 </span>            :  * Copyright (c) 2011-2012 Los Alamos National Security, LLC.
<span class="lineNum">      14 </span>            :  *                         All rights reserved.
<span class="lineNum">      15 </span>            :  * Copyright (c) 2014      Intel, Inc. All rights reserved.
<span class="lineNum">      16 </span>            :  * Copyright (c) 2014      Research Organization for Information Science
<span class="lineNum">      17 </span>            :  *                         and Technology (RIST). All rights reserved.
<span class="lineNum">      18 </span>            :  * $COPYRIGHT$
<span class="lineNum">      19 </span>            :  *
<span class="lineNum">      20 </span>            :  * Additional copyrights may follow
<span class="lineNum">      21 </span>            :  *
<span class="lineNum">      22 </span>            :  * $HEADER$
<span class="lineNum">      23 </span>            :  */
<span class="lineNum">      24 </span>            : 
<span class="lineNum">      25 </span>            : #include &quot;orte_config.h&quot;
<span class="lineNum">      26 </span>            : #include &quot;orte/constants.h&quot;
<span class="lineNum">      27 </span>            : 
<span class="lineNum">      28 </span>            : #ifdef HAVE_UNISTD_H
<span class="lineNum">      29 </span>            : #include &lt;unistd.h&gt;
<span class="lineNum">      30 </span>            : #endif
<span class="lineNum">      31 </span>            : #include &lt;stdlib.h&gt;
<span class="lineNum">      32 </span>            : #include &lt;errno.h&gt;
<span class="lineNum">      33 </span>            : 
<span class="lineNum">      34 </span>            : #include &quot;opal/util/output.h&quot;
<span class="lineNum">      35 </span>            : #include &quot;opal/mca/dstore/dstore.h&quot;
<span class="lineNum">      36 </span>            : #include &quot;opal/mca/hwloc/base/base.h&quot;
<span class="lineNum">      37 </span>            : 
<span class="lineNum">      38 </span>            : #include &quot;orte/mca/errmgr/errmgr.h&quot;
<span class="lineNum">      39 </span>            : #include &quot;orte/util/name_fns.h&quot;
<span class="lineNum">      40 </span>            : #include &quot;orte/util/nidmap.h&quot;
<span class="lineNum">      41 </span>            : #include &quot;orte/util/proc_info.h&quot;
<span class="lineNum">      42 </span>            : #include &quot;orte/util/show_help.h&quot;
<span class="lineNum">      43 </span>            : #include &quot;orte/runtime/orte_globals.h&quot;
<span class="lineNum">      44 </span>            : 
<a name="45"><span class="lineNum">      45 </span>            : #include &quot;orte/mca/ess/base/base.h&quot;</a>
<span class="lineNum">      46 </span>            : 
<span class="lineNum">      47 </span><span class="lineCov">       1553 : int orte_ess_base_proc_binding(void)</span>
<span class="lineNum">      48 </span>            : {
<span class="lineNum">      49 </span>            : #if OPAL_HAVE_HWLOC
<span class="lineNum">      50 </span>            :     hwloc_obj_t node, obj;
<span class="lineNum">      51 </span>            :     hwloc_cpuset_t cpus, nodeset;
<span class="lineNum">      52 </span>            :     hwloc_obj_type_t target;
<span class="lineNum">      53 </span><span class="lineCov">       1553 :     unsigned int cache_level = 0;</span>
<span class="lineNum">      54 </span>            :     struct hwloc_topology_support *support;
<span class="lineNum">      55 </span>            :     char *map;
<span class="lineNum">      56 </span>            :     int ret;
<span class="lineNum">      57 </span><span class="lineCov">       1553 :     char *error=NULL;</span>
<span class="lineNum">      58 </span>            :     hwloc_cpuset_t mycpus;
<span class="lineNum">      59 </span>            :     opal_value_t kv;
<span class="lineNum">      60 </span>            : 
<span class="lineNum">      61 </span>            :     /* Determine if we were pre-bound or not */
<span class="lineNum">      62 </span><span class="lineCov">       1553 :     if (NULL != getenv(OPAL_MCA_PREFIX&quot;orte_bound_at_launch&quot;)) {</span>
<span class="lineNum">      63 </span><span class="lineCov">       1553 :         orte_proc_is_bound = true;</span>
<span class="lineNum">      64 </span><span class="lineCov">       1553 :         if (NULL != (map = getenv(OPAL_MCA_PREFIX&quot;orte_base_applied_binding&quot;))) {</span>
<span class="lineNum">      65 </span><span class="lineNoCov">          0 :             orte_proc_applied_binding = hwloc_bitmap_alloc();</span>
<span class="lineNum">      66 </span><span class="lineNoCov">          0 :             if (0 != (ret = hwloc_bitmap_list_sscanf(orte_proc_applied_binding, map))) {</span>
<span class="lineNum">      67 </span><span class="lineNoCov">          0 :                 error = &quot;applied_binding parse&quot;;</span>
<span class="lineNum">      68 </span><span class="lineNoCov">          0 :                 goto error;</span>
<span class="lineNum">      69 </span>            :             }
<span class="lineNum">      70 </span>            :         }
<span class="lineNum">      71 </span>            :     }
<span class="lineNum">      72 </span>            : 
<span class="lineNum">      73 </span>            :     /* see if we were bound when launched */
<span class="lineNum">      74 </span><span class="lineCov">       1553 :     if (!orte_proc_is_bound) {</span>
<span class="lineNum">      75 </span><span class="lineNoCov">          0 :         OPAL_OUTPUT_VERBOSE((5, orte_ess_base_framework.framework_output,</span>
<span class="lineNum">      76 </span>            :                              &quot;%s Not bound at launch&quot;,
<span class="lineNum">      77 </span>            :                              ORTE_NAME_PRINT(ORTE_PROC_MY_NAME)));
<span class="lineNum">      78 </span>            :         /* we were not bound at launch */
<span class="lineNum">      79 </span><span class="lineNoCov">          0 :         if (NULL == opal_hwloc_topology) {</span>
<span class="lineNum">      80 </span>            :             /* there is nothing we can do, so just return */
<span class="lineNum">      81 </span><span class="lineNoCov">          0 :             return ORTE_SUCCESS;</span>
<span class="lineNum">      82 </span>            :         }
<span class="lineNum">      83 </span><span class="lineNoCov">          0 :         support = (struct hwloc_topology_support*)hwloc_topology_get_support(opal_hwloc_topology);</span>
<span class="lineNum">      84 </span>            :         /* get our node object */
<span class="lineNum">      85 </span><span class="lineNoCov">          0 :         node = hwloc_get_root_obj(opal_hwloc_topology);</span>
<span class="lineNum">      86 </span><span class="lineNoCov">          0 :         nodeset = opal_hwloc_base_get_available_cpus(opal_hwloc_topology, node);</span>
<span class="lineNum">      87 </span>            :         /* get our bindings */
<span class="lineNum">      88 </span><span class="lineNoCov">          0 :         cpus = hwloc_bitmap_alloc();</span>
<span class="lineNum">      89 </span><span class="lineNoCov">          0 :         if (hwloc_get_cpubind(opal_hwloc_topology, cpus, HWLOC_CPUBIND_PROCESS) &lt; 0) {</span>
<span class="lineNum">      90 </span>            :             /* we are NOT bound if get_cpubind fails, nor can we be bound - the
<span class="lineNum">      91 </span>            :              * environment does not support it
<span class="lineNum">      92 </span>            :              */
<span class="lineNum">      93 </span><span class="lineNoCov">          0 :             hwloc_bitmap_free(cpus);</span>
<span class="lineNum">      94 </span><span class="lineNoCov">          0 :             OPAL_OUTPUT_VERBOSE((5, orte_ess_base_framework.framework_output,</span>
<span class="lineNum">      95 </span>            :                                  &quot;%s Binding not supported&quot;,
<span class="lineNum">      96 </span>            :                                  ORTE_NAME_PRINT(ORTE_PROC_MY_NAME)));
<span class="lineNum">      97 </span><span class="lineNoCov">          0 :             goto MOVEON;</span>
<span class="lineNum">      98 </span>            :         }
<span class="lineNum">      99 </span>            :         /* we are bound if the two cpusets are not equal,
<span class="lineNum">     100 </span>            :          * or if there is only ONE cpu available to us
<span class="lineNum">     101 </span>            :          */
<span class="lineNum">     102 </span><span class="lineNoCov">          0 :         if (0 != hwloc_bitmap_compare(cpus, nodeset) ||</span>
<span class="lineNum">     103 </span><span class="lineNoCov">          0 :             opal_hwloc_base_single_cpu(nodeset) ||</span>
<span class="lineNum">     104 </span><span class="lineNoCov">          0 :             opal_hwloc_base_single_cpu(cpus)) {</span>
<span class="lineNum">     105 </span>            :             /* someone external set it - indicate it is set
<span class="lineNum">     106 </span>            :              * so that we know
<span class="lineNum">     107 </span>            :              */
<span class="lineNum">     108 </span><span class="lineNoCov">          0 :             orte_proc_is_bound = true;</span>
<span class="lineNum">     109 </span><span class="lineNoCov">          0 :             hwloc_bitmap_list_asprintf(&amp;orte_process_info.cpuset, cpus);</span>
<span class="lineNum">     110 </span><span class="lineNoCov">          0 :             hwloc_bitmap_free(cpus);</span>
<span class="lineNum">     111 </span><span class="lineNoCov">          0 :             OPAL_OUTPUT_VERBOSE((5, orte_ess_base_framework.framework_output,</span>
<span class="lineNum">     112 </span>            :                                  &quot;%s Process was externally bound&quot;,
<span class="lineNum">     113 </span>            :                                  ORTE_NAME_PRINT(ORTE_PROC_MY_NAME)));
<span class="lineNum">     114 </span><span class="lineNoCov">          0 :         } else if (support-&gt;cpubind-&gt;set_thisproc_cpubind &amp;&amp;</span>
<span class="lineNum">     115 </span><span class="lineNoCov">          0 :                    OPAL_BINDING_POLICY_IS_SET(opal_hwloc_binding_policy) &amp;&amp;</span>
<span class="lineNum">     116 </span><span class="lineNoCov">          0 :                    OPAL_BIND_TO_NONE != OPAL_GET_BINDING_POLICY(opal_hwloc_binding_policy)) {</span>
<span class="lineNum">     117 </span>            :             /* the system is capable of doing processor affinity, but it
<span class="lineNum">     118 </span>            :              * has not yet been set - see if a slot_list was given
<span class="lineNum">     119 </span>            :              */
<span class="lineNum">     120 </span><span class="lineNoCov">          0 :             hwloc_bitmap_zero(cpus);</span>
<span class="lineNum">     121 </span><span class="lineNoCov">          0 :             if (OPAL_BIND_TO_CPUSET == OPAL_GET_BINDING_POLICY(opal_hwloc_binding_policy)) {</span>
<span class="lineNum">     122 </span><span class="lineNoCov">          0 :                 if (OPAL_SUCCESS != (ret = opal_hwloc_base_slot_list_parse(opal_hwloc_base_slot_list,</span>
<span class="lineNum">     123 </span>            :                                                                            opal_hwloc_topology,
<span class="lineNum">     124 </span>            :                                                                            OPAL_HWLOC_LOGICAL, cpus))) {
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :                     error = &quot;Setting processor affinity failed&quot;;</span>
<span class="lineNum">     126 </span><span class="lineNoCov">          0 :                     hwloc_bitmap_free(cpus);</span>
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :                     goto error;</span>
<span class="lineNum">     128 </span>            :                 }
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :                 if (0 &gt; hwloc_set_cpubind(opal_hwloc_topology, cpus, 0)) {</span>
<span class="lineNum">     130 </span><span class="lineNoCov">          0 :                     error = &quot;Setting processor affinity failed&quot;;</span>
<span class="lineNum">     131 </span><span class="lineNoCov">          0 :                     hwloc_bitmap_free(cpus);</span>
<span class="lineNum">     132 </span><span class="lineNoCov">          0 :                     goto error;</span>
<span class="lineNum">     133 </span>            :                 }
<span class="lineNum">     134 </span><span class="lineNoCov">          0 :                 hwloc_bitmap_list_asprintf(&amp;orte_process_info.cpuset, cpus);</span>
<span class="lineNum">     135 </span><span class="lineNoCov">          0 :                 hwloc_bitmap_free(cpus);</span>
<span class="lineNum">     136 </span><span class="lineNoCov">          0 :                 orte_proc_is_bound = true;</span>
<span class="lineNum">     137 </span><span class="lineNoCov">          0 :                 OPAL_OUTPUT_VERBOSE((5, orte_ess_base_framework.framework_output,</span>
<span class="lineNum">     138 </span>            :                                      &quot;%s Process bound according to slot_list&quot;,
<span class="lineNum">     139 </span>            :                                      ORTE_NAME_PRINT(ORTE_PROC_MY_NAME)));
<span class="lineNum">     140 </span>            :             } else {
<span class="lineNum">     141 </span>            :                 /* cleanup */
<span class="lineNum">     142 </span><span class="lineNoCov">          0 :                 hwloc_bitmap_free(cpus);</span>
<span class="lineNum">     143 </span>            :                 /* get the node rank */
<span class="lineNum">     144 </span><span class="lineNoCov">          0 :                 if (ORTE_NODE_RANK_INVALID == orte_process_info.my_node_rank) {</span>
<span class="lineNum">     145 </span>            :                     /* this is not an error - could be due to being
<span class="lineNum">     146 </span>            :                      * direct launched - so just ignore and leave
<span class="lineNum">     147 </span>            :                      * us unbound
<span class="lineNum">     148 </span>            :                      */
<span class="lineNum">     149 </span><span class="lineNoCov">          0 :                     OPAL_OUTPUT_VERBOSE((5, orte_ess_base_framework.framework_output,</span>
<span class="lineNum">     150 </span>            :                                          &quot;%s Process not bound - no node rank available&quot;,
<span class="lineNum">     151 </span>            :                                          ORTE_NAME_PRINT(ORTE_PROC_MY_NAME)));
<span class="lineNum">     152 </span><span class="lineNoCov">          0 :                     goto MOVEON;</span>
<span class="lineNum">     153 </span>            :                 }
<span class="lineNum">     154 </span>            :                 /* if the binding policy is hwthread, then we bind to the nrank-th
<span class="lineNum">     155 </span>            :                  * hwthread on this node
<span class="lineNum">     156 </span>            :                  */
<span class="lineNum">     157 </span><span class="lineNoCov">          0 :                 if (OPAL_BIND_TO_HWTHREAD == OPAL_GET_BINDING_POLICY(opal_hwloc_binding_policy)) {</span>
<span class="lineNum">     158 </span><span class="lineNoCov">          0 :                     if (NULL == (obj = opal_hwloc_base_get_obj_by_type(opal_hwloc_topology, HWLOC_OBJ_PU,</span>
<span class="lineNum">     159 </span><span class="lineNoCov">          0 :                                                                        0, orte_process_info.my_node_rank, OPAL_HWLOC_LOGICAL))) {</span>
<span class="lineNum">     160 </span><span class="lineNoCov">          0 :                         ret = ORTE_ERR_NOT_FOUND;</span>
<span class="lineNum">     161 </span><span class="lineNoCov">          0 :                         error = &quot;Getting hwthread object&quot;;</span>
<span class="lineNum">     162 </span><span class="lineNoCov">          0 :                         goto error;</span>
<span class="lineNum">     163 </span>            :                     }
<span class="lineNum">     164 </span><span class="lineNoCov">          0 :                     cpus = opal_hwloc_base_get_available_cpus(opal_hwloc_topology, obj);</span>
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :                     if (0 &gt; hwloc_set_cpubind(opal_hwloc_topology, cpus, 0)) {</span>
<span class="lineNum">     166 </span><span class="lineNoCov">          0 :                         ret = ORTE_ERROR;</span>
<span class="lineNum">     167 </span><span class="lineNoCov">          0 :                         error = &quot;Setting processor affinity failed&quot;;</span>
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :                         goto error;</span>
<span class="lineNum">     169 </span>            :                     }
<span class="lineNum">     170 </span><span class="lineNoCov">          0 :                     hwloc_bitmap_list_asprintf(&amp;orte_process_info.cpuset, cpus);</span>
<span class="lineNum">     171 </span><span class="lineNoCov">          0 :                     hwloc_bitmap_free(cpus);</span>
<span class="lineNum">     172 </span><span class="lineNoCov">          0 :                     OPAL_OUTPUT_VERBOSE((5, orte_ess_base_framework.framework_output,</span>
<span class="lineNum">     173 </span>            :                                          &quot;%s Process bound to hwthread&quot;,
<span class="lineNum">     174 </span>            :                                          ORTE_NAME_PRINT(ORTE_PROC_MY_NAME)));
<span class="lineNum">     175 </span><span class="lineNoCov">          0 :                 } else if (OPAL_BIND_TO_CORE == OPAL_GET_BINDING_POLICY(opal_hwloc_binding_policy)) {</span>
<span class="lineNum">     176 </span>            :                     /* if the binding policy is core, then we bind to the nrank-th
<span class="lineNum">     177 </span>            :                      * core on this node
<span class="lineNum">     178 </span>            :                      */
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :                     if (NULL == (obj = opal_hwloc_base_get_obj_by_type(opal_hwloc_topology, HWLOC_OBJ_CORE,</span>
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :                                                                        0, orte_process_info.my_node_rank, OPAL_HWLOC_LOGICAL))) {</span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :                         ret = ORTE_ERR_NOT_FOUND;</span>
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :                         error = &quot;Getting core object&quot;;</span>
<span class="lineNum">     183 </span><span class="lineNoCov">          0 :                         goto error;</span>
<span class="lineNum">     184 </span>            :                     }
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :                     cpus = opal_hwloc_base_get_available_cpus(opal_hwloc_topology, obj);</span>
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :                     if (0 &gt; hwloc_set_cpubind(opal_hwloc_topology, cpus, 0)) {</span>
<span class="lineNum">     187 </span><span class="lineNoCov">          0 :                         error = &quot;Setting processor affinity failed&quot;;</span>
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :                         ret = ORTE_ERROR;</span>
<span class="lineNum">     189 </span><span class="lineNoCov">          0 :                         goto error;</span>
<span class="lineNum">     190 </span>            :                     }
<span class="lineNum">     191 </span><span class="lineNoCov">          0 :                     hwloc_bitmap_list_asprintf(&amp;orte_process_info.cpuset, cpus);</span>
<span class="lineNum">     192 </span><span class="lineNoCov">          0 :                     OPAL_OUTPUT_VERBOSE((5, orte_ess_base_framework.framework_output,</span>
<span class="lineNum">     193 </span>            :                                          &quot;%s Process bound to core&quot;,
<span class="lineNum">     194 </span>            :                                          ORTE_NAME_PRINT(ORTE_PROC_MY_NAME)));
<span class="lineNum">     195 </span>            :                 } else {
<span class="lineNum">     196 </span>            :                     /* for all higher binding policies, we bind to the specified
<span class="lineNum">     197 </span>            :                      * object that the nrank-th core belongs to
<span class="lineNum">     198 </span>            :                      */
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :                     if (NULL == (obj = opal_hwloc_base_get_obj_by_type(opal_hwloc_topology, HWLOC_OBJ_CORE,</span>
<span class="lineNum">     200 </span><span class="lineNoCov">          0 :                                                                        0, orte_process_info.my_node_rank, OPAL_HWLOC_LOGICAL))) {</span>
<span class="lineNum">     201 </span><span class="lineNoCov">          0 :                         ret = ORTE_ERR_NOT_FOUND;</span>
<span class="lineNum">     202 </span><span class="lineNoCov">          0 :                         error = &quot;Getting core object&quot;;</span>
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :                         goto error;</span>
<span class="lineNum">     204 </span>            :                     }
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :                     if (OPAL_BIND_TO_L1CACHE == OPAL_GET_BINDING_POLICY(opal_hwloc_binding_policy)) {</span>
<span class="lineNum">     206 </span><span class="lineNoCov">          0 :                         target = HWLOC_OBJ_CACHE;</span>
<span class="lineNum">     207 </span><span class="lineNoCov">          0 :                         cache_level = 1;</span>
<span class="lineNum">     208 </span><span class="lineNoCov">          0 :                     } else if (OPAL_BIND_TO_L2CACHE == OPAL_GET_BINDING_POLICY(opal_hwloc_binding_policy)) {</span>
<span class="lineNum">     209 </span><span class="lineNoCov">          0 :                         target = HWLOC_OBJ_CACHE;</span>
<span class="lineNum">     210 </span><span class="lineNoCov">          0 :                         cache_level = 2;</span>
<span class="lineNum">     211 </span><span class="lineNoCov">          0 :                     } else if (OPAL_BIND_TO_L3CACHE == OPAL_GET_BINDING_POLICY(opal_hwloc_binding_policy)) {</span>
<span class="lineNum">     212 </span><span class="lineNoCov">          0 :                         target = HWLOC_OBJ_CACHE;</span>
<span class="lineNum">     213 </span><span class="lineNoCov">          0 :                         cache_level = 3;</span>
<span class="lineNum">     214 </span><span class="lineNoCov">          0 :                     } else if (OPAL_BIND_TO_SOCKET == OPAL_GET_BINDING_POLICY(opal_hwloc_binding_policy)) {</span>
<span class="lineNum">     215 </span><span class="lineNoCov">          0 :                         target = HWLOC_OBJ_SOCKET;</span>
<span class="lineNum">     216 </span><span class="lineNoCov">          0 :                     } else if (OPAL_BIND_TO_NUMA == OPAL_GET_BINDING_POLICY(opal_hwloc_binding_policy)) {</span>
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :                         target = HWLOC_OBJ_NODE;</span>
<span class="lineNum">     218 </span>            :                     } else {
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :                         ret = ORTE_ERR_NOT_FOUND;</span>
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :                         error = &quot;Binding policy not known&quot;;</span>
<span class="lineNum">     221 </span><span class="lineNoCov">          0 :                         goto error;</span>
<span class="lineNum">     222 </span>            :                     }
<span class="lineNum">     223 </span><span class="lineNoCov">          0 :                     for (obj = obj-&gt;parent; NULL != obj; obj = obj-&gt;parent) {</span>
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :                         if (target == obj-&gt;type) {</span>
<span class="lineNum">     225 </span><span class="lineNoCov">          0 :                             if (HWLOC_OBJ_CACHE == target &amp;&amp; cache_level != obj-&gt;attr-&gt;cache.depth) {</span>
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">     227 </span>            :                             }
<span class="lineNum">     228 </span>            :                             /* this is the place! */
<span class="lineNum">     229 </span><span class="lineNoCov">          0 :                             cpus = opal_hwloc_base_get_available_cpus(opal_hwloc_topology, obj);</span>
<span class="lineNum">     230 </span><span class="lineNoCov">          0 :                             if (0 &gt; hwloc_set_cpubind(opal_hwloc_topology, cpus, 0)) {</span>
<span class="lineNum">     231 </span><span class="lineNoCov">          0 :                                 ret = ORTE_ERROR;</span>
<span class="lineNum">     232 </span><span class="lineNoCov">          0 :                                 error = &quot;Setting processor affinity failed&quot;;</span>
<span class="lineNum">     233 </span><span class="lineNoCov">          0 :                                 goto error;</span>
<span class="lineNum">     234 </span>            :                             }
<span class="lineNum">     235 </span><span class="lineNoCov">          0 :                             hwloc_bitmap_list_asprintf(&amp;orte_process_info.cpuset, cpus);</span>
<span class="lineNum">     236 </span><span class="lineNoCov">          0 :                             orte_proc_is_bound = true;</span>
<span class="lineNum">     237 </span><span class="lineNoCov">          0 :                             OPAL_OUTPUT_VERBOSE((5, orte_ess_base_framework.framework_output,</span>
<span class="lineNum">     238 </span>            :                                                  &quot;%s Process bound to %s&quot;,
<span class="lineNum">     239 </span>            :                                                  ORTE_NAME_PRINT(ORTE_PROC_MY_NAME),
<span class="lineNum">     240 </span>            :                                                  hwloc_obj_type_string(target)));
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :                             break;</span>
<span class="lineNum">     242 </span>            :                         }
<span class="lineNum">     243 </span>            :                     }
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :                     if (!orte_proc_is_bound) {</span>
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :                         ret = ORTE_ERROR;</span>
<span class="lineNum">     246 </span><span class="lineNoCov">          0 :                         error = &quot;Setting processor affinity failed&quot;;</span>
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :                         goto error;</span>
<span class="lineNum">     248 </span>            :                     }
<span class="lineNum">     249 </span>            :                 }
<span class="lineNum">     250 </span>            :             }
<span class="lineNum">     251 </span>            :         }
<span class="lineNum">     252 </span>            :     } else {
<span class="lineNum">     253 </span><span class="lineCov">       1553 :         OPAL_OUTPUT_VERBOSE((5, orte_ess_base_framework.framework_output,</span>
<span class="lineNum">     254 </span>            :                              &quot;%s Process bound at launch&quot;,
<span class="lineNum">     255 </span>            :                              ORTE_NAME_PRINT(ORTE_PROC_MY_NAME)));
<span class="lineNum">     256 </span>            :     }
<span class="lineNum">     257 </span>            : 
<span class="lineNum">     258 </span>            :  MOVEON:
<span class="lineNum">     259 </span>            :     /* get or update our local cpuset - it will get used multiple
<span class="lineNum">     260 </span>            :      * times, so it's more efficient to keep a global copy
<span class="lineNum">     261 </span>            :      */
<span class="lineNum">     262 </span><span class="lineCov">       1553 :     opal_hwloc_base_get_local_cpuset();</span>
<span class="lineNum">     263 </span>            : 
<span class="lineNum">     264 </span>            :     /* get the cpus we are bound to */
<span class="lineNum">     265 </span><span class="lineCov">       1553 :     mycpus = hwloc_bitmap_alloc();</span>
<span class="lineNum">     266 </span><span class="lineCov">       1553 :     if (hwloc_get_cpubind(opal_hwloc_topology,</span>
<span class="lineNum">     267 </span>            :                           mycpus,
<span class="lineNum">     268 </span>            :                           HWLOC_CPUBIND_PROCESS) &lt; 0) {
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :         if (NULL != orte_process_info.cpuset) {</span>
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :             free(orte_process_info.cpuset);</span>
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :             orte_process_info.cpuset = NULL;</span>
<span class="lineNum">     272 </span>            :         }
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :         if (opal_hwloc_report_bindings || 4 &lt; opal_output_get_verbosity(orte_ess_base_framework.framework_output)) {</span>
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :             opal_output(0, &quot;MCW rank %d is not bound&quot;,</span>
<span class="lineNum">     275 </span>            :                         ORTE_PROC_MY_NAME-&gt;vpid);
<span class="lineNum">     276 </span>            :         }
<span class="lineNum">     277 </span>            :     } else {
<span class="lineNum">     278 </span>            :         /* store/update the string representation of our local binding */
<span class="lineNum">     279 </span><span class="lineCov">       1553 :         if (NULL != orte_process_info.cpuset) {</span>
<span class="lineNum">     280 </span><span class="lineNoCov">          0 :             free(orte_process_info.cpuset);</span>
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :             orte_process_info.cpuset = NULL;</span>
<span class="lineNum">     282 </span>            :         }
<span class="lineNum">     283 </span><span class="lineCov">       1553 :         hwloc_bitmap_list_asprintf(&amp;orte_process_info.cpuset, mycpus);</span>
<span class="lineNum">     284 </span>            :         /* report the binding, if requested */
<span class="lineNum">     285 </span><span class="lineCov">       1553 :         if (opal_hwloc_report_bindings || 4 &lt; opal_output_get_verbosity(orte_ess_base_framework.framework_output)) {</span>
<span class="lineNum">     286 </span>            :             char tmp1[1024], tmp2[1024];
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :             if (OPAL_ERR_NOT_BOUND == opal_hwloc_base_cset2str(tmp1, sizeof(tmp1), opal_hwloc_topology, mycpus)) {</span>
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :                 opal_output(0, &quot;MCW rank %d is not bound (or bound to all available processors)&quot;, ORTE_PROC_MY_NAME-&gt;vpid);</span>
<span class="lineNum">     289 </span>            :             } else {
<span class="lineNum">     290 </span><span class="lineNoCov">          0 :                 opal_hwloc_base_cset2mapstr(tmp2, sizeof(tmp2), opal_hwloc_topology, mycpus);</span>
<span class="lineNum">     291 </span><span class="lineNoCov">          0 :                 opal_output(0, &quot;MCW rank %d bound to %s: %s&quot;,</span>
<span class="lineNum">     292 </span>            :                             ORTE_PROC_MY_NAME-&gt;vpid, tmp1, tmp2);
<span class="lineNum">     293 </span>            :             }
<span class="lineNum">     294 </span>            :         }
<span class="lineNum">     295 </span>            :     }
<span class="lineNum">     296 </span><span class="lineCov">       1553 :     hwloc_bitmap_free(mycpus);</span>
<span class="lineNum">     297 </span>            :     /* push our cpuset so others can calculate our locality */
<span class="lineNum">     298 </span><span class="lineCov">       1553 :     if (NULL != orte_process_info.cpuset) {</span>
<span class="lineNum">     299 </span><span class="lineCov">       1553 :          OBJ_CONSTRUCT(&amp;kv, opal_value_t);</span>
<span class="lineNum">     300 </span><span class="lineCov">       1553 :         kv.key = strdup(OPAL_DSTORE_CPUSET);</span>
<span class="lineNum">     301 </span><span class="lineCov">       1553 :         kv.type = OPAL_STRING;</span>
<span class="lineNum">     302 </span><span class="lineCov">       1553 :         kv.data.string = strdup(orte_process_info.cpuset);</span>
<span class="lineNum">     303 </span><span class="lineCov">       1553 :         if (OPAL_SUCCESS != (ret = opal_pmix.put(PMIX_GLOBAL, &amp;kv))) {</span>
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :             ORTE_ERROR_LOG(ret);</span>
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :             OBJ_DESTRUCT(&amp;kv);</span>
<span class="lineNum">     306 </span><span class="lineNoCov">          0 :             goto error;</span>
<span class="lineNum">     307 </span>            :         }
<span class="lineNum">     308 </span>            :         /* and store a copy locally */
<span class="lineNum">     309 </span><span class="lineCov">       1553 :         (void)opal_dstore.store(opal_dstore_internal, ORTE_PROC_MY_NAME, &amp;kv);</span>
<span class="lineNum">     310 </span><span class="lineCov">       1553 :         OBJ_DESTRUCT(&amp;kv);</span>
<span class="lineNum">     311 </span>            :     }
<span class="lineNum">     312 </span><span class="lineCov">       1553 :     return ORTE_SUCCESS;</span>
<span class="lineNum">     313 </span>            : 
<span class="lineNum">     314 </span>            :  error:
<span class="lineNum">     315 </span><span class="lineNoCov">          0 :     if (ORTE_ERR_SILENT != ret) {</span>
<span class="lineNum">     316 </span><span class="lineNoCov">          0 :         orte_show_help(&quot;help-orte-runtime&quot;,</span>
<span class="lineNum">     317 </span>            :                        &quot;orte_init:startup:internal-failure&quot;,
<span class="lineNum">     318 </span>            :                        true, error, ORTE_ERROR_NAME(ret), ret);
<span class="lineNum">     319 </span>            :     }
<span class="lineNum">     320 </span>            : 
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :     return ORTE_ERR_SILENT;</span>
<span class="lineNum">     322 </span>            : 
<span class="lineNum">     323 </span>            : #else
<span class="lineNum">     324 </span>            :     return ORTE_SUCCESS;
<span class="lineNum">     325 </span>            : #endif
<span class="lineNum">     326 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
