<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - master-ibm-intel - orte/mca/filem/raw/filem_raw_module.c</title>
  <link rel="stylesheet" type="text/css" href="../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../index.html">top level</a> - <a href="index.html">orte/mca/filem/raw</a> - filem_raw_module.c<span style="font-size: 80%;"> (source / <a href="filem_raw_module.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">master-ibm-intel</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">46</td>
            <td class="headerCovTableEntry">606</td>
            <td class="headerCovTableEntryLo">7.6 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2015-07-30 16:27:56</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">4</td>
            <td class="headerCovTableEntry">27</td>
            <td class="headerCovTableEntryLo">14.8 %</td>
          </tr>
          <tr><td><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  * Copyright (c) 2012-2013 Los Alamos National Security, LLC.
<span class="lineNum">       3 </span>            :  *                         All rights reserved
<span class="lineNum">       4 </span>            :  * Copyright (c) 2013      Cisco Systems, Inc.  All rights reserved.
<span class="lineNum">       5 </span>            :  * Copyright (c) 2014      Intel, Inc. All rights reserved.
<span class="lineNum">       6 </span>            :  * Copyright (c) 2015      Research Organization for Information Science
<span class="lineNum">       7 </span>            :  *                         and Technology (RIST). All rights reserved.
<span class="lineNum">       8 </span>            :  * $COPYRIGHT$
<span class="lineNum">       9 </span>            :  *
<span class="lineNum">      10 </span>            :  * Additional copyrights may follow
<span class="lineNum">      11 </span>            :  *
<span class="lineNum">      12 </span>            :  * $HEADER$
<span class="lineNum">      13 </span>            :  */
<span class="lineNum">      14 </span>            : 
<span class="lineNum">      15 </span>            : /*
<span class="lineNum">      16 </span>            :  *
<span class="lineNum">      17 </span>            :  */
<span class="lineNum">      18 </span>            : 
<span class="lineNum">      19 </span>            : #include &quot;orte_config.h&quot;
<span class="lineNum">      20 </span>            : #include &quot;orte/constants.h&quot;
<span class="lineNum">      21 </span>            : 
<span class="lineNum">      22 </span>            : #include &lt;string.h&gt;
<span class="lineNum">      23 </span>            : #include &lt;stdlib.h&gt;
<span class="lineNum">      24 </span>            : #include &lt;sys/types.h&gt;
<span class="lineNum">      25 </span>            : #include &lt;sys/stat.h&gt;
<span class="lineNum">      26 </span>            : #ifdef HAVE_UNISTD_H
<span class="lineNum">      27 </span>            : #include &lt;unistd.h&gt;
<span class="lineNum">      28 </span>            : #endif  /* HAVE_UNISTD_H */
<span class="lineNum">      29 </span>            : #ifdef HAVE_DIRENT_H
<span class="lineNum">      30 </span>            : #include &lt;dirent.h&gt;
<span class="lineNum">      31 </span>            : #endif  /* HAVE_DIRENT_H */
<span class="lineNum">      32 </span>            : #ifdef HAVE_FCNTL_H
<span class="lineNum">      33 </span>            : #include &lt;fcntl.h&gt;
<span class="lineNum">      34 </span>            : #endif
<span class="lineNum">      35 </span>            : 
<span class="lineNum">      36 </span>            : #include &quot;opal/class/opal_list.h&quot;
<span class="lineNum">      37 </span>            : #include &quot;opal/mca/event/event.h&quot;
<span class="lineNum">      38 </span>            : #include &quot;opal/dss/dss.h&quot;
<span class="lineNum">      39 </span>            : 
<span class="lineNum">      40 </span>            : #include &quot;orte/util/show_help.h&quot;
<span class="lineNum">      41 </span>            : #include &quot;opal/util/argv.h&quot;
<span class="lineNum">      42 </span>            : #include &quot;opal/util/output.h&quot;
<span class="lineNum">      43 </span>            : #include &quot;opal/util/opal_environ.h&quot;
<span class="lineNum">      44 </span>            : #include &quot;opal/util/os_dirpath.h&quot;
<span class="lineNum">      45 </span>            : #include &quot;opal/util/os_path.h&quot;
<span class="lineNum">      46 </span>            : #include &quot;opal/util/path.h&quot;
<span class="lineNum">      47 </span>            : #include &quot;opal/util/basename.h&quot;
<span class="lineNum">      48 </span>            : 
<span class="lineNum">      49 </span>            : #include &quot;orte/util/name_fns.h&quot;
<span class="lineNum">      50 </span>            : #include &quot;orte/util/proc_info.h&quot;
<span class="lineNum">      51 </span>            : #include &quot;orte/util/session_dir.h&quot;
<span class="lineNum">      52 </span>            : #include &quot;orte/runtime/orte_globals.h&quot;
<span class="lineNum">      53 </span>            : #include &quot;orte/mca/errmgr/errmgr.h&quot;
<span class="lineNum">      54 </span>            : #include &quot;orte/mca/grpcomm/base/base.h&quot;
<span class="lineNum">      55 </span>            : #include &quot;orte/mca/rml/rml.h&quot;
<span class="lineNum">      56 </span>            : 
<span class="lineNum">      57 </span>            : #include &quot;orte/mca/filem/filem.h&quot;
<span class="lineNum">      58 </span>            : #include &quot;orte/mca/filem/base/base.h&quot;
<span class="lineNum">      59 </span>            : 
<span class="lineNum">      60 </span>            : #include &quot;filem_raw.h&quot;
<span class="lineNum">      61 </span>            : 
<span class="lineNum">      62 </span>            : static int raw_init(void);
<span class="lineNum">      63 </span>            : static int raw_finalize(void);
<span class="lineNum">      64 </span>            : static int raw_put(orte_filem_base_request_t *req);
<span class="lineNum">      65 </span>            : static int raw_put_nb(orte_filem_base_request_t *req);
<span class="lineNum">      66 </span>            : static int raw_get(orte_filem_base_request_t *req);
<span class="lineNum">      67 </span>            : static int raw_get_nb(orte_filem_base_request_t *req);
<span class="lineNum">      68 </span>            : static int raw_rm(orte_filem_base_request_t *req);
<span class="lineNum">      69 </span>            : static int raw_rm_nb(orte_filem_base_request_t *req);
<span class="lineNum">      70 </span>            : static int raw_wait(orte_filem_base_request_t *req);
<span class="lineNum">      71 </span>            : static int raw_wait_all(opal_list_t *reqs);
<span class="lineNum">      72 </span>            : static int raw_preposition_files(orte_job_t *jdata,
<span class="lineNum">      73 </span>            :                                  orte_filem_completion_cbfunc_t cbfunc,
<span class="lineNum">      74 </span>            :                                  void *cbdata);
<span class="lineNum">      75 </span>            : static int raw_link_local_files(orte_job_t *jdata,
<span class="lineNum">      76 </span>            :                                 orte_app_context_t *app);
<span class="lineNum">      77 </span>            : 
<span class="lineNum">      78 </span>            : orte_filem_base_module_t mca_filem_raw_module = {
<span class="lineNum">      79 </span>            :     raw_init,
<span class="lineNum">      80 </span>            :     raw_finalize,
<span class="lineNum">      81 </span>            :     /* we don't use any of the following */
<span class="lineNum">      82 </span>            :     raw_put,
<span class="lineNum">      83 </span>            :     raw_put_nb,
<span class="lineNum">      84 </span>            :     raw_get,
<span class="lineNum">      85 </span>            :     raw_get_nb,
<span class="lineNum">      86 </span>            :     raw_rm,
<span class="lineNum">      87 </span>            :     raw_rm_nb,
<span class="lineNum">      88 </span>            :     raw_wait,
<span class="lineNum">      89 </span>            :     raw_wait_all,
<span class="lineNum">      90 </span>            :     /* now the APIs we *do* use */
<span class="lineNum">      91 </span>            :     raw_preposition_files,
<span class="lineNum">      92 </span>            :     raw_link_local_files
<span class="lineNum">      93 </span>            : };
<span class="lineNum">      94 </span>            : 
<span class="lineNum">      95 </span>            : static opal_list_t outbound_files;
<span class="lineNum">      96 </span>            : static opal_list_t incoming_files;
<span class="lineNum">      97 </span>            : static opal_list_t positioned_files;
<span class="lineNum">      98 </span>            : 
<span class="lineNum">      99 </span>            : static void send_chunk(int fd, short argc, void *cbdata);
<span class="lineNum">     100 </span>            : static void recv_files(int status, orte_process_name_t* sender,
<span class="lineNum">     101 </span>            :                        opal_buffer_t* buffer, orte_rml_tag_t tag,
<span class="lineNum">     102 </span>            :                        void* cbdata);
<span class="lineNum">     103 </span>            : static void recv_ack(int status, orte_process_name_t* sender,
<span class="lineNum">     104 </span>            :                      opal_buffer_t* buffer, orte_rml_tag_t tag,
<span class="lineNum">     105 </span>            :                      void* cbdata);
<a name="106"><span class="lineNum">     106 </span>            : static void write_handler(int fd, short event, void *cbdata);</a>
<span class="lineNum">     107 </span>            : 
<span class="lineNum">     108 </span><span class="lineCov">        299 : static int raw_init(void)</span>
<span class="lineNum">     109 </span>            : {
<span class="lineNum">     110 </span><span class="lineCov">        299 :     OBJ_CONSTRUCT(&amp;incoming_files, opal_list_t);</span>
<span class="lineNum">     111 </span>            : 
<span class="lineNum">     112 </span>            :     /* start a recv to catch any files sent to me */
<span class="lineNum">     113 </span><span class="lineCov">        299 :     orte_rml.recv_buffer_nb(ORTE_NAME_WILDCARD,</span>
<span class="lineNum">     114 </span>            :                             ORTE_RML_TAG_FILEM_BASE,
<span class="lineNum">     115 </span>            :                             ORTE_RML_PERSISTENT,
<span class="lineNum">     116 </span>            :                             recv_files,
<span class="lineNum">     117 </span>            :                             NULL);
<span class="lineNum">     118 </span>            : 
<span class="lineNum">     119 </span>            :     /* if I'm the HNP, start a recv to catch acks sent to me */
<span class="lineNum">     120 </span><span class="lineCov">        299 :     if (ORTE_PROC_IS_HNP) {</span>
<span class="lineNum">     121 </span><span class="lineCov">        299 :         OBJ_CONSTRUCT(&amp;outbound_files, opal_list_t);</span>
<span class="lineNum">     122 </span><span class="lineCov">        299 :         OBJ_CONSTRUCT(&amp;positioned_files, opal_list_t);</span>
<span class="lineNum">     123 </span><span class="lineCov">        299 :         orte_rml.recv_buffer_nb(ORTE_NAME_WILDCARD,</span>
<span class="lineNum">     124 </span>            :                                 ORTE_RML_TAG_FILEM_BASE_RESP,
<span class="lineNum">     125 </span>            :                                 ORTE_RML_PERSISTENT,
<span class="lineNum">     126 </span>            :                                 recv_ack,
<span class="lineNum">     127 </span>            :                                 NULL);
<span class="lineNum">     128 </span>            :     }
<span class="lineNum">     129 </span>            : 
<span class="lineNum">     130 </span><span class="lineCov">        299 :     return ORTE_SUCCESS;</span>
<a name="131"><span class="lineNum">     131 </span>            : }</a>
<span class="lineNum">     132 </span>            : 
<span class="lineNum">     133 </span><span class="lineCov">        299 : static int raw_finalize(void)</span>
<span class="lineNum">     134 </span>            : {
<span class="lineNum">     135 </span>            :     opal_list_item_t *item;
<span class="lineNum">     136 </span>            : 
<span class="lineNum">     137 </span><span class="lineCov">        299 :     orte_rml.recv_cancel(ORTE_NAME_WILDCARD, ORTE_RML_TAG_FILEM_BASE);</span>
<span class="lineNum">     138 </span><span class="lineCov">        598 :     while (NULL != (item = opal_list_remove_first(&amp;incoming_files))) {</span>
<span class="lineNum">     139 </span><span class="lineNoCov">          0 :         OBJ_RELEASE(item);</span>
<span class="lineNum">     140 </span>            :     }
<span class="lineNum">     141 </span><span class="lineCov">        299 :     OBJ_DESTRUCT(&amp;incoming_files);</span>
<span class="lineNum">     142 </span>            : 
<span class="lineNum">     143 </span><span class="lineCov">        299 :     if (ORTE_PROC_IS_HNP) {</span>
<span class="lineNum">     144 </span><span class="lineCov">        598 :         while (NULL != (item = opal_list_remove_first(&amp;outbound_files))) {</span>
<span class="lineNum">     145 </span><span class="lineNoCov">          0 :             OBJ_RELEASE(item);</span>
<span class="lineNum">     146 </span>            :         }
<span class="lineNum">     147 </span><span class="lineCov">        299 :         OBJ_DESTRUCT(&amp;outbound_files);</span>
<span class="lineNum">     148 </span><span class="lineCov">        598 :         while (NULL != (item = opal_list_remove_first(&amp;positioned_files))) {</span>
<span class="lineNum">     149 </span><span class="lineNoCov">          0 :             OBJ_RELEASE(item);</span>
<span class="lineNum">     150 </span>            :         }
<span class="lineNum">     151 </span><span class="lineCov">        299 :         OBJ_DESTRUCT(&amp;positioned_files);</span>
<span class="lineNum">     152 </span><span class="lineCov">        299 :         orte_rml.recv_cancel(ORTE_NAME_WILDCARD, ORTE_RML_TAG_FILEM_BASE_RESP);</span>
<span class="lineNum">     153 </span>            :     }
<span class="lineNum">     154 </span>            : 
<span class="lineNum">     155 </span><span class="lineCov">        299 :     return ORTE_SUCCESS;</span>
<a name="156"><span class="lineNum">     156 </span>            : }</a>
<span class="lineNum">     157 </span>            : 
<span class="lineNum">     158 </span><span class="lineNoCov">          0 : static int raw_put(orte_filem_base_request_t *req)</span>
<span class="lineNum">     159 </span>            : {
<span class="lineNum">     160 </span><span class="lineNoCov">          0 :     return ORTE_SUCCESS;</span>
<a name="161"><span class="lineNum">     161 </span>            : }</a>
<span class="lineNum">     162 </span>            : 
<span class="lineNum">     163 </span><span class="lineNoCov">          0 : static int raw_put_nb(orte_filem_base_request_t *req)</span>
<span class="lineNum">     164 </span>            : {
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :     return ORTE_SUCCESS;</span>
<a name="166"><span class="lineNum">     166 </span>            : }</a>
<span class="lineNum">     167 </span>            : 
<span class="lineNum">     168 </span><span class="lineNoCov">          0 : static int raw_get(orte_filem_base_request_t *req)</span>
<span class="lineNum">     169 </span>            : {
<span class="lineNum">     170 </span><span class="lineNoCov">          0 :     return ORTE_SUCCESS;</span>
<a name="171"><span class="lineNum">     171 </span>            : }</a>
<span class="lineNum">     172 </span>            : 
<span class="lineNum">     173 </span><span class="lineNoCov">          0 : static int raw_get_nb(orte_filem_base_request_t *req)</span>
<span class="lineNum">     174 </span>            : {
<span class="lineNum">     175 </span><span class="lineNoCov">          0 :     return ORTE_SUCCESS;</span>
<a name="176"><span class="lineNum">     176 </span>            : }</a>
<span class="lineNum">     177 </span>            : 
<span class="lineNum">     178 </span><span class="lineNoCov">          0 : static int raw_rm(orte_filem_base_request_t *req)</span>
<span class="lineNum">     179 </span>            : {
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :     return ORTE_SUCCESS;</span>
<a name="181"><span class="lineNum">     181 </span>            : }</a>
<span class="lineNum">     182 </span>            : 
<span class="lineNum">     183 </span><span class="lineNoCov">          0 : static int raw_rm_nb(orte_filem_base_request_t *req)</span>
<span class="lineNum">     184 </span>            : {
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :     return ORTE_SUCCESS;</span>
<a name="186"><span class="lineNum">     186 </span>            : }</a>
<span class="lineNum">     187 </span>            : 
<span class="lineNum">     188 </span><span class="lineNoCov">          0 : static int raw_wait(orte_filem_base_request_t *req)</span>
<span class="lineNum">     189 </span>            : {
<span class="lineNum">     190 </span><span class="lineNoCov">          0 :     return ORTE_SUCCESS;</span>
<a name="191"><span class="lineNum">     191 </span>            : }</a>
<span class="lineNum">     192 </span>            : 
<span class="lineNum">     193 </span><span class="lineNoCov">          0 : static int raw_wait_all(opal_list_t *reqs)</span>
<span class="lineNum">     194 </span>            : {
<span class="lineNum">     195 </span><span class="lineNoCov">          0 :     return ORTE_SUCCESS;</span>
<a name="196"><span class="lineNum">     196 </span>            : }</a>
<span class="lineNum">     197 </span>            : 
<span class="lineNum">     198 </span><span class="lineNoCov">          0 : static void xfer_complete(int status, orte_filem_raw_xfer_t *xfer)</span>
<span class="lineNum">     199 </span>            : {
<span class="lineNum">     200 </span><span class="lineNoCov">          0 :     orte_filem_raw_outbound_t *outbound = xfer-&gt;outbound;</span>
<span class="lineNum">     201 </span>            : 
<span class="lineNum">     202 </span>            :     /* transfer the status, if not success */
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :     if (ORTE_SUCCESS != status) {</span>
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :         outbound-&gt;status = status;</span>
<span class="lineNum">     205 </span>            :     }
<span class="lineNum">     206 </span>            : 
<span class="lineNum">     207 </span>            :     /* this transfer is complete - remove it from list */
<span class="lineNum">     208 </span><span class="lineNoCov">          0 :     opal_list_remove_item(&amp;outbound-&gt;xfers, &amp;xfer-&gt;super);</span>
<span class="lineNum">     209 </span>            :     /* add it to the list of files that have been positioned */
<span class="lineNum">     210 </span><span class="lineNoCov">          0 :     opal_list_append(&amp;positioned_files, &amp;xfer-&gt;super);</span>
<span class="lineNum">     211 </span>            : 
<span class="lineNum">     212 </span>            :     /* if the list is now empty, then the xfer is complete */
<span class="lineNum">     213 </span><span class="lineNoCov">          0 :     if (0 == opal_list_get_size(&amp;outbound-&gt;xfers)) {</span>
<span class="lineNum">     214 </span>            :         /* do the callback */
<span class="lineNum">     215 </span><span class="lineNoCov">          0 :         if (NULL != outbound-&gt;cbfunc) {</span>
<span class="lineNum">     216 </span><span class="lineNoCov">          0 :             outbound-&gt;cbfunc(outbound-&gt;status, outbound-&gt;cbdata);</span>
<span class="lineNum">     217 </span>            :         }
<span class="lineNum">     218 </span>            :         /* release the object */
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :         opal_list_remove_item(&amp;outbound_files, &amp;outbound-&gt;super);</span>
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :         OBJ_RELEASE(outbound);</span>
<span class="lineNum">     221 </span>            :     }
<a name="222"><span class="lineNum">     222 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     223 </span>            : 
<span class="lineNum">     224 </span><span class="lineNoCov">          0 : static void recv_ack(int status, orte_process_name_t* sender,</span>
<span class="lineNum">     225 </span>            :                      opal_buffer_t* buffer, orte_rml_tag_t tag,
<span class="lineNum">     226 </span>            :                      void* cbdata)
<span class="lineNum">     227 </span>            : {
<span class="lineNum">     228 </span>            :     opal_list_item_t *item, *itm;
<span class="lineNum">     229 </span>            :     orte_filem_raw_outbound_t *outbound;
<span class="lineNum">     230 </span>            :     orte_filem_raw_xfer_t *xfer;
<span class="lineNum">     231 </span>            :     char *file;
<span class="lineNum">     232 </span>            :     int st, n, rc;
<span class="lineNum">     233 </span>            : 
<span class="lineNum">     234 </span>            :     /* unpack the file */
<span class="lineNum">     235 </span><span class="lineNoCov">          0 :     n=1;</span>
<span class="lineNum">     236 </span><span class="lineNoCov">          0 :     if (OPAL_SUCCESS != (rc = opal_dss.unpack(buffer, &amp;file, &amp;n, OPAL_STRING))) {</span>
<span class="lineNum">     237 </span><span class="lineNoCov">          0 :         ORTE_ERROR_LOG(rc);</span>
<span class="lineNum">     238 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">     239 </span>            :     }
<span class="lineNum">     240 </span>            : 
<span class="lineNum">     241 </span>            :     /* unpack the status */
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :     n=1;</span>
<span class="lineNum">     243 </span><span class="lineNoCov">          0 :     if (OPAL_SUCCESS != (rc = opal_dss.unpack(buffer, &amp;st, &amp;n, OPAL_INT))) {</span>
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :         ORTE_ERROR_LOG(rc);</span>
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">     246 </span>            :     }
<span class="lineNum">     247 </span>            : 
<span class="lineNum">     248 </span><span class="lineNoCov">          0 :     OPAL_OUTPUT_VERBOSE((1, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">     249 </span>            :                          &quot;%s filem:raw: recvd ack from %s for file %s status %d&quot;,
<span class="lineNum">     250 </span>            :                          ORTE_NAME_PRINT(ORTE_PROC_MY_NAME),
<span class="lineNum">     251 </span>            :                          ORTE_NAME_PRINT(sender), file, st));
<span class="lineNum">     252 </span>            : 
<span class="lineNum">     253 </span>            :     /* find the corresponding outbound object */
<span class="lineNum">     254 </span><span class="lineNoCov">          0 :     for (item = opal_list_get_first(&amp;outbound_files);</span>
<span class="lineNum">     255 </span><span class="lineNoCov">          0 :          item != opal_list_get_end(&amp;outbound_files);</span>
<span class="lineNum">     256 </span><span class="lineNoCov">          0 :          item = opal_list_get_next(item)) {</span>
<span class="lineNum">     257 </span><span class="lineNoCov">          0 :         outbound = (orte_filem_raw_outbound_t*)item;</span>
<span class="lineNum">     258 </span><span class="lineNoCov">          0 :         for (itm = opal_list_get_first(&amp;outbound-&gt;xfers);</span>
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :              itm != opal_list_get_end(&amp;outbound-&gt;xfers);</span>
<span class="lineNum">     260 </span><span class="lineNoCov">          0 :              itm = opal_list_get_next(itm)) {</span>
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :             xfer = (orte_filem_raw_xfer_t*)itm;</span>
<span class="lineNum">     262 </span><span class="lineNoCov">          0 :             if (0 == strcmp(file, xfer-&gt;file)) {</span>
<span class="lineNum">     263 </span>            :                 /* if the status isn't success, record it */
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :                 if (0 != st) {</span>
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :                     xfer-&gt;status = st;</span>
<span class="lineNum">     266 </span>            :                 }
<span class="lineNum">     267 </span>            :                 /* track number of respondents */
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :                 xfer-&gt;nrecvd++;</span>
<span class="lineNum">     269 </span>            :                 /* if all daemons have responded, then this is complete */
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :                 if (xfer-&gt;nrecvd == orte_process_info.num_procs) {</span>
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :                     OPAL_OUTPUT_VERBOSE((1, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">     272 </span>            :                                          &quot;%s filem:raw: xfer complete for file %s status %d&quot;,
<span class="lineNum">     273 </span>            :                                          ORTE_NAME_PRINT(ORTE_PROC_MY_NAME),
<span class="lineNum">     274 </span>            :                                          file, xfer-&gt;status));
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :                     xfer_complete(xfer-&gt;status, xfer);</span>
<span class="lineNum">     276 </span>            :                 }
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :                 free(file);</span>
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     279 </span>            :             }
<span class="lineNum">     280 </span>            :         }
<span class="lineNum">     281 </span>            :     }
<a name="282"><span class="lineNum">     282 </span>            : }</a>
<span class="lineNum">     283 </span>            : 
<span class="lineNum">     284 </span><span class="lineCov">       2673 : static int raw_preposition_files(orte_job_t *jdata,</span>
<span class="lineNum">     285 </span>            :                                  orte_filem_completion_cbfunc_t cbfunc,
<span class="lineNum">     286 </span>            :                                  void *cbdata)
<span class="lineNum">     287 </span>            : {
<span class="lineNum">     288 </span>            :     orte_app_context_t *app;
<span class="lineNum">     289 </span>            :     opal_list_item_t *item, *itm, *itm2;
<span class="lineNum">     290 </span>            :     orte_filem_base_file_set_t *fs;
<span class="lineNum">     291 </span>            :     int fd;
<span class="lineNum">     292 </span>            :     orte_filem_raw_xfer_t *xfer, *xptr;
<span class="lineNum">     293 </span>            :     int flags, i, j;
<span class="lineNum">     294 </span><span class="lineCov">       2673 :     char **files=NULL;</span>
<span class="lineNum">     295 </span>            :     orte_filem_raw_outbound_t *outbound, *optr;
<span class="lineNum">     296 </span>            :     char *cptr, *nxt, *filestring;
<span class="lineNum">     297 </span>            :     opal_list_t fsets;
<span class="lineNum">     298 </span>            :     bool already_sent;
<span class="lineNum">     299 </span>            : 
<span class="lineNum">     300 </span><span class="lineCov">       2673 :     OPAL_OUTPUT_VERBOSE((1, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">     301 </span>            :                          &quot;%s filem:raw: preposition files for job %s&quot;,
<span class="lineNum">     302 </span>            :                          ORTE_NAME_PRINT(ORTE_PROC_MY_NAME),
<span class="lineNum">     303 </span>            :                          ORTE_JOBID_PRINT(jdata-&gt;jobid)));
<span class="lineNum">     304 </span>            : 
<span class="lineNum">     305 </span>            :     /* cycle across the app_contexts looking for files or
<span class="lineNum">     306 </span>            :      * binaries to be prepositioned
<span class="lineNum">     307 </span>            :      */
<span class="lineNum">     308 </span><span class="lineCov">       2673 :     OBJ_CONSTRUCT(&amp;fsets, opal_list_t);</span>
<span class="lineNum">     309 </span><span class="lineCov">       5347 :     for (i=0; i &lt; jdata-&gt;apps-&gt;size; i++) {</span>
<span class="lineNum">     310 </span><span class="lineCov">       2674 :         if (NULL == (app = (orte_app_context_t*)opal_pointer_array_get_item(jdata-&gt;apps, i))) {</span>
<span class="lineNum">     311 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">     312 </span>            :         }
<span class="lineNum">     313 </span><span class="lineCov">       2674 :         if (orte_get_attribute(&amp;app-&gt;attributes, ORTE_APP_PRELOAD_BIN, NULL, OPAL_BOOL)) {</span>
<span class="lineNum">     314 </span>            :             /* add the executable to our list */
<span class="lineNum">     315 </span><span class="lineNoCov">          0 :             OPAL_OUTPUT_VERBOSE((1, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">     316 </span>            :                                  &quot;%s filem:raw: preload executable %s&quot;,
<span class="lineNum">     317 </span>            :                                  ORTE_NAME_PRINT(ORTE_PROC_MY_NAME),
<span class="lineNum">     318 </span>            :                                  app-&gt;app));
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :             fs = OBJ_NEW(orte_filem_base_file_set_t);</span>
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :             fs-&gt;local_target = strdup(app-&gt;app);</span>
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :             fs-&gt;target_flag = ORTE_FILEM_TYPE_EXE;</span>
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :             opal_list_append(&amp;fsets, &amp;fs-&gt;super);</span>
<span class="lineNum">     323 </span>            :             /* if we are preloading the binary, then the app must be in relative
<span class="lineNum">     324 </span>            :              * syntax or we won't find it - the binary will be positioned in the
<span class="lineNum">     325 </span>            :              * session dir, so ensure the app is relative to that location
<span class="lineNum">     326 </span>            :              */
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :             cptr = opal_basename(app-&gt;app);</span>
<span class="lineNum">     328 </span><span class="lineNoCov">          0 :             free(app-&gt;app);</span>
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :             asprintf(&amp;app-&gt;app, &quot;./%s&quot;, cptr);</span>
<span class="lineNum">     330 </span><span class="lineNoCov">          0 :             free(app-&gt;argv[0]);</span>
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :             app-&gt;argv[0] = strdup(app-&gt;app);</span>
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :             fs-&gt;remote_target = strdup(app-&gt;app);</span>
<span class="lineNum">     333 </span>            :         }
<span class="lineNum">     334 </span><span class="lineCov">       2674 :         if (orte_get_attribute(&amp;app-&gt;attributes, ORTE_APP_PRELOAD_FILES, (void**)&amp;filestring, OPAL_STRING)) {</span>
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :             files = opal_argv_split(filestring, ',');</span>
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :             free(filestring);</span>
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :             for (j=0; NULL != files[j]; j++) {</span>
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :                 fs = OBJ_NEW(orte_filem_base_file_set_t);</span>
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :                 fs-&gt;local_target = strdup(files[j]);</span>
<span class="lineNum">     340 </span>            :                 /* check any suffix for file type */
<span class="lineNum">     341 </span><span class="lineNoCov">          0 :                 if (NULL != (cptr = strchr(files[j], '.'))) {</span>
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :                     if (0 == strncmp(cptr, &quot;.tar&quot;, 4)) {</span>
<span class="lineNum">     343 </span><span class="lineNoCov">          0 :                         OPAL_OUTPUT_VERBOSE((1, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">     344 </span>            :                                              &quot;%s filem:raw: marking file %s as TAR&quot;,
<span class="lineNum">     345 </span>            :                                              ORTE_NAME_PRINT(ORTE_PROC_MY_NAME),
<span class="lineNum">     346 </span>            :                                              files[j]));
<span class="lineNum">     347 </span><span class="lineNoCov">          0 :                         fs-&gt;target_flag = ORTE_FILEM_TYPE_TAR;</span>
<span class="lineNum">     348 </span><span class="lineNoCov">          0 :                     } else if (0 == strncmp(cptr, &quot;.bz&quot;, 3)) {</span>
<span class="lineNum">     349 </span><span class="lineNoCov">          0 :                         OPAL_OUTPUT_VERBOSE((1, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">     350 </span>            :                                              &quot;%s filem:raw: marking file %s as BZIP&quot;,
<span class="lineNum">     351 </span>            :                                              ORTE_NAME_PRINT(ORTE_PROC_MY_NAME),
<span class="lineNum">     352 </span>            :                                              files[j]));
<span class="lineNum">     353 </span><span class="lineNoCov">          0 :                         fs-&gt;target_flag = ORTE_FILEM_TYPE_BZIP;</span>
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :                     } else if (0 == strncmp(cptr, &quot;.gz&quot;, 3)) {</span>
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :                         OPAL_OUTPUT_VERBOSE((1, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">     356 </span>            :                                              &quot;%s filem:raw: marking file %s as GZIP&quot;,
<span class="lineNum">     357 </span>            :                                              ORTE_NAME_PRINT(ORTE_PROC_MY_NAME),
<span class="lineNum">     358 </span>            :                                              files[j]));
<span class="lineNum">     359 </span><span class="lineNoCov">          0 :                         fs-&gt;target_flag = ORTE_FILEM_TYPE_GZIP;</span>
<span class="lineNum">     360 </span>            :                     } else {
<span class="lineNum">     361 </span><span class="lineNoCov">          0 :                         fs-&gt;target_flag = ORTE_FILEM_TYPE_FILE;</span>
<span class="lineNum">     362 </span>            :                     }
<span class="lineNum">     363 </span>            :                 } else {
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :                     fs-&gt;target_flag = ORTE_FILEM_TYPE_FILE;</span>
<span class="lineNum">     365 </span>            :                 }
<span class="lineNum">     366 </span>            :                 /* if we are flattening directory trees, then the
<span class="lineNum">     367 </span>            :                  * remote path is just the basename file name
<span class="lineNum">     368 </span>            :                  */
<span class="lineNum">     369 </span><span class="lineNoCov">          0 :                 if (orte_filem_raw_flatten_trees) {</span>
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :                     fs-&gt;remote_target = opal_basename(files[j]);</span>
<span class="lineNum">     371 </span>            :                 } else {
<span class="lineNum">     372 </span>            :                     /* if this was an absolute path, then we need
<span class="lineNum">     373 </span>            :                      * to convert it to a relative path - we do not
<span class="lineNum">     374 </span>            :                      * allow positioning of files to absolute locations
<span class="lineNum">     375 </span>            :                      * due to the potential for unintentional overwriting
<span class="lineNum">     376 </span>            :                      * of files
<span class="lineNum">     377 </span>            :                      */
<span class="lineNum">     378 </span><span class="lineNoCov">          0 :                     if (opal_path_is_absolute(files[j])) {</span>
<span class="lineNum">     379 </span><span class="lineNoCov">          0 :                         fs-&gt;remote_target = strdup(&amp;files[j][1]);</span>
<span class="lineNum">     380 </span>            :                     } else {
<span class="lineNum">     381 </span><span class="lineNoCov">          0 :                         fs-&gt;remote_target = strdup(files[j]);</span>
<span class="lineNum">     382 </span>            :                     }
<span class="lineNum">     383 </span>            :                 }
<span class="lineNum">     384 </span><span class="lineNoCov">          0 :                 opal_list_append(&amp;fsets, &amp;fs-&gt;super);</span>
<span class="lineNum">     385 </span>            :                 /* prep the filename for matching on the remote
<span class="lineNum">     386 </span>            :                  * end by stripping any leading '.' directories to avoid
<span class="lineNum">     387 </span>            :                  * stepping above the session dir location - all
<span class="lineNum">     388 </span>            :                  * files will be relative to that point. Ensure
<span class="lineNum">     389 </span>            :                  * we *don't* mistakenly strip the dot from a
<span class="lineNum">     390 </span>            :                  * filename that starts with one
<span class="lineNum">     391 </span>            :                  */
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :                 cptr = fs-&gt;remote_target;</span>
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :                 nxt = cptr;</span>
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :                 nxt++;</span>
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :                 while ('\0' != *cptr) {</span>
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :                     if ('.' == *cptr) {</span>
<span class="lineNum">     397 </span>            :                         /* have to check the next character to
<span class="lineNum">     398 </span>            :                          * see if it's a dotfile or not
<span class="lineNum">     399 </span>            :                          */
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :                         if ('.' == *nxt || '/' == *nxt) {</span>
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :                             cptr = nxt;</span>
<span class="lineNum">     402 </span><span class="lineNoCov">          0 :                             nxt++;</span>
<span class="lineNum">     403 </span>            :                         } else {
<span class="lineNum">     404 </span>            :                             /* if the next character isn't a dot
<span class="lineNum">     405 </span>            :                              * or a slash, then this is a dot-file
<span class="lineNum">     406 </span>            :                              * and we need to leave it alone
<span class="lineNum">     407 </span>            :                              */
<span class="lineNum">     408 </span>            :                             break;
<span class="lineNum">     409 </span>            :                         }
<span class="lineNum">     410 </span><span class="lineNoCov">          0 :                     } else if ('/' == *cptr) {</span>
<span class="lineNum">     411 </span>            :                         /* move to the next character */
<span class="lineNum">     412 </span><span class="lineNoCov">          0 :                         cptr = nxt;</span>
<span class="lineNum">     413 </span><span class="lineNoCov">          0 :                         nxt++;</span>
<span class="lineNum">     414 </span>            :                     } else {
<span class="lineNum">     415 </span>            :                         /* the character isn't a dot or a slash,
<span class="lineNum">     416 </span>            :                          * so this is the beginning of the filename
<span class="lineNum">     417 </span>            :                          */
<span class="lineNum">     418 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">     419 </span>            :                     }
<span class="lineNum">     420 </span>            :                 }
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :                 free(files[j]);</span>
<span class="lineNum">     422 </span><span class="lineNoCov">          0 :                 files[j] = strdup(cptr);</span>
<span class="lineNum">     423 </span>            :             }
<span class="lineNum">     424 </span>            :             /* replace the app's file list with the revised one so we
<span class="lineNum">     425 </span>            :              * can find them on the remote end
<span class="lineNum">     426 </span>            :              */
<span class="lineNum">     427 </span><span class="lineNoCov">          0 :             filestring = opal_argv_join(files, ',');</span>
<span class="lineNum">     428 </span><span class="lineNoCov">          0 :             orte_set_attribute(&amp;app-&gt;attributes, ORTE_APP_PRELOAD_FILES, ORTE_ATTR_GLOBAL, filestring, OPAL_STRING);</span>
<span class="lineNum">     429 </span>            :             /* cleanup for the next app */
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :             opal_argv_free(files);</span>
<span class="lineNum">     431 </span><span class="lineNoCov">          0 :             free(filestring);</span>
<span class="lineNum">     432 </span>            :         }
<span class="lineNum">     433 </span>            :     }
<span class="lineNum">     434 </span><span class="lineCov">       2673 :     if (0 == opal_list_get_size(&amp;fsets)) {</span>
<span class="lineNum">     435 </span>            :         /* nothing to preposition */
<span class="lineNum">     436 </span><span class="lineCov">       2673 :         OPAL_OUTPUT_VERBOSE((1, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">     437 </span>            :                              &quot;%s filem:raw: nothing to preposition&quot;,
<span class="lineNum">     438 </span>            :                              ORTE_NAME_PRINT(ORTE_PROC_MY_NAME)));
<span class="lineNum">     439 </span><span class="lineCov">       2673 :         if (NULL != cbfunc) {</span>
<span class="lineNum">     440 </span><span class="lineCov">       2673 :             cbfunc(ORTE_SUCCESS, cbdata);</span>
<span class="lineNum">     441 </span>            :         }
<span class="lineNum">     442 </span><span class="lineCov">       2673 :         OBJ_DESTRUCT(&amp;fsets);</span>
<span class="lineNum">     443 </span><span class="lineCov">       2673 :         return ORTE_SUCCESS;</span>
<span class="lineNum">     444 </span>            :     }
<span class="lineNum">     445 </span>            : 
<span class="lineNum">     446 </span><span class="lineNoCov">          0 :     OPAL_OUTPUT_VERBOSE((1, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">     447 </span>            :                          &quot;%s filem:raw: found %d files to position&quot;,
<span class="lineNum">     448 </span>            :                          ORTE_NAME_PRINT(ORTE_PROC_MY_NAME),
<span class="lineNum">     449 </span>            :                          (int)opal_list_get_size(&amp;fsets)));
<span class="lineNum">     450 </span>            : 
<span class="lineNum">     451 </span>            :     /* track the outbound file sets */
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :     outbound = OBJ_NEW(orte_filem_raw_outbound_t);</span>
<span class="lineNum">     453 </span><span class="lineNoCov">          0 :     outbound-&gt;cbfunc = cbfunc;</span>
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :     outbound-&gt;cbdata = cbdata;</span>
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :     opal_list_append(&amp;outbound_files, &amp;outbound-&gt;super);</span>
<span class="lineNum">     456 </span>            : 
<span class="lineNum">     457 </span>            :     /* only the HNP should ever call this function - loop thru the
<span class="lineNum">     458 </span>            :      * fileset and initiate xcast transfer of each file to every
<span class="lineNum">     459 </span>            :      * daemon
<span class="lineNum">     460 </span>            :      */
<span class="lineNum">     461 </span><span class="lineNoCov">          0 :     while (NULL != (item = opal_list_remove_first(&amp;fsets))) {</span>
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :         fs = (orte_filem_base_file_set_t*)item;</span>
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :         OPAL_OUTPUT_VERBOSE((1, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">     464 </span>            :                              &quot;%s filem:raw: checking prepositioning of file %s&quot;,
<span class="lineNum">     465 </span>            :                              ORTE_NAME_PRINT(ORTE_PROC_MY_NAME),
<span class="lineNum">     466 </span>            :                              fs-&gt;local_target));
<span class="lineNum">     467 </span>            : 
<span class="lineNum">     468 </span>            :         /* have we already sent this file? */
<span class="lineNum">     469 </span><span class="lineNoCov">          0 :         already_sent = false;</span>
<span class="lineNum">     470 </span><span class="lineNoCov">          0 :         for (itm = opal_list_get_first(&amp;positioned_files);</span>
<span class="lineNum">     471 </span><span class="lineNoCov">          0 :              !already_sent &amp;&amp; itm != opal_list_get_end(&amp;positioned_files);</span>
<span class="lineNum">     472 </span><span class="lineNoCov">          0 :              itm = opal_list_get_next(itm)) {</span>
<span class="lineNum">     473 </span><span class="lineNoCov">          0 :             xptr = (orte_filem_raw_xfer_t*)itm;</span>
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :             if (0 == strcmp(fs-&gt;local_target, xptr-&gt;src)) {</span>
<span class="lineNum">     475 </span><span class="lineNoCov">          0 :                 already_sent = true;</span>
<span class="lineNum">     476 </span>            :             }
<span class="lineNum">     477 </span>            :         }
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :         if (already_sent) {</span>
<span class="lineNum">     479 </span>            :             /* no need to send it again */
<span class="lineNum">     480 </span><span class="lineNoCov">          0 :             OPAL_OUTPUT_VERBOSE((3, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">     481 </span>            :                                  &quot;%s filem:raw: file %s is already in position - ignoring&quot;,
<span class="lineNum">     482 </span>            :                                  ORTE_NAME_PRINT(ORTE_PROC_MY_NAME), fs-&gt;local_target));
<span class="lineNum">     483 </span><span class="lineNoCov">          0 :             OBJ_RELEASE(item);</span>
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">     485 </span>            :         }
<span class="lineNum">     486 </span>            :         /* also have to check if this file is already in the process
<span class="lineNum">     487 </span>            :          * of being transferred, or was included multiple times
<span class="lineNum">     488 </span>            :          * for transfer
<span class="lineNum">     489 </span>            :          */
<span class="lineNum">     490 </span><span class="lineNoCov">          0 :         for (itm = opal_list_get_first(&amp;outbound_files);</span>
<span class="lineNum">     491 </span><span class="lineNoCov">          0 :              !already_sent &amp;&amp; itm != opal_list_get_end(&amp;outbound_files);</span>
<span class="lineNum">     492 </span><span class="lineNoCov">          0 :              itm = opal_list_get_next(itm)) {</span>
<span class="lineNum">     493 </span><span class="lineNoCov">          0 :             optr = (orte_filem_raw_outbound_t*)itm;</span>
<span class="lineNum">     494 </span><span class="lineNoCov">          0 :             for (itm2 = opal_list_get_first(&amp;optr-&gt;xfers);</span>
<span class="lineNum">     495 </span><span class="lineNoCov">          0 :                  itm2 != opal_list_get_end(&amp;optr-&gt;xfers);</span>
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :                  itm2 = opal_list_get_next(itm2)) {</span>
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :                 xptr = (orte_filem_raw_xfer_t*)itm2;</span>
<span class="lineNum">     498 </span><span class="lineNoCov">          0 :                 if (0 == strcmp(fs-&gt;local_target, xptr-&gt;src)) {</span>
<span class="lineNum">     499 </span><span class="lineNoCov">          0 :                     already_sent = true;</span>
<span class="lineNum">     500 </span>            :                 }
<span class="lineNum">     501 </span>            :             }
<span class="lineNum">     502 </span>            :         }
<span class="lineNum">     503 </span><span class="lineNoCov">          0 :         if (already_sent) {</span>
<span class="lineNum">     504 </span>            :             /* no need to send it again */
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :             OPAL_OUTPUT_VERBOSE((3, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">     506 </span>            :                                  &quot;%s filem:raw: file %s is already queued for output - ignoring&quot;,
<span class="lineNum">     507 </span>            :                                  ORTE_NAME_PRINT(ORTE_PROC_MY_NAME), fs-&gt;local_target));
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :             OBJ_RELEASE(item);</span>
<span class="lineNum">     509 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">     510 </span>            :         }
<span class="lineNum">     511 </span>            : 
<span class="lineNum">     512 </span>            :         /* attempt to open the specified file */
<span class="lineNum">     513 </span><span class="lineNoCov">          0 :         if (0 &gt; (fd = open(fs-&gt;local_target, O_RDONLY))) {</span>
<span class="lineNum">     514 </span><span class="lineNoCov">          0 :             opal_output(0, &quot;%s CANNOT ACCESS FILE %s&quot;,</span>
<span class="lineNum">     515 </span>            :                         ORTE_NAME_PRINT(ORTE_PROC_MY_NAME), fs-&gt;local_target);
<span class="lineNum">     516 </span><span class="lineNoCov">          0 :             OBJ_RELEASE(item);</span>
<span class="lineNum">     517 </span><span class="lineNoCov">          0 :             opal_list_remove_item(&amp;outbound_files, &amp;outbound-&gt;super);</span>
<span class="lineNum">     518 </span><span class="lineNoCov">          0 :             OBJ_RELEASE(outbound);</span>
<span class="lineNum">     519 </span><span class="lineNoCov">          0 :             return ORTE_ERROR;</span>
<span class="lineNum">     520 </span>            :         }
<span class="lineNum">     521 </span>            :         /* set the flags to non-blocking */
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :         if ((flags = fcntl(fd, F_GETFL, 0)) &lt; 0) {</span>
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :             opal_output(orte_filem_base_framework.framework_output, &quot;[%s:%d]: fcntl(F_GETFL) failed with errno=%d\n&quot;,</span>
<span class="lineNum">     524 </span><span class="lineNoCov">          0 :                         __FILE__, __LINE__, errno);</span>
<span class="lineNum">     525 </span>            :         } else {
<span class="lineNum">     526 </span><span class="lineNoCov">          0 :             flags |= O_NONBLOCK;</span>
<span class="lineNum">     527 </span><span class="lineNoCov">          0 :             if (fcntl(fd, F_SETFL, flags) &lt; 0) {</span>
<span class="lineNum">     528 </span><span class="lineNoCov">          0 :                 opal_output(orte_filem_base_framework.framework_output, &quot;[%s:%d]: fcntl(F_GETFL) failed with errno=%d\n&quot;,</span>
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :                             __FILE__, __LINE__, errno);</span>
<span class="lineNum">     530 </span>            :             }
<span class="lineNum">     531 </span>            :         }
<span class="lineNum">     532 </span><span class="lineNoCov">          0 :         OPAL_OUTPUT_VERBOSE((1, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">     533 </span>            :                              &quot;%s filem:raw: setting up to position file %s&quot;,
<span class="lineNum">     534 </span>            :                              ORTE_NAME_PRINT(ORTE_PROC_MY_NAME), fs-&gt;local_target));
<span class="lineNum">     535 </span><span class="lineNoCov">          0 :         xfer = OBJ_NEW(orte_filem_raw_xfer_t);</span>
<span class="lineNum">     536 </span>            :         /* save the source so we can avoid duplicate transfers */
<span class="lineNum">     537 </span><span class="lineNoCov">          0 :         xfer-&gt;src = strdup(fs-&gt;local_target);</span>
<span class="lineNum">     538 </span>            :         /* strip any leading '.' directories to avoid
<span class="lineNum">     539 </span>            :          * stepping above the session dir location - all
<span class="lineNum">     540 </span>            :          * files will be relative to that point. Ensure
<span class="lineNum">     541 </span>            :          * we *don't* mistakenly strip the dot from a
<span class="lineNum">     542 </span>            :          * filename that starts with one
<span class="lineNum">     543 </span>            :          */
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :         cptr = fs-&gt;remote_target;</span>
<span class="lineNum">     545 </span><span class="lineNoCov">          0 :         nxt = cptr;</span>
<span class="lineNum">     546 </span><span class="lineNoCov">          0 :         nxt++;</span>
<span class="lineNum">     547 </span><span class="lineNoCov">          0 :         while ('\0' != *cptr) {</span>
<span class="lineNum">     548 </span><span class="lineNoCov">          0 :             if ('.' == *cptr) {</span>
<span class="lineNum">     549 </span>            :                 /* have to check the next character to
<span class="lineNum">     550 </span>            :                  * see if it's a dotfile or not
<span class="lineNum">     551 </span>            :                  */
<span class="lineNum">     552 </span><span class="lineNoCov">          0 :                 if ('.' == *nxt || '/' == *nxt) {</span>
<span class="lineNum">     553 </span><span class="lineNoCov">          0 :                     cptr = nxt;</span>
<span class="lineNum">     554 </span><span class="lineNoCov">          0 :                     nxt++;</span>
<span class="lineNum">     555 </span>            :                 } else {
<span class="lineNum">     556 </span>            :                     /* if the next character isn't a dot
<span class="lineNum">     557 </span>            :                      * or a slash, then this is a dot-file
<span class="lineNum">     558 </span>            :                      * and we need to leave it alone
<span class="lineNum">     559 </span>            :                      */
<span class="lineNum">     560 </span>            :                     break;
<span class="lineNum">     561 </span>            :                 }
<span class="lineNum">     562 </span><span class="lineNoCov">          0 :             } else if ('/' == *cptr) {</span>
<span class="lineNum">     563 </span>            :                 /* move to the next character */
<span class="lineNum">     564 </span><span class="lineNoCov">          0 :                 cptr = nxt;</span>
<span class="lineNum">     565 </span><span class="lineNoCov">          0 :                 nxt++;</span>
<span class="lineNum">     566 </span>            :             } else {
<span class="lineNum">     567 </span>            :                 /* the character isn't a dot or a slash,
<span class="lineNum">     568 </span>            :                  * so this is the beginning of the filename
<span class="lineNum">     569 </span>            :                  */
<span class="lineNum">     570 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     571 </span>            :             }
<span class="lineNum">     572 </span>            :         }
<span class="lineNum">     573 </span><span class="lineNoCov">          0 :         xfer-&gt;file = strdup(cptr);</span>
<span class="lineNum">     574 </span><span class="lineNoCov">          0 :         xfer-&gt;type = fs-&gt;target_flag;</span>
<span class="lineNum">     575 </span><span class="lineNoCov">          0 :         xfer-&gt;app_idx = fs-&gt;app_idx;</span>
<span class="lineNum">     576 </span><span class="lineNoCov">          0 :         xfer-&gt;outbound = outbound;</span>
<span class="lineNum">     577 </span><span class="lineNoCov">          0 :         opal_list_append(&amp;outbound-&gt;xfers, &amp;xfer-&gt;super);</span>
<span class="lineNum">     578 </span><span class="lineNoCov">          0 :         opal_event_set(orte_event_base, &amp;xfer-&gt;ev, fd, OPAL_EV_READ, send_chunk, xfer);</span>
<span class="lineNum">     579 </span><span class="lineNoCov">          0 :         opal_event_set_priority(&amp;xfer-&gt;ev, ORTE_MSG_PRI);</span>
<span class="lineNum">     580 </span><span class="lineNoCov">          0 :         opal_event_add(&amp;xfer-&gt;ev, 0);</span>
<span class="lineNum">     581 </span><span class="lineNoCov">          0 :         xfer-&gt;pending = true;</span>
<span class="lineNum">     582 </span><span class="lineNoCov">          0 :         OBJ_RELEASE(item);</span>
<span class="lineNum">     583 </span>            :     }
<span class="lineNum">     584 </span><span class="lineNoCov">          0 :     OBJ_DESTRUCT(&amp;fsets);</span>
<span class="lineNum">     585 </span>            : 
<span class="lineNum">     586 </span>            :     /* check to see if anything remains to be sent - if everything
<span class="lineNum">     587 </span>            :      * is a duplicate, then the list will be empty
<span class="lineNum">     588 </span>            :      */
<span class="lineNum">     589 </span><span class="lineNoCov">          0 :     if (0 == opal_list_get_size(&amp;outbound-&gt;xfers)) {</span>
<span class="lineNum">     590 </span><span class="lineNoCov">          0 :         OPAL_OUTPUT_VERBOSE((1, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">     591 </span>            :                              &quot;%s filem:raw: all duplicate files - no positioning reqd&quot;,
<span class="lineNum">     592 </span>            :                              ORTE_NAME_PRINT(ORTE_PROC_MY_NAME)));
<span class="lineNum">     593 </span><span class="lineNoCov">          0 :         opal_list_remove_item(&amp;outbound_files, &amp;outbound-&gt;super);</span>
<span class="lineNum">     594 </span><span class="lineNoCov">          0 :         OBJ_RELEASE(outbound);</span>
<span class="lineNum">     595 </span><span class="lineNoCov">          0 :         if (NULL != cbfunc) {</span>
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :             cbfunc(ORTE_SUCCESS, cbdata);</span>
<span class="lineNum">     597 </span>            :         }
<span class="lineNum">     598 </span><span class="lineNoCov">          0 :         return ORTE_SUCCESS;</span>
<span class="lineNum">     599 </span>            :     }
<span class="lineNum">     600 </span>            : 
<span class="lineNum">     601 </span><span class="lineNoCov">          0 :     if (0 &lt; opal_output_get_verbosity(orte_filem_base_framework.framework_output)) {</span>
<span class="lineNum">     602 </span><span class="lineNoCov">          0 :         opal_output(0, &quot;%s Files to be positioned:&quot;, ORTE_NAME_PRINT(ORTE_PROC_MY_NAME));</span>
<span class="lineNum">     603 </span><span class="lineNoCov">          0 :         for (itm2 = opal_list_get_first(&amp;outbound-&gt;xfers);</span>
<span class="lineNum">     604 </span><span class="lineNoCov">          0 :              itm2 != opal_list_get_end(&amp;outbound-&gt;xfers);</span>
<span class="lineNum">     605 </span><span class="lineNoCov">          0 :              itm2 = opal_list_get_next(itm2)) {</span>
<span class="lineNum">     606 </span><span class="lineNoCov">          0 :             xptr = (orte_filem_raw_xfer_t*)itm2;</span>
<span class="lineNum">     607 </span><span class="lineNoCov">          0 :             opal_output(0, &quot;%s\t%s&quot;, ORTE_NAME_PRINT(ORTE_PROC_MY_NAME), xptr-&gt;src);</span>
<span class="lineNum">     608 </span>            :         }
<span class="lineNum">     609 </span>            :     }
<span class="lineNum">     610 </span>            : 
<span class="lineNum">     611 </span><span class="lineNoCov">          0 :     return ORTE_SUCCESS;</span>
<a name="612"><span class="lineNum">     612 </span>            : }</a>
<span class="lineNum">     613 </span>            : 
<span class="lineNum">     614 </span><span class="lineNoCov">          0 : static int create_link(char *my_dir, char *path,</span>
<span class="lineNum">     615 </span>            :                        char *link_pt)
<span class="lineNum">     616 </span>            : {
<span class="lineNum">     617 </span>            :     char *mypath, *fullname, *basedir;
<span class="lineNum">     618 </span>            :     struct stat buf;
<span class="lineNum">     619 </span><span class="lineNoCov">          0 :     int rc = ORTE_SUCCESS;</span>
<span class="lineNum">     620 </span>            : 
<span class="lineNum">     621 </span>            :     /* form the full source path name */
<span class="lineNum">     622 </span><span class="lineNoCov">          0 :     mypath = opal_os_path(false, my_dir, link_pt, NULL);</span>
<span class="lineNum">     623 </span>            :     /* form the full target path name */
<span class="lineNum">     624 </span><span class="lineNoCov">          0 :     fullname = opal_os_path(false, path, link_pt, NULL);</span>
<span class="lineNum">     625 </span>            :     /* there may have been multiple files placed under the
<span class="lineNum">     626 </span>            :      * same directory, so check for existence first
<span class="lineNum">     627 </span>            :      */
<span class="lineNum">     628 </span><span class="lineNoCov">          0 :     if (0 != stat(fullname, &amp;buf)) {</span>
<span class="lineNum">     629 </span><span class="lineNoCov">          0 :         OPAL_OUTPUT_VERBOSE((1, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">     630 </span>            :                              &quot;%s filem:raw: creating symlink to %s\n\tmypath: %s\n\tlink: %s&quot;,
<span class="lineNum">     631 </span>            :                              ORTE_NAME_PRINT(ORTE_PROC_MY_NAME), link_pt,
<span class="lineNum">     632 </span>            :                              mypath, fullname));
<span class="lineNum">     633 </span>            :         /* create any required path to the link location */
<span class="lineNum">     634 </span><span class="lineNoCov">          0 :         basedir = opal_dirname(fullname);</span>
<span class="lineNum">     635 </span><span class="lineNoCov">          0 :         if (OPAL_SUCCESS != (rc = opal_os_dirpath_create(basedir, S_IRWXU))) {</span>
<span class="lineNum">     636 </span><span class="lineNoCov">          0 :             ORTE_ERROR_LOG(rc);</span>
<span class="lineNum">     637 </span><span class="lineNoCov">          0 :             opal_output(0, &quot;%s Failed to symlink %s to %s&quot;,</span>
<span class="lineNum">     638 </span>            :                         ORTE_NAME_PRINT(ORTE_PROC_MY_NAME), mypath, fullname);
<span class="lineNum">     639 </span><span class="lineNoCov">          0 :             free(basedir);</span>
<span class="lineNum">     640 </span><span class="lineNoCov">          0 :             free(mypath);</span>
<span class="lineNum">     641 </span><span class="lineNoCov">          0 :             free(fullname);</span>
<span class="lineNum">     642 </span><span class="lineNoCov">          0 :             return rc;</span>
<span class="lineNum">     643 </span>            :         }
<span class="lineNum">     644 </span><span class="lineNoCov">          0 :         free(basedir);</span>
<span class="lineNum">     645 </span>            :         /* do the symlink */
<span class="lineNum">     646 </span><span class="lineNoCov">          0 :         if (0 != symlink(mypath, fullname)) {</span>
<span class="lineNum">     647 </span><span class="lineNoCov">          0 :             opal_output(0, &quot;%s Failed to symlink %s to %s&quot;,</span>
<span class="lineNum">     648 </span>            :                         ORTE_NAME_PRINT(ORTE_PROC_MY_NAME), mypath, fullname);
<span class="lineNum">     649 </span><span class="lineNoCov">          0 :             rc = ORTE_ERROR;</span>
<span class="lineNum">     650 </span>            :         }
<span class="lineNum">     651 </span>            :     }
<span class="lineNum">     652 </span><span class="lineNoCov">          0 :     free(mypath);</span>
<span class="lineNum">     653 </span><span class="lineNoCov">          0 :     free(fullname);</span>
<span class="lineNum">     654 </span><span class="lineNoCov">          0 :     return rc;</span>
<a name="655"><span class="lineNum">     655 </span>            : }</a>
<span class="lineNum">     656 </span>            : 
<span class="lineNum">     657 </span><span class="lineCov">       2674 : static int raw_link_local_files(orte_job_t *jdata,</span>
<span class="lineNum">     658 </span>            :                                 orte_app_context_t *app)
<span class="lineNum">     659 </span>            : {
<span class="lineNum">     660 </span><span class="lineCov">       2674 :     char *my_dir, *path=NULL;</span>
<span class="lineNum">     661 </span>            :     orte_proc_t *proc;
<span class="lineNum">     662 </span>            :     char *prefix;
<span class="lineNum">     663 </span>            :     int i, j, rc;
<span class="lineNum">     664 </span>            :     orte_filem_raw_incoming_t *inbnd;
<span class="lineNum">     665 </span>            :     opal_list_item_t *item;
<span class="lineNum">     666 </span><span class="lineCov">       2674 :     char **files=NULL, *bname, *filestring;</span>
<span class="lineNum">     667 </span>            : 
<span class="lineNum">     668 </span>            :     /* check my session directory for files I have received and
<span class="lineNum">     669 </span>            :      * symlink them to the proc-level session directory of each
<span class="lineNum">     670 </span>            :      * local process in the job
<span class="lineNum">     671 </span>            :      */
<span class="lineNum">     672 </span><span class="lineCov">       2674 :     my_dir = opal_dirname(orte_process_info.job_session_dir);</span>
<span class="lineNum">     673 </span>            : 
<span class="lineNum">     674 </span>            :     /* setup */
<span class="lineNum">     675 </span><span class="lineCov">       2674 :     if (NULL != orte_process_info.tmpdir_base) {</span>
<span class="lineNum">     676 </span><span class="lineCov">       2674 :         prefix = strdup(orte_process_info.tmpdir_base);</span>
<span class="lineNum">     677 </span>            :     } else {
<span class="lineNum">     678 </span><span class="lineNoCov">          0 :         prefix = NULL;</span>
<span class="lineNum">     679 </span>            :     }
<span class="lineNum">     680 </span>            : 
<span class="lineNum">     681 </span>            :     /* get the list of files this app wants */
<span class="lineNum">     682 </span><span class="lineCov">       2674 :     if (orte_get_attribute(&amp;app-&gt;attributes, ORTE_APP_PRELOAD_FILES, (void**)&amp;filestring, OPAL_STRING)) {</span>
<span class="lineNum">     683 </span><span class="lineNoCov">          0 :         files = opal_argv_split(filestring, ',');</span>
<span class="lineNum">     684 </span><span class="lineNoCov">          0 :         free(filestring);</span>
<span class="lineNum">     685 </span>            :     }
<span class="lineNum">     686 </span><span class="lineCov">       2674 :     if (orte_get_attribute(&amp;app-&gt;attributes, ORTE_APP_PRELOAD_BIN, NULL, OPAL_BOOL)) {</span>
<span class="lineNum">     687 </span>            :         /* add the app itself to the list */
<span class="lineNum">     688 </span><span class="lineNoCov">          0 :         bname = opal_basename(app-&gt;app);</span>
<span class="lineNum">     689 </span><span class="lineNoCov">          0 :         opal_argv_append_nosize(&amp;files, bname);</span>
<span class="lineNum">     690 </span><span class="lineNoCov">          0 :         free(bname);</span>
<span class="lineNum">     691 </span>            :     }
<span class="lineNum">     692 </span>            : 
<span class="lineNum">     693 </span>            :     /* if there are no files to link, then ignore this */
<span class="lineNum">     694 </span><span class="lineCov">       2674 :     if (NULL == files) {</span>
<span class="lineNum">     695 </span><span class="lineCov">       2674 :         free(my_dir);</span>
<span class="lineNum">     696 </span><span class="lineCov">       2674 :         if (NULL != prefix) {</span>
<span class="lineNum">     697 </span><span class="lineCov">       2674 :             free(prefix);</span>
<span class="lineNum">     698 </span>            :         }
<span class="lineNum">     699 </span><span class="lineCov">       2674 :         return ORTE_SUCCESS;</span>
<span class="lineNum">     700 </span>            :     }
<span class="lineNum">     701 </span>            : 
<span class="lineNum">     702 </span><span class="lineNoCov">          0 :     for (i=0; i &lt; orte_local_children-&gt;size; i++) {</span>
<span class="lineNum">     703 </span><span class="lineNoCov">          0 :         if (NULL == (proc = (orte_proc_t*)opal_pointer_array_get_item(orte_local_children, i))) {</span>
<span class="lineNum">     704 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">     705 </span>            :         }
<span class="lineNum">     706 </span><span class="lineNoCov">          0 :         OPAL_OUTPUT_VERBOSE((10, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">     707 </span>            :                              &quot;%s filem:raw: working symlinks for proc %s&quot;,
<span class="lineNum">     708 </span>            :                              ORTE_NAME_PRINT(ORTE_PROC_MY_NAME),
<span class="lineNum">     709 </span>            :                              ORTE_NAME_PRINT(&amp;proc-&gt;name)));
<span class="lineNum">     710 </span><span class="lineNoCov">          0 :         if (proc-&gt;name.jobid != jdata-&gt;jobid) {</span>
<span class="lineNum">     711 </span><span class="lineNoCov">          0 :             OPAL_OUTPUT_VERBOSE((10, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">     712 </span>            :                                  &quot;%s filem:raw: proc %s not part of job %s&quot;,
<span class="lineNum">     713 </span>            :                                  ORTE_NAME_PRINT(ORTE_PROC_MY_NAME),
<span class="lineNum">     714 </span>            :                                  ORTE_NAME_PRINT(&amp;proc-&gt;name),
<span class="lineNum">     715 </span>            :                                  ORTE_JOBID_PRINT(jdata-&gt;jobid)));
<span class="lineNum">     716 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">     717 </span>            :         }
<span class="lineNum">     718 </span><span class="lineNoCov">          0 :         if (proc-&gt;app_idx != app-&gt;idx) {</span>
<span class="lineNum">     719 </span><span class="lineNoCov">          0 :             OPAL_OUTPUT_VERBOSE((10, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">     720 </span>            :                                  &quot;%s filem:raw: proc %s not part of app_idx %d&quot;,
<span class="lineNum">     721 </span>            :                                  ORTE_NAME_PRINT(ORTE_PROC_MY_NAME),
<span class="lineNum">     722 </span>            :                                  ORTE_NAME_PRINT(&amp;proc-&gt;name),
<span class="lineNum">     723 </span>            :                                  (int)app-&gt;idx));
<span class="lineNum">     724 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">     725 </span>            :         }
<span class="lineNum">     726 </span>            :         /* ignore children we have already handled */
<span class="lineNum">     727 </span><span class="lineNoCov">          0 :         if (ORTE_FLAG_TEST(proc, ORTE_PROC_FLAG_ALIVE) ||</span>
<span class="lineNum">     728 </span><span class="lineNoCov">          0 :             (ORTE_PROC_STATE_INIT != proc-&gt;state &amp;&amp;</span>
<span class="lineNum">     729 </span><span class="lineNoCov">          0 :              ORTE_PROC_STATE_RESTART != proc-&gt;state)) {</span>
<span class="lineNum">     730 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">     731 </span>            :         }
<span class="lineNum">     732 </span>            : 
<span class="lineNum">     733 </span><span class="lineNoCov">          0 :         OPAL_OUTPUT_VERBOSE((1, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">     734 </span>            :                              &quot;%s filem:raw: creating symlinks for %s&quot;,
<span class="lineNum">     735 </span>            :                              ORTE_NAME_PRINT(ORTE_PROC_MY_NAME),
<span class="lineNum">     736 </span>            :                              ORTE_NAME_PRINT(&amp;proc-&gt;name)));
<span class="lineNum">     737 </span>            : 
<span class="lineNum">     738 </span>            :         /* get the session dir name in absolute form */
<span class="lineNum">     739 </span><span class="lineNoCov">          0 :         path = NULL;</span>
<span class="lineNum">     740 </span><span class="lineNoCov">          0 :         rc = orte_session_dir_get_name(&amp;path, &amp;prefix, NULL,</span>
<span class="lineNum">     741 </span>            :                                        orte_process_info.nodename,
<span class="lineNum">     742 </span>            :                                        NULL, &amp;proc-&gt;name);
<span class="lineNum">     743 </span>            :         /* create it, if it doesn't already exist */
<span class="lineNum">     744 </span><span class="lineNoCov">          0 :         if (OPAL_SUCCESS != (rc = opal_os_dirpath_create(path, S_IRWXU))) {</span>
<span class="lineNum">     745 </span><span class="lineNoCov">          0 :             ORTE_ERROR_LOG(rc);</span>
<span class="lineNum">     746 </span>            :             /* doesn't exist with correct permissions, and/or we can't
<span class="lineNum">     747 </span>            :              * create it - either way, we are done
<span class="lineNum">     748 </span>            :              */
<span class="lineNum">     749 </span><span class="lineNoCov">          0 :             free(files);</span>
<span class="lineNum">     750 </span><span class="lineNoCov">          0 :             if (NULL != prefix) {</span>
<span class="lineNum">     751 </span><span class="lineNoCov">          0 :                 free(prefix);</span>
<span class="lineNum">     752 </span>            :             }
<span class="lineNum">     753 </span><span class="lineNoCov">          0 :             free(path);</span>
<span class="lineNum">     754 </span><span class="lineNoCov">          0 :             free(my_dir);</span>
<span class="lineNum">     755 </span><span class="lineNoCov">          0 :             return rc;</span>
<span class="lineNum">     756 </span>            :         }
<span class="lineNum">     757 </span>            : 
<span class="lineNum">     758 </span>            :         /* cycle thru the incoming files */
<span class="lineNum">     759 </span><span class="lineNoCov">          0 :         for (item = opal_list_get_first(&amp;incoming_files);</span>
<span class="lineNum">     760 </span><span class="lineNoCov">          0 :              item != opal_list_get_end(&amp;incoming_files);</span>
<span class="lineNum">     761 </span><span class="lineNoCov">          0 :              item = opal_list_get_next(item)) {</span>
<span class="lineNum">     762 </span><span class="lineNoCov">          0 :             inbnd = (orte_filem_raw_incoming_t*)item;</span>
<span class="lineNum">     763 </span><span class="lineNoCov">          0 :             OPAL_OUTPUT_VERBOSE((1, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">     764 </span>            :                                  &quot;%s filem:raw: checking file %s&quot;,
<span class="lineNum">     765 </span>            :                                  ORTE_NAME_PRINT(ORTE_PROC_MY_NAME), inbnd-&gt;file));
<span class="lineNum">     766 </span>            : 
<span class="lineNum">     767 </span>            :             /* is this file for this app_context? */
<span class="lineNum">     768 </span><span class="lineNoCov">          0 :             for (j=0; NULL != files[j]; j++) {</span>
<span class="lineNum">     769 </span><span class="lineNoCov">          0 :                 if (0 == strcmp(inbnd-&gt;file, files[j])) {</span>
<span class="lineNum">     770 </span>            :                     /* this must be one of the files we are to link against */
<span class="lineNum">     771 </span><span class="lineNoCov">          0 :                     if (NULL != inbnd-&gt;link_pts) {</span>
<span class="lineNum">     772 </span><span class="lineNoCov">          0 :                         OPAL_OUTPUT_VERBOSE((10, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">     773 </span>            :                                              &quot;%s filem:raw: creating links for file %s&quot;,
<span class="lineNum">     774 </span>            :                                              ORTE_NAME_PRINT(ORTE_PROC_MY_NAME),
<span class="lineNum">     775 </span>            :                                              inbnd-&gt;file));
<span class="lineNum">     776 </span>            :                         /* cycle thru the link points and create symlinks to them */
<span class="lineNum">     777 </span><span class="lineNoCov">          0 :                         for (j=0; NULL != inbnd-&gt;link_pts[j]; j++) {</span>
<span class="lineNum">     778 </span><span class="lineNoCov">          0 :                             if (ORTE_SUCCESS != (rc = create_link(my_dir, path, inbnd-&gt;link_pts[j]))) {</span>
<span class="lineNum">     779 </span><span class="lineNoCov">          0 :                                 ORTE_ERROR_LOG(rc);</span>
<span class="lineNum">     780 </span><span class="lineNoCov">          0 :                                 free(my_dir);</span>
<span class="lineNum">     781 </span><span class="lineNoCov">          0 :                                 free(path);</span>
<span class="lineNum">     782 </span><span class="lineNoCov">          0 :                                 if (NULL != prefix) {</span>
<span class="lineNum">     783 </span><span class="lineNoCov">          0 :                                     free(prefix);</span>
<span class="lineNum">     784 </span>            :                                 }
<span class="lineNum">     785 </span><span class="lineNoCov">          0 :                                 free(files);</span>
<span class="lineNum">     786 </span><span class="lineNoCov">          0 :                                 return rc;</span>
<span class="lineNum">     787 </span>            :                             }
<span class="lineNum">     788 </span>            :                         }
<span class="lineNum">     789 </span>            :                     } else {
<span class="lineNum">     790 </span><span class="lineNoCov">          0 :                         OPAL_OUTPUT_VERBOSE((10, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">     791 </span>            :                                              &quot;%s filem:raw: file %s has no link points&quot;,
<span class="lineNum">     792 </span>            :                                              ORTE_NAME_PRINT(ORTE_PROC_MY_NAME),
<span class="lineNum">     793 </span>            :                                              inbnd-&gt;file));
<span class="lineNum">     794 </span>            :                     }
<span class="lineNum">     795 </span><span class="lineNoCov">          0 :                     break;</span>
<span class="lineNum">     796 </span>            :                 }
<span class="lineNum">     797 </span>            :             }
<span class="lineNum">     798 </span>            :         }
<span class="lineNum">     799 </span><span class="lineNoCov">          0 :         free(path);</span>
<span class="lineNum">     800 </span>            :     }
<span class="lineNum">     801 </span><span class="lineNoCov">          0 :     opal_argv_free(files);</span>
<span class="lineNum">     802 </span><span class="lineNoCov">          0 :     if (NULL != prefix) {</span>
<span class="lineNum">     803 </span><span class="lineNoCov">          0 :         free(prefix);</span>
<span class="lineNum">     804 </span>            :     }
<span class="lineNum">     805 </span><span class="lineNoCov">          0 :     free(my_dir);</span>
<span class="lineNum">     806 </span><span class="lineNoCov">          0 :     return ORTE_SUCCESS;</span>
<a name="807"><span class="lineNum">     807 </span>            : }</a>
<span class="lineNum">     808 </span>            : 
<span class="lineNum">     809 </span><span class="lineNoCov">          0 : static void send_chunk(int fd, short argc, void *cbdata)</span>
<span class="lineNum">     810 </span>            : {
<span class="lineNum">     811 </span><span class="lineNoCov">          0 :     orte_filem_raw_xfer_t *rev = (orte_filem_raw_xfer_t*)cbdata;</span>
<span class="lineNum">     812 </span>            :     unsigned char data[ORTE_FILEM_RAW_CHUNK_MAX];
<span class="lineNum">     813 </span>            :     int32_t numbytes;
<span class="lineNum">     814 </span>            :     int rc;
<span class="lineNum">     815 </span>            :     opal_buffer_t chunk;
<span class="lineNum">     816 </span>            :     orte_grpcomm_signature_t *sig;
<span class="lineNum">     817 </span>            : 
<span class="lineNum">     818 </span>            :     /* flag that event has fired */
<span class="lineNum">     819 </span><span class="lineNoCov">          0 :     rev-&gt;pending = false;</span>
<span class="lineNum">     820 </span>            : 
<span class="lineNum">     821 </span>            :     /* read up to the fragment size */
<span class="lineNum">     822 </span><span class="lineNoCov">          0 :     numbytes = read(fd, data, sizeof(data));</span>
<span class="lineNum">     823 </span>            : 
<span class="lineNum">     824 </span><span class="lineNoCov">          0 :     if (numbytes &lt; 0) {</span>
<span class="lineNum">     825 </span>            :         /* either we have a connection error or it was a non-blocking read */
<span class="lineNum">     826 </span>            : 
<span class="lineNum">     827 </span>            :         /* non-blocking, retry */
<span class="lineNum">     828 </span><span class="lineNoCov">          0 :         if (EAGAIN == errno || EINTR == errno) {</span>
<span class="lineNum">     829 </span><span class="lineNoCov">          0 :             opal_event_add(&amp;rev-&gt;ev, 0);</span>
<span class="lineNum">     830 </span><span class="lineNoCov">          0 :             return;</span>
<span class="lineNum">     831 </span>            :         }
<span class="lineNum">     832 </span>            : 
<span class="lineNum">     833 </span><span class="lineNoCov">          0 :         OPAL_OUTPUT_VERBOSE((1, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">     834 </span>            :                              &quot;%s filem:raw:read error on file %s&quot;,
<span class="lineNum">     835 </span>            :                              ORTE_NAME_PRINT(ORTE_PROC_MY_NAME), rev-&gt;file));
<span class="lineNum">     836 </span>            : 
<span class="lineNum">     837 </span>            :         /* Un-recoverable error. Allow the code to flow as usual in order to
<span class="lineNum">     838 </span>            :          * to send the zero bytes message up the stream, and then close the
<span class="lineNum">     839 </span>            :          * file descriptor and delete the event.
<span class="lineNum">     840 </span>            :          */
<span class="lineNum">     841 </span><span class="lineNoCov">          0 :         numbytes = 0;</span>
<span class="lineNum">     842 </span>            :     }
<span class="lineNum">     843 </span>            : 
<span class="lineNum">     844 </span>            :     /* if job termination has been ordered, just ignore the
<span class="lineNum">     845 </span>            :      * data and delete the read event
<span class="lineNum">     846 </span>            :      */
<span class="lineNum">     847 </span><span class="lineNoCov">          0 :     if (orte_job_term_ordered) {</span>
<span class="lineNum">     848 </span><span class="lineNoCov">          0 :         OBJ_RELEASE(rev);</span>
<span class="lineNum">     849 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">     850 </span>            :     }
<span class="lineNum">     851 </span>            : 
<span class="lineNum">     852 </span><span class="lineNoCov">          0 :     OPAL_OUTPUT_VERBOSE((1, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">     853 </span>            :                          &quot;%s filem:raw:read handler sending chunk %d of %d bytes for file %s&quot;,
<span class="lineNum">     854 </span>            :                          ORTE_NAME_PRINT(ORTE_PROC_MY_NAME),
<span class="lineNum">     855 </span>            :                          rev-&gt;nchunk, numbytes, rev-&gt;file));
<span class="lineNum">     856 </span>            : 
<span class="lineNum">     857 </span>            :     /* package it for transmission */
<span class="lineNum">     858 </span><span class="lineNoCov">          0 :     OBJ_CONSTRUCT(&amp;chunk, opal_buffer_t);</span>
<span class="lineNum">     859 </span><span class="lineNoCov">          0 :     if (OPAL_SUCCESS != (rc = opal_dss.pack(&amp;chunk, &amp;rev-&gt;file, 1, OPAL_STRING))) {</span>
<span class="lineNum">     860 </span><span class="lineNoCov">          0 :         ORTE_ERROR_LOG(rc);</span>
<span class="lineNum">     861 </span><span class="lineNoCov">          0 :         close(fd);</span>
<span class="lineNum">     862 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">     863 </span>            :     }
<span class="lineNum">     864 </span><span class="lineNoCov">          0 :     if (OPAL_SUCCESS != (rc = opal_dss.pack(&amp;chunk, &amp;rev-&gt;nchunk, 1, OPAL_INT32))) {</span>
<span class="lineNum">     865 </span><span class="lineNoCov">          0 :         ORTE_ERROR_LOG(rc);</span>
<span class="lineNum">     866 </span><span class="lineNoCov">          0 :         close(fd);</span>
<span class="lineNum">     867 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">     868 </span>            :     }
<span class="lineNum">     869 </span><span class="lineNoCov">          0 :     if (OPAL_SUCCESS != (rc = opal_dss.pack(&amp;chunk, data, numbytes, OPAL_BYTE))) {</span>
<span class="lineNum">     870 </span><span class="lineNoCov">          0 :         ORTE_ERROR_LOG(rc);</span>
<span class="lineNum">     871 </span><span class="lineNoCov">          0 :         close(fd);</span>
<span class="lineNum">     872 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">     873 </span>            :     }
<span class="lineNum">     874 </span>            :     /* if it is the first chunk, then add file type and index of the app */
<span class="lineNum">     875 </span><span class="lineNoCov">          0 :     if (0 == rev-&gt;nchunk) {</span>
<span class="lineNum">     876 </span><span class="lineNoCov">          0 :         if (OPAL_SUCCESS != (rc = opal_dss.pack(&amp;chunk, &amp;rev-&gt;type, 1, OPAL_INT32))) {</span>
<span class="lineNum">     877 </span><span class="lineNoCov">          0 :             ORTE_ERROR_LOG(rc);</span>
<span class="lineNum">     878 </span><span class="lineNoCov">          0 :             close(fd);</span>
<span class="lineNum">     879 </span><span class="lineNoCov">          0 :             return;</span>
<span class="lineNum">     880 </span>            :         }
<span class="lineNum">     881 </span>            :     }
<span class="lineNum">     882 </span>            : 
<span class="lineNum">     883 </span>            :     /* goes to all daemons */
<span class="lineNum">     884 </span><span class="lineNoCov">          0 :     sig = OBJ_NEW(orte_grpcomm_signature_t);</span>
<span class="lineNum">     885 </span><span class="lineNoCov">          0 :     sig-&gt;signature = (orte_process_name_t*)malloc(sizeof(orte_process_name_t));</span>
<span class="lineNum">     886 </span><span class="lineNoCov">          0 :     sig-&gt;signature[0].jobid = ORTE_PROC_MY_NAME-&gt;jobid;</span>
<span class="lineNum">     887 </span><span class="lineNoCov">          0 :     sig-&gt;signature[0].vpid = ORTE_VPID_WILDCARD;</span>
<span class="lineNum">     888 </span><span class="lineNoCov">          0 :     if (ORTE_SUCCESS != (rc = orte_grpcomm.xcast(sig, ORTE_RML_TAG_FILEM_BASE, &amp;chunk))) {</span>
<span class="lineNum">     889 </span><span class="lineNoCov">          0 :         ORTE_ERROR_LOG(rc);</span>
<span class="lineNum">     890 </span><span class="lineNoCov">          0 :         close(fd);</span>
<span class="lineNum">     891 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">     892 </span>            :     }
<span class="lineNum">     893 </span><span class="lineNoCov">          0 :     OBJ_DESTRUCT(&amp;chunk);</span>
<span class="lineNum">     894 </span><span class="lineNoCov">          0 :     OBJ_RELEASE(sig);</span>
<span class="lineNum">     895 </span><span class="lineNoCov">          0 :     rev-&gt;nchunk++;</span>
<span class="lineNum">     896 </span>            : 
<span class="lineNum">     897 </span>            :     /* if num_bytes was zero, then we need to terminate the event
<span class="lineNum">     898 </span>            :      * and close the file descriptor
<span class="lineNum">     899 </span>            :      */
<span class="lineNum">     900 </span><span class="lineNoCov">          0 :     if (0 == numbytes) {</span>
<span class="lineNum">     901 </span><span class="lineNoCov">          0 :         close(fd);</span>
<span class="lineNum">     902 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">     903 </span>            :     } else {
<span class="lineNum">     904 </span>            :         /* restart the read event */
<span class="lineNum">     905 </span><span class="lineNoCov">          0 :         opal_event_add(&amp;rev-&gt;ev, 0);</span>
<span class="lineNum">     906 </span><span class="lineNoCov">          0 :         rev-&gt;pending = true;</span>
<span class="lineNum">     907 </span>            :     }
<a name="908"><span class="lineNum">     908 </span>            : }</a>
<span class="lineNum">     909 </span>            : 
<span class="lineNum">     910 </span><span class="lineNoCov">          0 : static void send_complete(char *file, int status)</span>
<span class="lineNum">     911 </span>            : {
<span class="lineNum">     912 </span>            :     opal_buffer_t *buf;
<span class="lineNum">     913 </span>            :     int rc;
<span class="lineNum">     914 </span>            : 
<span class="lineNum">     915 </span><span class="lineNoCov">          0 :     buf = OBJ_NEW(opal_buffer_t);</span>
<span class="lineNum">     916 </span><span class="lineNoCov">          0 :     if (OPAL_SUCCESS != (rc = opal_dss.pack(buf, &amp;file, 1, OPAL_STRING))) {</span>
<span class="lineNum">     917 </span><span class="lineNoCov">          0 :         ORTE_ERROR_LOG(rc);</span>
<span class="lineNum">     918 </span><span class="lineNoCov">          0 :         OBJ_RELEASE(buf);</span>
<span class="lineNum">     919 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">     920 </span>            :     }
<span class="lineNum">     921 </span><span class="lineNoCov">          0 :     if (OPAL_SUCCESS != (rc = opal_dss.pack(buf, &amp;status, 1, OPAL_INT))) {</span>
<span class="lineNum">     922 </span><span class="lineNoCov">          0 :         ORTE_ERROR_LOG(rc);</span>
<span class="lineNum">     923 </span><span class="lineNoCov">          0 :         OBJ_RELEASE(buf);</span>
<span class="lineNum">     924 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">     925 </span>            :     }
<span class="lineNum">     926 </span><span class="lineNoCov">          0 :     if (0 &gt; (rc = orte_rml.send_buffer_nb(ORTE_PROC_MY_HNP, buf,</span>
<span class="lineNum">     927 </span>            :                                           ORTE_RML_TAG_FILEM_BASE_RESP,
<span class="lineNum">     928 </span>            :                                           orte_rml_send_callback, NULL))) {
<span class="lineNum">     929 </span><span class="lineNoCov">          0 :         ORTE_ERROR_LOG(rc);</span>
<span class="lineNum">     930 </span><span class="lineNoCov">          0 :         OBJ_RELEASE(buf);</span>
<span class="lineNum">     931 </span>            :     }
<span class="lineNum">     932 </span>            : }
<span class="lineNum">     933 </span>            : 
<span class="lineNum">     934 </span>            : /* This is a little tricky as the name of the archive doesn't
<span class="lineNum">     935 </span>            :  * necessarily have anything to do with the paths inside it -
<a name="936"><span class="lineNum">     936 </span>            :  * so we have to first query the archive to retrieve that info</a>
<span class="lineNum">     937 </span>            :  */
<span class="lineNum">     938 </span><span class="lineNoCov">          0 : static int link_archive(orte_filem_raw_incoming_t *inbnd)</span>
<span class="lineNum">     939 </span>            : {
<span class="lineNum">     940 </span>            :     FILE *fp;
<span class="lineNum">     941 </span>            :     char *cmd;
<span class="lineNum">     942 </span>            :     char path[MAXPATHLEN];
<span class="lineNum">     943 </span>            : 
<span class="lineNum">     944 </span><span class="lineNoCov">          0 :     OPAL_OUTPUT_VERBOSE((1, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">     945 </span>            :                          &quot;%s filem:raw: identifying links for archive %s&quot;,
<span class="lineNum">     946 </span>            :                          ORTE_NAME_PRINT(ORTE_PROC_MY_NAME),
<span class="lineNum">     947 </span>            :                          inbnd-&gt;fullpath));
<span class="lineNum">     948 </span>            : 
<span class="lineNum">     949 </span><span class="lineNoCov">          0 :     asprintf(&amp;cmd, &quot;tar tf %s&quot;, inbnd-&gt;fullpath);</span>
<span class="lineNum">     950 </span><span class="lineNoCov">          0 :     fp = popen(cmd, &quot;r&quot;);</span>
<span class="lineNum">     951 </span><span class="lineNoCov">          0 :     free(cmd);</span>
<span class="lineNum">     952 </span><span class="lineNoCov">          0 :     if (NULL == fp) {</span>
<span class="lineNum">     953 </span><span class="lineNoCov">          0 :         ORTE_ERROR_LOG(ORTE_ERR_FILE_OPEN_FAILURE);</span>
<span class="lineNum">     954 </span><span class="lineNoCov">          0 :         return ORTE_ERR_FILE_OPEN_FAILURE;</span>
<span class="lineNum">     955 </span>            :     }
<span class="lineNum">     956 </span>            :     /* because app_contexts might share part or all of a
<span class="lineNum">     957 </span>            :      * directory tree, but link to different files, we
<span class="lineNum">     958 </span>            :      * have to link to each individual file
<span class="lineNum">     959 </span>            :      */
<span class="lineNum">     960 </span><span class="lineNoCov">          0 :     while (fgets(path, sizeof(path), fp) != NULL) {</span>
<span class="lineNum">     961 </span><span class="lineNoCov">          0 :         OPAL_OUTPUT_VERBOSE((10, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">     962 </span>            :                              &quot;%s filem:raw: path %s&quot;,
<span class="lineNum">     963 </span>            :                              ORTE_NAME_PRINT(ORTE_PROC_MY_NAME),
<span class="lineNum">     964 </span>            :                              path));
<span class="lineNum">     965 </span>            :         /* protect against an empty result */
<span class="lineNum">     966 </span><span class="lineNoCov">          0 :         if (0 == strlen(path)) {</span>
<span class="lineNum">     967 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">     968 </span>            :         }
<span class="lineNum">     969 </span>            :         /* trim the trailing cr */
<span class="lineNum">     970 </span><span class="lineNoCov">          0 :         path[strlen(path)-1] = '\0';</span>
<span class="lineNum">     971 </span>            :         /* ignore directories */
<span class="lineNum">     972 </span><span class="lineNoCov">          0 :         if ('/' == path[strlen(path)-1]) {</span>
<span class="lineNum">     973 </span><span class="lineNoCov">          0 :             OPAL_OUTPUT_VERBOSE((10, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">     974 </span>            :                                  &quot;%s filem:raw: path %s is a directory - ignoring it&quot;,
<span class="lineNum">     975 </span>            :                                  ORTE_NAME_PRINT(ORTE_PROC_MY_NAME),
<span class="lineNum">     976 </span>            :                                  path));
<span class="lineNum">     977 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">     978 </span>            :         }
<span class="lineNum">     979 </span>            :         /* ignore specific useless directory trees */
<span class="lineNum">     980 </span><span class="lineNoCov">          0 :         if (NULL != strstr(path, &quot;.deps&quot;)) {</span>
<span class="lineNum">     981 </span><span class="lineNoCov">          0 :             OPAL_OUTPUT_VERBOSE((10, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">     982 </span>            :                                  &quot;%s filem:raw: path %s includes .deps - ignoring it&quot;,
<span class="lineNum">     983 </span>            :                                  ORTE_NAME_PRINT(ORTE_PROC_MY_NAME),
<span class="lineNum">     984 </span>            :                                  path));
<span class="lineNum">     985 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">     986 </span>            :         }
<span class="lineNum">     987 </span><span class="lineNoCov">          0 :         OPAL_OUTPUT_VERBOSE((10, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">     988 </span>            :                              &quot;%s filem:raw: adding path %s to link points&quot;,
<span class="lineNum">     989 </span>            :                              ORTE_NAME_PRINT(ORTE_PROC_MY_NAME),
<span class="lineNum">     990 </span>            :                              path));
<span class="lineNum">     991 </span><span class="lineNoCov">          0 :         opal_argv_append_nosize(&amp;inbnd-&gt;link_pts, path);</span>
<span class="lineNum">     992 </span>            :     }
<span class="lineNum">     993 </span>            :     /* close */
<span class="lineNum">     994 </span><span class="lineNoCov">          0 :     pclose(fp);</span>
<span class="lineNum">     995 </span><span class="lineNoCov">          0 :     return ORTE_SUCCESS;</span>
<a name="996"><span class="lineNum">     996 </span>            : }</a>
<span class="lineNum">     997 </span>            : 
<span class="lineNum">     998 </span><span class="lineNoCov">          0 : static void recv_files(int status, orte_process_name_t* sender,</span>
<span class="lineNum">     999 </span>            :                        opal_buffer_t* buffer, orte_rml_tag_t tag,
<span class="lineNum">    1000 </span>            :                        void* cbdata)
<span class="lineNum">    1001 </span>            : {
<span class="lineNum">    1002 </span>            :     char *file, *jobfam_dir;
<span class="lineNum">    1003 </span>            :     int32_t nchunk, n, nbytes;
<span class="lineNum">    1004 </span>            :     unsigned char data[ORTE_FILEM_RAW_CHUNK_MAX];
<span class="lineNum">    1005 </span>            :     int rc;
<span class="lineNum">    1006 </span>            :     orte_filem_raw_output_t *output;
<span class="lineNum">    1007 </span>            :     orte_filem_raw_incoming_t *ptr, *incoming;
<span class="lineNum">    1008 </span>            :     opal_list_item_t *item;
<span class="lineNum">    1009 </span>            :     int32_t type;
<span class="lineNum">    1010 </span>            :     char *cptr;
<span class="lineNum">    1011 </span>            : 
<span class="lineNum">    1012 </span>            :     /* unpack the data */
<span class="lineNum">    1013 </span><span class="lineNoCov">          0 :     n=1;</span>
<span class="lineNum">    1014 </span><span class="lineNoCov">          0 :     if (OPAL_SUCCESS != (rc = opal_dss.unpack(buffer, &amp;file, &amp;n, OPAL_STRING))) {</span>
<span class="lineNum">    1015 </span><span class="lineNoCov">          0 :         ORTE_ERROR_LOG(rc);</span>
<span class="lineNum">    1016 </span><span class="lineNoCov">          0 :         send_complete(NULL, rc);</span>
<span class="lineNum">    1017 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">    1018 </span>            :     }
<span class="lineNum">    1019 </span><span class="lineNoCov">          0 :     n=1;</span>
<span class="lineNum">    1020 </span><span class="lineNoCov">          0 :     if (OPAL_SUCCESS != (rc = opal_dss.unpack(buffer, &amp;nchunk, &amp;n, OPAL_INT32))) {</span>
<span class="lineNum">    1021 </span><span class="lineNoCov">          0 :         ORTE_ERROR_LOG(rc);</span>
<span class="lineNum">    1022 </span><span class="lineNoCov">          0 :         send_complete(file, rc);</span>
<span class="lineNum">    1023 </span><span class="lineNoCov">          0 :         free(file);</span>
<span class="lineNum">    1024 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">    1025 </span>            :     }
<span class="lineNum">    1026 </span>            :     /* if the chunk number is &lt; 0, then this is an EOF message */
<span class="lineNum">    1027 </span><span class="lineNoCov">          0 :     if (nchunk &lt; 0) {</span>
<span class="lineNum">    1028 </span>            :         /* just set nbytes to zero so we close the fd */
<span class="lineNum">    1029 </span><span class="lineNoCov">          0 :         nbytes = 0;</span>
<span class="lineNum">    1030 </span>            :     } else {
<span class="lineNum">    1031 </span><span class="lineNoCov">          0 :         nbytes=ORTE_FILEM_RAW_CHUNK_MAX;</span>
<span class="lineNum">    1032 </span><span class="lineNoCov">          0 :         if (OPAL_SUCCESS != (rc = opal_dss.unpack(buffer, data, &amp;nbytes, OPAL_BYTE))) {</span>
<span class="lineNum">    1033 </span><span class="lineNoCov">          0 :             ORTE_ERROR_LOG(rc);</span>
<span class="lineNum">    1034 </span><span class="lineNoCov">          0 :             send_complete(file, rc);</span>
<span class="lineNum">    1035 </span><span class="lineNoCov">          0 :             free(file);</span>
<span class="lineNum">    1036 </span><span class="lineNoCov">          0 :             return;</span>
<span class="lineNum">    1037 </span>            :         }
<span class="lineNum">    1038 </span>            :     }
<span class="lineNum">    1039 </span>            :     /* if the chunk is 0, then additional info should be present */
<span class="lineNum">    1040 </span><span class="lineNoCov">          0 :     if (0 == nchunk) {</span>
<span class="lineNum">    1041 </span><span class="lineNoCov">          0 :         n=1;</span>
<span class="lineNum">    1042 </span><span class="lineNoCov">          0 :         if (OPAL_SUCCESS != (rc = opal_dss.unpack(buffer, &amp;type, &amp;n, OPAL_INT32))) {</span>
<span class="lineNum">    1043 </span><span class="lineNoCov">          0 :             ORTE_ERROR_LOG(rc);</span>
<span class="lineNum">    1044 </span><span class="lineNoCov">          0 :             send_complete(file, rc);</span>
<span class="lineNum">    1045 </span><span class="lineNoCov">          0 :             free(file);</span>
<span class="lineNum">    1046 </span><span class="lineNoCov">          0 :             return;</span>
<span class="lineNum">    1047 </span>            :         }
<span class="lineNum">    1048 </span>            :     }
<span class="lineNum">    1049 </span>            : 
<span class="lineNum">    1050 </span><span class="lineNoCov">          0 :     OPAL_OUTPUT_VERBOSE((1, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">    1051 </span>            :                          &quot;%s filem:raw: received chunk %d for file %s containing %d bytes&quot;,
<span class="lineNum">    1052 </span>            :                          ORTE_NAME_PRINT(ORTE_PROC_MY_NAME),
<span class="lineNum">    1053 </span>            :                          nchunk, file, nbytes));
<span class="lineNum">    1054 </span>            : 
<span class="lineNum">    1055 </span>            :     /* do we already have this file on our list of incoming? */
<span class="lineNum">    1056 </span><span class="lineNoCov">          0 :     incoming = NULL;</span>
<span class="lineNum">    1057 </span><span class="lineNoCov">          0 :     for (item = opal_list_get_first(&amp;incoming_files);</span>
<span class="lineNum">    1058 </span><span class="lineNoCov">          0 :          item != opal_list_get_end(&amp;incoming_files);</span>
<span class="lineNum">    1059 </span><span class="lineNoCov">          0 :          item = opal_list_get_next(item)) {</span>
<span class="lineNum">    1060 </span><span class="lineNoCov">          0 :         ptr = (orte_filem_raw_incoming_t*)item;</span>
<span class="lineNum">    1061 </span><span class="lineNoCov">          0 :         if (0 == strcmp(file, ptr-&gt;file)) {</span>
<span class="lineNum">    1062 </span><span class="lineNoCov">          0 :             incoming = ptr;</span>
<span class="lineNum">    1063 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1064 </span>            :         }
<span class="lineNum">    1065 </span>            :     }
<span class="lineNum">    1066 </span><span class="lineNoCov">          0 :     if (NULL == incoming) {</span>
<span class="lineNum">    1067 </span>            :         /* nope - add it */
<span class="lineNum">    1068 </span><span class="lineNoCov">          0 :         OPAL_OUTPUT_VERBOSE((1, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">    1069 </span>            :                              &quot;%s filem:raw: adding file %s to incoming list&quot;,
<span class="lineNum">    1070 </span>            :                              ORTE_NAME_PRINT(ORTE_PROC_MY_NAME), file));
<span class="lineNum">    1071 </span><span class="lineNoCov">          0 :         incoming = OBJ_NEW(orte_filem_raw_incoming_t);</span>
<span class="lineNum">    1072 </span><span class="lineNoCov">          0 :         incoming-&gt;file = strdup(file);</span>
<span class="lineNum">    1073 </span><span class="lineNoCov">          0 :         incoming-&gt;type = type;</span>
<span class="lineNum">    1074 </span><span class="lineNoCov">          0 :         opal_list_append(&amp;incoming_files, &amp;incoming-&gt;super);</span>
<span class="lineNum">    1075 </span>            :     }
<span class="lineNum">    1076 </span>            : 
<span class="lineNum">    1077 </span>            :     /* if this is the first chunk, we need to open the file descriptor */
<span class="lineNum">    1078 </span><span class="lineNoCov">          0 :     if (0 == nchunk) {</span>
<span class="lineNum">    1079 </span>            :         /* separate out the top-level directory of the target */
<span class="lineNum">    1080 </span>            :         char *tmp;
<span class="lineNum">    1081 </span><span class="lineNoCov">          0 :         tmp = strdup(file);</span>
<span class="lineNum">    1082 </span><span class="lineNoCov">          0 :         if (NULL != (cptr = strchr(tmp, '/'))) {</span>
<span class="lineNum">    1083 </span><span class="lineNoCov">          0 :             *cptr = '\0';</span>
<span class="lineNum">    1084 </span>            :         }
<span class="lineNum">    1085 </span>            :         /* save it */
<span class="lineNum">    1086 </span><span class="lineNoCov">          0 :         incoming-&gt;top = strdup(tmp);</span>
<span class="lineNum">    1087 </span><span class="lineNoCov">          0 :         free(tmp);</span>
<span class="lineNum">    1088 </span>            :         /* define the full path to where we will put it */
<span class="lineNum">    1089 </span><span class="lineNoCov">          0 :         jobfam_dir = opal_dirname(orte_process_info.job_session_dir);</span>
<span class="lineNum">    1090 </span><span class="lineNoCov">          0 :         incoming-&gt;fullpath = opal_os_path(false, jobfam_dir, file, NULL);</span>
<span class="lineNum">    1091 </span><span class="lineNoCov">          0 :         free(jobfam_dir);</span>
<span class="lineNum">    1092 </span>            : 
<span class="lineNum">    1093 </span><span class="lineNoCov">          0 :         OPAL_OUTPUT_VERBOSE((1, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">    1094 </span>            :                              &quot;%s filem:raw: opening target file %s&quot;,
<span class="lineNum">    1095 </span>            :                              ORTE_NAME_PRINT(ORTE_PROC_MY_NAME), incoming-&gt;fullpath));
<span class="lineNum">    1096 </span>            :         /* create the path to the target, if not already existing */
<span class="lineNum">    1097 </span><span class="lineNoCov">          0 :         tmp = opal_dirname(incoming-&gt;fullpath);</span>
<span class="lineNum">    1098 </span><span class="lineNoCov">          0 :         if (OPAL_SUCCESS != (rc = opal_os_dirpath_create(tmp, S_IRWXU))) {</span>
<span class="lineNum">    1099 </span><span class="lineNoCov">          0 :             ORTE_ERROR_LOG(rc);</span>
<span class="lineNum">    1100 </span><span class="lineNoCov">          0 :             send_complete(file, ORTE_ERR_FILE_WRITE_FAILURE);</span>
<span class="lineNum">    1101 </span><span class="lineNoCov">          0 :             free(file);</span>
<span class="lineNum">    1102 </span><span class="lineNoCov">          0 :             free(tmp);</span>
<span class="lineNum">    1103 </span><span class="lineNoCov">          0 :             OBJ_RELEASE(incoming);</span>
<span class="lineNum">    1104 </span><span class="lineNoCov">          0 :             return;</span>
<span class="lineNum">    1105 </span>            :         }
<span class="lineNum">    1106 </span>            :         /* open the file descriptor for writing */
<span class="lineNum">    1107 </span><span class="lineNoCov">          0 :         if (ORTE_FILEM_TYPE_EXE == type) {</span>
<span class="lineNum">    1108 </span><span class="lineNoCov">          0 :             if (0 &gt; (incoming-&gt;fd = open(incoming-&gt;fullpath, O_RDWR | O_CREAT | O_TRUNC, S_IRWXU))) {</span>
<span class="lineNum">    1109 </span><span class="lineNoCov">          0 :                 opal_output(0, &quot;%s CANNOT CREATE FILE %s&quot;,</span>
<span class="lineNum">    1110 </span>            :                             ORTE_NAME_PRINT(ORTE_PROC_MY_NAME),
<span class="lineNum">    1111 </span>            :                             incoming-&gt;fullpath);
<span class="lineNum">    1112 </span><span class="lineNoCov">          0 :                 send_complete(file, ORTE_ERR_FILE_WRITE_FAILURE);</span>
<span class="lineNum">    1113 </span><span class="lineNoCov">          0 :                 free(file);</span>
<span class="lineNum">    1114 </span><span class="lineNoCov">          0 :                 free(tmp);</span>
<span class="lineNum">    1115 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    1116 </span>            :             }
<span class="lineNum">    1117 </span>            :         } else {
<span class="lineNum">    1118 </span><span class="lineNoCov">          0 :             if (0 &gt; (incoming-&gt;fd = open(incoming-&gt;fullpath, O_RDWR | O_CREAT | O_TRUNC, S_IRUSR | S_IWUSR))) {</span>
<span class="lineNum">    1119 </span><span class="lineNoCov">          0 :                 opal_output(0, &quot;%s CANNOT CREATE FILE %s&quot;,</span>
<span class="lineNum">    1120 </span>            :                             ORTE_NAME_PRINT(ORTE_PROC_MY_NAME),
<span class="lineNum">    1121 </span>            :                             incoming-&gt;fullpath);
<span class="lineNum">    1122 </span><span class="lineNoCov">          0 :                 send_complete(file, ORTE_ERR_FILE_WRITE_FAILURE);</span>
<span class="lineNum">    1123 </span><span class="lineNoCov">          0 :                 free(file);</span>
<span class="lineNum">    1124 </span><span class="lineNoCov">          0 :                 free(tmp);</span>
<span class="lineNum">    1125 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    1126 </span>            :             }
<span class="lineNum">    1127 </span>            :         }
<span class="lineNum">    1128 </span><span class="lineNoCov">          0 :         free(tmp);</span>
<span class="lineNum">    1129 </span><span class="lineNoCov">          0 :         opal_event_set(orte_event_base, &amp;incoming-&gt;ev, incoming-&gt;fd, OPAL_EV_WRITE, write_handler, incoming);</span>
<span class="lineNum">    1130 </span><span class="lineNoCov">          0 :         opal_event_set_priority(&amp;incoming-&gt;ev, ORTE_MSG_PRI);</span>
<span class="lineNum">    1131 </span>            :     }
<span class="lineNum">    1132 </span>            :     /* create an output object for this data */
<span class="lineNum">    1133 </span><span class="lineNoCov">          0 :     output = OBJ_NEW(orte_filem_raw_output_t);</span>
<span class="lineNum">    1134 </span><span class="lineNoCov">          0 :     if (0 &lt; nbytes) {</span>
<span class="lineNum">    1135 </span>            :         /* don't copy 0 bytes - we just need to pass
<span class="lineNum">    1136 </span>            :          * the zero bytes so the fd can be closed
<span class="lineNum">    1137 </span>            :          * after it writes everything out
<span class="lineNum">    1138 </span>            :          */
<span class="lineNum">    1139 </span><span class="lineNoCov">          0 :         memcpy(output-&gt;data, data, nbytes);</span>
<span class="lineNum">    1140 </span>            :     }
<span class="lineNum">    1141 </span><span class="lineNoCov">          0 :     output-&gt;numbytes = nbytes;</span>
<span class="lineNum">    1142 </span>            : 
<span class="lineNum">    1143 </span>            :     /* add this data to the write list for this fd */
<span class="lineNum">    1144 </span><span class="lineNoCov">          0 :     opal_list_append(&amp;incoming-&gt;outputs, &amp;output-&gt;super);</span>
<span class="lineNum">    1145 </span>            : 
<span class="lineNum">    1146 </span><span class="lineNoCov">          0 :     if (!incoming-&gt;pending) {</span>
<span class="lineNum">    1147 </span>            :         /* add the event */
<span class="lineNum">    1148 </span><span class="lineNoCov">          0 :         opal_event_add(&amp;incoming-&gt;ev, 0);</span>
<span class="lineNum">    1149 </span><span class="lineNoCov">          0 :         incoming-&gt;pending = true;</span>
<span class="lineNum">    1150 </span>            :     }
<span class="lineNum">    1151 </span>            : 
<span class="lineNum">    1152 </span>            :     /* cleanup */
<span class="lineNum">    1153 </span><span class="lineNoCov">          0 :     free(file);</span>
<span class="lineNum">    1154 </span>            : }
<a name="1155"><span class="lineNum">    1155 </span>            : </a>
<span class="lineNum">    1156 </span>            : 
<span class="lineNum">    1157 </span><span class="lineNoCov">          0 : static void write_handler(int fd, short event, void *cbdata)</span>
<span class="lineNum">    1158 </span>            : {
<span class="lineNum">    1159 </span><span class="lineNoCov">          0 :     orte_filem_raw_incoming_t *sink = (orte_filem_raw_incoming_t*)cbdata;</span>
<span class="lineNum">    1160 </span>            :     opal_list_item_t *item;
<span class="lineNum">    1161 </span>            :     orte_filem_raw_output_t *output;
<span class="lineNum">    1162 </span>            :     int num_written;
<span class="lineNum">    1163 </span>            :     char *dirname, *cmd;
<span class="lineNum">    1164 </span>            :     char homedir[MAXPATHLEN];
<span class="lineNum">    1165 </span>            :     int rc;
<span class="lineNum">    1166 </span>            : 
<span class="lineNum">    1167 </span><span class="lineNoCov">          0 :     OPAL_OUTPUT_VERBOSE((1, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">    1168 </span>            :                          &quot;%s write:handler writing data to %d&quot;,
<span class="lineNum">    1169 </span>            :                          ORTE_NAME_PRINT(ORTE_PROC_MY_NAME),
<span class="lineNum">    1170 </span>            :                          sink-&gt;fd));
<span class="lineNum">    1171 </span>            : 
<span class="lineNum">    1172 </span>            :     /* note that the event is off */
<span class="lineNum">    1173 </span><span class="lineNoCov">          0 :     sink-&gt;pending = false;</span>
<span class="lineNum">    1174 </span>            : 
<span class="lineNum">    1175 </span><span class="lineNoCov">          0 :     while (NULL != (item = opal_list_remove_first(&amp;sink-&gt;outputs))) {</span>
<span class="lineNum">    1176 </span><span class="lineNoCov">          0 :         output = (orte_filem_raw_output_t*)item;</span>
<span class="lineNum">    1177 </span><span class="lineNoCov">          0 :         if (0 == output-&gt;numbytes) {</span>
<span class="lineNum">    1178 </span>            :             /* indicates we are to close this stream */
<span class="lineNum">    1179 </span><span class="lineNoCov">          0 :             OPAL_OUTPUT_VERBOSE((1, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">    1180 </span>            :                                  &quot;%s write:handler zero bytes - reporting complete for file %s&quot;,
<span class="lineNum">    1181 </span>            :                                  ORTE_NAME_PRINT(ORTE_PROC_MY_NAME),
<span class="lineNum">    1182 </span>            :                                  sink-&gt;file));
<span class="lineNum">    1183 </span>            :             /* close the file descriptor */
<span class="lineNum">    1184 </span><span class="lineNoCov">          0 :             close(sink-&gt;fd);</span>
<span class="lineNum">    1185 </span><span class="lineNoCov">          0 :             sink-&gt;fd = -1;</span>
<span class="lineNum">    1186 </span><span class="lineNoCov">          0 :             if (ORTE_FILEM_TYPE_FILE == sink-&gt;type ||</span>
<span class="lineNum">    1187 </span><span class="lineNoCov">          0 :                 ORTE_FILEM_TYPE_EXE == sink-&gt;type) {</span>
<span class="lineNum">    1188 </span>            :                 /* just link to the top as this will be the
<span class="lineNum">    1189 </span>            :                  * name we will want in each proc's session dir
<span class="lineNum">    1190 </span>            :                  */
<span class="lineNum">    1191 </span><span class="lineNoCov">          0 :                 opal_argv_append_nosize(&amp;sink-&gt;link_pts, sink-&gt;top);</span>
<span class="lineNum">    1192 </span><span class="lineNoCov">          0 :                 send_complete(sink-&gt;file, ORTE_SUCCESS);</span>
<span class="lineNum">    1193 </span>            :             } else {
<span class="lineNum">    1194 </span>            :                 /* unarchive the file */
<span class="lineNum">    1195 </span><span class="lineNoCov">          0 :                 if (ORTE_FILEM_TYPE_TAR == sink-&gt;type) {</span>
<span class="lineNum">    1196 </span><span class="lineNoCov">          0 :                     asprintf(&amp;cmd, &quot;tar xf %s&quot;, sink-&gt;file);</span>
<span class="lineNum">    1197 </span><span class="lineNoCov">          0 :                 } else if (ORTE_FILEM_TYPE_BZIP == sink-&gt;type) {</span>
<span class="lineNum">    1198 </span><span class="lineNoCov">          0 :                     asprintf(&amp;cmd, &quot;tar xjf %s&quot;, sink-&gt;file);</span>
<span class="lineNum">    1199 </span><span class="lineNoCov">          0 :                 } else if (ORTE_FILEM_TYPE_GZIP == sink-&gt;type) {</span>
<span class="lineNum">    1200 </span><span class="lineNoCov">          0 :                     asprintf(&amp;cmd, &quot;tar xzf %s&quot;, sink-&gt;file);</span>
<span class="lineNum">    1201 </span>            :                 } else {
<span class="lineNum">    1202 </span><span class="lineNoCov">          0 :                     ORTE_ERROR_LOG(ORTE_ERR_BAD_PARAM);</span>
<span class="lineNum">    1203 </span><span class="lineNoCov">          0 :                     send_complete(sink-&gt;file, ORTE_ERR_FILE_WRITE_FAILURE);</span>
<span class="lineNum">    1204 </span><span class="lineNoCov">          0 :                     return;</span>
<span class="lineNum">    1205 </span>            :                 }
<span class="lineNum">    1206 </span><span class="lineNoCov">          0 :                 getcwd(homedir, sizeof(homedir));</span>
<span class="lineNum">    1207 </span><span class="lineNoCov">          0 :                 dirname = opal_dirname(sink-&gt;fullpath);</span>
<span class="lineNum">    1208 </span><span class="lineNoCov">          0 :                 chdir(dirname);</span>
<span class="lineNum">    1209 </span><span class="lineNoCov">          0 :                 OPAL_OUTPUT_VERBOSE((1, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">    1210 </span>            :                                      &quot;%s write:handler unarchiving file %s with cmd: %s&quot;,
<span class="lineNum">    1211 </span>            :                                      ORTE_NAME_PRINT(ORTE_PROC_MY_NAME),
<span class="lineNum">    1212 </span>            :                                      sink-&gt;file, cmd));
<span class="lineNum">    1213 </span><span class="lineNoCov">          0 :                 system(cmd);</span>
<span class="lineNum">    1214 </span><span class="lineNoCov">          0 :                 chdir(homedir);</span>
<span class="lineNum">    1215 </span><span class="lineNoCov">          0 :                 free(dirname);</span>
<span class="lineNum">    1216 </span><span class="lineNoCov">          0 :                 free(cmd);</span>
<span class="lineNum">    1217 </span>            :                 /* setup the link points */
<span class="lineNum">    1218 </span><span class="lineNoCov">          0 :                 if (ORTE_SUCCESS != (rc = link_archive(sink))) {</span>
<span class="lineNum">    1219 </span><span class="lineNoCov">          0 :                     ORTE_ERROR_LOG(rc);</span>
<span class="lineNum">    1220 </span><span class="lineNoCov">          0 :                     send_complete(sink-&gt;file, ORTE_ERR_FILE_WRITE_FAILURE);</span>
<span class="lineNum">    1221 </span>            :                 } else {
<span class="lineNum">    1222 </span><span class="lineNoCov">          0 :                     send_complete(sink-&gt;file, ORTE_SUCCESS);</span>
<span class="lineNum">    1223 </span>            :                 }
<span class="lineNum">    1224 </span>            :             }
<span class="lineNum">    1225 </span><span class="lineNoCov">          0 :             return;</span>
<span class="lineNum">    1226 </span>            :         }
<span class="lineNum">    1227 </span><span class="lineNoCov">          0 :         num_written = write(sink-&gt;fd, output-&gt;data, output-&gt;numbytes);</span>
<span class="lineNum">    1228 </span><span class="lineNoCov">          0 :         OPAL_OUTPUT_VERBOSE((1, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">    1229 </span>            :                              &quot;%s write:handler wrote %d bytes to file %s&quot;,
<span class="lineNum">    1230 </span>            :                              ORTE_NAME_PRINT(ORTE_PROC_MY_NAME),
<span class="lineNum">    1231 </span>            :                              num_written, sink-&gt;file));
<span class="lineNum">    1232 </span><span class="lineNoCov">          0 :         if (num_written &lt; 0) {</span>
<span class="lineNum">    1233 </span><span class="lineNoCov">          0 :             if (EAGAIN == errno || EINTR == errno) {</span>
<span class="lineNum">    1234 </span>            :                 /* push this item back on the front of the list */
<span class="lineNum">    1235 </span><span class="lineNoCov">          0 :                 opal_list_prepend(&amp;sink-&gt;outputs, item);</span>
<span class="lineNum">    1236 </span>            :                 /* leave the write event running so it will call us again
<span class="lineNum">    1237 </span>            :                  * when the fd is ready.
<span class="lineNum">    1238 </span>            :                  */
<span class="lineNum">    1239 </span><span class="lineNoCov">          0 :                 opal_event_add(&amp;sink-&gt;ev, 0);</span>
<span class="lineNum">    1240 </span><span class="lineNoCov">          0 :                 sink-&gt;pending = true;</span>
<span class="lineNum">    1241 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    1242 </span>            :             }
<span class="lineNum">    1243 </span>            :             /* otherwise, something bad happened so all we can do is abort
<span class="lineNum">    1244 </span>            :              * this attempt
<span class="lineNum">    1245 </span>            :              */
<span class="lineNum">    1246 </span><span class="lineNoCov">          0 :             OPAL_OUTPUT_VERBOSE((1, orte_filem_base_framework.framework_output,</span>
<span class="lineNum">    1247 </span>            :                                  &quot;%s write:handler error on write for file %s: %s&quot;,
<span class="lineNum">    1248 </span>            :                                  ORTE_NAME_PRINT(ORTE_PROC_MY_NAME),
<span class="lineNum">    1249 </span>            :                                  sink-&gt;file, strerror(errno)));
<span class="lineNum">    1250 </span><span class="lineNoCov">          0 :             OBJ_RELEASE(output);</span>
<span class="lineNum">    1251 </span><span class="lineNoCov">          0 :             opal_list_remove_item(&amp;incoming_files, &amp;sink-&gt;super);</span>
<span class="lineNum">    1252 </span><span class="lineNoCov">          0 :             send_complete(sink-&gt;file, OPAL_ERR_FILE_WRITE_FAILURE);</span>
<span class="lineNum">    1253 </span><span class="lineNoCov">          0 :             OBJ_RELEASE(sink);</span>
<span class="lineNum">    1254 </span><span class="lineNoCov">          0 :             return;</span>
<span class="lineNum">    1255 </span><span class="lineNoCov">          0 :         } else if (num_written &lt; output-&gt;numbytes) {</span>
<span class="lineNum">    1256 </span>            :             /* incomplete write - adjust data to avoid duplicate output */
<span class="lineNum">    1257 </span><span class="lineNoCov">          0 :             memmove(output-&gt;data, &amp;output-&gt;data[num_written], output-&gt;numbytes - num_written);</span>
<span class="lineNum">    1258 </span>            :             /* push this item back on the front of the list */
<span class="lineNum">    1259 </span><span class="lineNoCov">          0 :             opal_list_prepend(&amp;sink-&gt;outputs, item);</span>
<span class="lineNum">    1260 </span>            :             /* leave the write event running so it will call us again
<span class="lineNum">    1261 </span>            :              * when the fd is ready
<span class="lineNum">    1262 </span>            :              */
<span class="lineNum">    1263 </span><span class="lineNoCov">          0 :             opal_event_add(&amp;sink-&gt;ev, 0);</span>
<span class="lineNum">    1264 </span><span class="lineNoCov">          0 :             sink-&gt;pending = true;</span>
<span class="lineNum">    1265 </span><span class="lineNoCov">          0 :             return;</span>
<span class="lineNum">    1266 </span>            :         }
<span class="lineNum">    1267 </span><span class="lineNoCov">          0 :         OBJ_RELEASE(output);</span>
<span class="lineNum">    1268 </span>            :     }
<a name="1269"><span class="lineNum">    1269 </span>            : }</a>
<span class="lineNum">    1270 </span>            : 
<span class="lineNum">    1271 </span><span class="lineNoCov">          0 : static void xfer_construct(orte_filem_raw_xfer_t *ptr)</span>
<span class="lineNum">    1272 </span>            : {
<span class="lineNum">    1273 </span><span class="lineNoCov">          0 :     ptr-&gt;outbound = NULL;</span>
<span class="lineNum">    1274 </span><span class="lineNoCov">          0 :     ptr-&gt;app_idx = 0;</span>
<span class="lineNum">    1275 </span><span class="lineNoCov">          0 :     ptr-&gt;pending = false;</span>
<span class="lineNum">    1276 </span><span class="lineNoCov">          0 :     ptr-&gt;src = NULL;</span>
<span class="lineNum">    1277 </span><span class="lineNoCov">          0 :     ptr-&gt;file = NULL;</span>
<span class="lineNum">    1278 </span><span class="lineNoCov">          0 :     ptr-&gt;nchunk = 0;</span>
<span class="lineNum">    1279 </span><span class="lineNoCov">          0 :     ptr-&gt;status = ORTE_SUCCESS;</span>
<a name="1280"><span class="lineNum">    1280 </span><span class="lineNoCov">          0 :     ptr-&gt;nrecvd = 0;</span></a>
<span class="lineNum">    1281 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1282 </span><span class="lineNoCov">          0 : static void xfer_destruct(orte_filem_raw_xfer_t *ptr)</span>
<span class="lineNum">    1283 </span>            : {
<span class="lineNum">    1284 </span><span class="lineNoCov">          0 :     if (ptr-&gt;pending) {</span>
<span class="lineNum">    1285 </span><span class="lineNoCov">          0 :         opal_event_del(&amp;ptr-&gt;ev);</span>
<span class="lineNum">    1286 </span>            :     }
<span class="lineNum">    1287 </span><span class="lineNoCov">          0 :     if (NULL != ptr-&gt;src) {</span>
<span class="lineNum">    1288 </span><span class="lineNoCov">          0 :         free(ptr-&gt;src);</span>
<span class="lineNum">    1289 </span>            :     }
<span class="lineNum">    1290 </span><span class="lineNoCov">          0 :     if (NULL != ptr-&gt;file) {</span>
<span class="lineNum">    1291 </span><span class="lineNoCov">          0 :         free(ptr-&gt;file);</span>
<span class="lineNum">    1292 </span>            :     }
<span class="lineNum">    1293 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1294 </span>            : OBJ_CLASS_INSTANCE(orte_filem_raw_xfer_t,
<span class="lineNum">    1295 </span>            :                    opal_list_item_t,
<a name="1296"><span class="lineNum">    1296 </span>            :                    xfer_construct, xfer_destruct);</a>
<span class="lineNum">    1297 </span>            : 
<span class="lineNum">    1298 </span><span class="lineNoCov">          0 : static void out_construct(orte_filem_raw_outbound_t *ptr)</span>
<span class="lineNum">    1299 </span>            : {
<span class="lineNum">    1300 </span><span class="lineNoCov">          0 :     OBJ_CONSTRUCT(&amp;ptr-&gt;xfers, opal_list_t);</span>
<span class="lineNum">    1301 </span><span class="lineNoCov">          0 :     ptr-&gt;status = ORTE_SUCCESS;</span>
<span class="lineNum">    1302 </span><span class="lineNoCov">          0 :     ptr-&gt;cbfunc = NULL;</span>
<a name="1303"><span class="lineNum">    1303 </span><span class="lineNoCov">          0 :     ptr-&gt;cbdata = NULL;</span></a>
<span class="lineNum">    1304 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1305 </span><span class="lineNoCov">          0 : static void out_destruct(orte_filem_raw_outbound_t *ptr)</span>
<span class="lineNum">    1306 </span>            : {
<span class="lineNum">    1307 </span>            :     opal_list_item_t *item;
<span class="lineNum">    1308 </span>            : 
<span class="lineNum">    1309 </span><span class="lineNoCov">          0 :     while (NULL != (item = opal_list_remove_first(&amp;ptr-&gt;xfers))) {</span>
<span class="lineNum">    1310 </span><span class="lineNoCov">          0 :         OBJ_RELEASE(item);</span>
<span class="lineNum">    1311 </span>            :     }
<span class="lineNum">    1312 </span><span class="lineNoCov">          0 :     OBJ_DESTRUCT(&amp;ptr-&gt;xfers);</span>
<span class="lineNum">    1313 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1314 </span>            : OBJ_CLASS_INSTANCE(orte_filem_raw_outbound_t,
<span class="lineNum">    1315 </span>            :                    opal_list_item_t,
<a name="1316"><span class="lineNum">    1316 </span>            :                    out_construct, out_destruct);</a>
<span class="lineNum">    1317 </span>            : 
<span class="lineNum">    1318 </span><span class="lineNoCov">          0 : static void in_construct(orte_filem_raw_incoming_t *ptr)</span>
<span class="lineNum">    1319 </span>            : {
<span class="lineNum">    1320 </span><span class="lineNoCov">          0 :     ptr-&gt;app_idx = 0;</span>
<span class="lineNum">    1321 </span><span class="lineNoCov">          0 :     ptr-&gt;pending = false;</span>
<span class="lineNum">    1322 </span><span class="lineNoCov">          0 :     ptr-&gt;fd = -1;</span>
<span class="lineNum">    1323 </span><span class="lineNoCov">          0 :     ptr-&gt;file = NULL;</span>
<span class="lineNum">    1324 </span><span class="lineNoCov">          0 :     ptr-&gt;top = NULL;</span>
<span class="lineNum">    1325 </span><span class="lineNoCov">          0 :     ptr-&gt;fullpath = NULL;</span>
<span class="lineNum">    1326 </span><span class="lineNoCov">          0 :     ptr-&gt;link_pts = NULL;</span>
<a name="1327"><span class="lineNum">    1327 </span><span class="lineNoCov">          0 :     OBJ_CONSTRUCT(&amp;ptr-&gt;outputs, opal_list_t);</span></a>
<span class="lineNum">    1328 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1329 </span><span class="lineNoCov">          0 : static void in_destruct(orte_filem_raw_incoming_t *ptr)</span>
<span class="lineNum">    1330 </span>            : {
<span class="lineNum">    1331 </span>            :     opal_list_item_t *item;
<span class="lineNum">    1332 </span>            : 
<span class="lineNum">    1333 </span><span class="lineNoCov">          0 :     if (ptr-&gt;pending) {</span>
<span class="lineNum">    1334 </span><span class="lineNoCov">          0 :         opal_event_del(&amp;ptr-&gt;ev);</span>
<span class="lineNum">    1335 </span>            :     }
<span class="lineNum">    1336 </span><span class="lineNoCov">          0 :     if (0 &lt;= ptr-&gt;fd) {</span>
<span class="lineNum">    1337 </span><span class="lineNoCov">          0 :         close(ptr-&gt;fd);</span>
<span class="lineNum">    1338 </span>            :     }
<span class="lineNum">    1339 </span><span class="lineNoCov">          0 :     if (NULL != ptr-&gt;file) {</span>
<span class="lineNum">    1340 </span><span class="lineNoCov">          0 :         free(ptr-&gt;file);</span>
<span class="lineNum">    1341 </span>            :     }
<span class="lineNum">    1342 </span><span class="lineNoCov">          0 :     if (NULL != ptr-&gt;top) {</span>
<span class="lineNum">    1343 </span><span class="lineNoCov">          0 :         free(ptr-&gt;top);</span>
<span class="lineNum">    1344 </span>            :     }
<span class="lineNum">    1345 </span><span class="lineNoCov">          0 :     if (NULL != ptr-&gt;fullpath) {</span>
<span class="lineNum">    1346 </span><span class="lineNoCov">          0 :         free(ptr-&gt;fullpath);</span>
<span class="lineNum">    1347 </span>            :     }
<span class="lineNum">    1348 </span><span class="lineNoCov">          0 :     opal_argv_free(ptr-&gt;link_pts);</span>
<span class="lineNum">    1349 </span><span class="lineNoCov">          0 :     while (NULL != (item = opal_list_remove_first(&amp;ptr-&gt;outputs))) {</span>
<span class="lineNum">    1350 </span><span class="lineNoCov">          0 :         OBJ_RELEASE(item);</span>
<span class="lineNum">    1351 </span>            :     }
<span class="lineNum">    1352 </span><span class="lineNoCov">          0 :     OBJ_DESTRUCT(&amp;ptr-&gt;outputs);</span>
<span class="lineNum">    1353 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1354 </span>            : OBJ_CLASS_INSTANCE(orte_filem_raw_incoming_t,
<span class="lineNum">    1355 </span>            :                    opal_list_item_t,
<a name="1356"><span class="lineNum">    1356 </span>            :                    in_construct, in_destruct);</a>
<span class="lineNum">    1357 </span>            : 
<span class="lineNum">    1358 </span><span class="lineNoCov">          0 : static void output_construct(orte_filem_raw_output_t *ptr)</span>
<span class="lineNum">    1359 </span>            : {
<span class="lineNum">    1360 </span><span class="lineNoCov">          0 :     ptr-&gt;numbytes = 0;</span>
<span class="lineNum">    1361 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1362 </span>            : OBJ_CLASS_INSTANCE(orte_filem_raw_output_t,
<span class="lineNum">    1363 </span>            :                    opal_list_item_t,
<span class="lineNum">    1364 </span>            :                    output_construct, NULL);
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
